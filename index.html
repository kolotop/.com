<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>KOLO — барахолка оголошень</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="theme-color" content="#10b981"/>

  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5fbf7; --paper:#fff; --ink:#0f172a; --muted:#64748b;
      --brand:#10b981; --brand-press:#0d9a72; --line:#d7e9df;
      --hot:#ff4d4f; --thumb:#e8f5ef;
      --shadow-sm:0 4px 12px rgba(2,44,34,.08); --shadow-lg:0 14px 40px rgba(2,44,34,.14);
      --top:60px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font-family:"Montserrat",system-ui,Segoe UI,Roboto,Arial,sans-serif}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:50;height:var(--top);display:flex;gap:10px;align-items:center;padding:10px 12px;background:#ffffffcc;border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(6px)}
    .pill{display:inline-flex;align-items:center;gap:8px;height:38px;padding:0 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:800;cursor:pointer}
    .counter{display:inline-flex;align-items:center;gap:8px;height:38px;padding:0 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:900;color:#0b3b2d}
    .grow{flex:1}
    /* "+" квадрат с закруглёнными углами */
    .btnPlus{width:38px;height:38px;border-radius:10px;border:1px solid var(--line);background:var(--brand);display:grid;place-items:center;color:#fff;font:900 24px/1 "Russo One";text-decoration:none;box-shadow:var(--shadow-sm)}
    .btnPlus:active{transform:translateY(1px);background:var(--brand-press)}

    .container{max-width:1140px;margin:12px auto;padding:0 12px}

    /* Банер (один, адаптивный). Смена картинок каждые 5с */
    .adWrap{margin:6px 0 12px}
    .adBox{border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden}
    .adImg{width:100%;height:140px;object-fit:contain;background:#fff} /* показываем всю картинку */
    .adActions{display:flex;justify-content:flex-end;padding:6px}
    .adBtn{display:inline-block;padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-weight:800;cursor:pointer}

    /* HOT */
    .panel{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow-sm)}
    .hotHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .hotTag{background:var(--hot);color:#fff;border-radius:12px;padding:6px 10px;font:900 12px/1 "Russo One";box-shadow:0 0 0 1px #ff6b6d inset}
    .hotGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media (max-width:1024px){.hotGrid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:640px){.hotGrid{grid-template-columns:repeat(2,1fr)}}
    .hotCard{border:1px solid var(--line);border-radius:12px;overflow:hidden;cursor:pointer;background:#fff}
    .hotThumb{position:relative;padding-top:56%;background:var(--thumb)}
    .hotBadge{position:absolute;left:8px;top:8px;background:var(--hot);color:#fff;border-radius:999px;padding:4px 8px;font:900 11px/1 "Russo One";border:1px solid #ff6b6d}
    .hotPrice{position:absolute;right:8px;bottom:8px;background:var(--brand);color:#fff;border-radius:10px;padding:4px 8px;font:900 12px/1 "Russo One"}

    /* GRID: на телефоне — два столбца */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff;cursor:pointer;box-shadow:var(--shadow-sm)}
    .thumb{position:relative;padding-top:62%;background:var(--thumb)}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .pillHot{position:absolute;left:8px;top:8px;background:var(--hot);color:#fff;border:1px solid #ff6b6d;border-radius:999px;padding:4px 8px;font:900 11px/1 "Russo One"}
    .price{position:absolute;right:8px;bottom:8px;background:var(--brand);color:#fff;border-radius:10px;padding:4px 8px;font:900 12px/1 "Russo One"}
    .body{padding:10px}
    .title{font:900 16px/1.2 "Russo One"}
    .meta{color:var(--muted);font-weight:700}

    /* DETAIL */
    .detail{position:fixed;inset:0;display:none;background:rgba(0,0,0,.38);z-index:70}
    .detail.on{display:block}
    .sheet{position:absolute;left:50%;top:6vh;transform:translateX(-50%);width:min(1080px,96vw);max-height:88vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow-lg)}
    .dHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .btn{height:36px;border:none;border-radius:12px;background:var(--brand);color:#fff;font:900 14px/36px "Russo One";padding:0 12px;cursor:pointer}
    .btn:active{transform:translateY(1px);background:var(--brand-press)}
    .big{position:relative;padding-top:56%;background:var(--thumb);border-radius:12px;overflow:hidden}
    .big img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .nav{position:absolute;top:50%;transform:translateY(-50%);width:44px;height:44px;border-radius:12px;border:1px solid var(--line);background:#ffffffdd;font:900 26px/42px "Russo One";display:grid;place-items:center;cursor:pointer}
    .prev{left:8px}.next{right:8px}
    /* оверлеи на фото: лайк слева вверху, просмотры справа вверху, цена справа внизу */
    .ovLike{position:absolute;left:8px;top:8px;border-radius:999px;background:var(--brand);color:#fff;padding:4px 8px;font:900 12px/1 "Russo One"}
    .ovViews{position:absolute;right:8px;top:8px;border-radius:999px;background:var(--brand);color:#fff;padding:4px 8px;font:900 12px/1 "Russo One"}
    .ovPrice{position:absolute;right:8px;bottom:8px;border-radius:10px;background:var(--brand);color:#fff;padding:4px 8px;font:900 12px/1 "Russo One"}

    .pager{display:flex;justify-content:center;margin:14px 0}
  </style>
</head>
<body>
  <header class="topbar">
    <button id="btnSearch" class="pill">Пошук</button>
    <div id="visitors" class="counter"><span id="vis">0</span>&nbsp;користувачів</div>
    <div class="grow"></div>
    <!-- Іконка "+" ведёт в бот -->
    <a class="btnPlus" id="btnPlus" href="https://t.me/kolotop_bot" target="_blank" rel="noopener">+</a>
  </header>

  <main class="container">
    <!-- Банер (клик по баннеру ничего не открывает; кнопка рядом ведёт в бота) -->
    <section class="adWrap">
      <div class="adBox">
        <img id="adImg" class="adImg" alt="реклама">
        <div class="adActions">
          <a class="adBtn" href="https://t.me/kolotop_bot" target="_blank" rel="noopener">Замовити рекламу</a>
        </div>
      </div>
    </section>

    <!-- HOT -->
    <section id="hot" class="panel" style="display:none">
      <div class="hotHead"><div class="hotTag">HOT</div></div>
      <div id="hotGrid" class="hotGrid"></div>
    </section>

    <!-- Список -->
    <section class="grid" id="grid"></section>
    <div class="pager"><button id="btnMore" class="btn" style="display:none">Показати ще</button></div>
  </main>

  <!-- Деталь -->
  <div id="detail" class="detail" aria-hidden="true">
    <div class="sheet">
      <div class="dHead">
        <div id="dTitle" class="title" style="font:900 20px/1.2 'Russo One'">...</div>
        <div class="grow"></div>
        <button id="dShare" class="btn" title="Поділитися">⬆</button>
        <button id="dClose" class="btn" style="background:#e2e8f0;color:#0f172a">Закрити</button>
      </div>
      <div class="big" id="dBig"></div>
      <div id="dSpecs" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px"></div>
      <div style="height:1px;background:var(--line);margin:10px 0"></div>
      <div id="dDesc" style="opacity:.9"></div>
      <div style="height:1px;background:var(--line);margin:10px 0"></div>
      <div id="dSeller"></div>
    </div>
  </div>

<script>
/*** === НАСТРОЙКА API: ВСТАВЬ СВОЙ URL ТУТ === ***/
const API_BASE = 'https://emma-bloomberg-completed-lamps.trycloudflare.com'; // например: 'http://127.0.0.1:8000'
/*** ============================================ ***/

const $=s=>document.querySelector(s);
const grid=$("#grid"), hotGrid=$("#hotGrid"), btnMore=$("#btnMore");
const adImg=$("#adImg");

const IMG_FALLBACK = (t)=> {
  const c=document.createElement('canvas'); c.width=800;c.height=500;
  const g=c.getContext('2d'); g.fillStyle="#e9f7f1"; g.fillRect(0,0,800,500);
  g.fillStyle="#0f172a"; g.font="bold 28px Montserrat"; g.fillText(t.slice(0,28),20,60);
  return c.toDataURL();
};

let ADS = []; let adIdx=0;
async function loadConfig(){
  try{
    const r = await fetch(API_BASE+"/config"); const j = await r.json();
    ADS = j.ads||[];
    if(ADS.length){ adImg.src = ADS[0]; setInterval(()=>{adIdx=(adIdx+1)%ADS.length; adImg.src=ADS[adIdx];}, 5000); }
  }catch(e){}
}

async function trackVisit(){
  try{
    await fetch(API_BASE+"/track", {method:"POST"});
  }catch(e){}
}
async function visitors(){
  try{
    const r = await fetch(API_BASE+"/visitors"); const j=await r.json();
    $("#vis").textContent = (j.count||0).toLocaleString('uk-UA');
  }catch(e){}
}
setInterval(visitors, 2000);

let page=0, pageSize=24, cache=[];
function left(){ return Math.max(0, cache.length - page*pageSize); }
function showMore(){
  const slice = cache.slice(page*pageSize,(page+1)*pageSize);
  slice.forEach(renderCard); page++;
  btnMore.style.display = left()>0 ? "inline-flex" : "none";
}

async function loadListings(){
  const r = await fetch(`${API_BASE}/listings?search=&page=0&size=10000`);
  const j = await r.json();
  cache = j.items||[];
  cache.sort((a,b)=>b.created-a.created);
  page=0; grid.innerHTML=""; showMore();
  renderHot(cache.filter(x=>x.hot).slice(0,10));
}
function renderHot(items){
  const has = items && items.length;
  $("#hot").style.display = has ? "block":"none";
  hotGrid.innerHTML = "";
  if(!has) return;
  items.forEach(it=>{
    const el=document.createElement('div'); el.className="hotCard"; el.onclick=()=>openDetail(it);
    const th=document.createElement('div'); th.className="hotThumb";
    th.innerHTML = `<div class="hotBadge">HOT</div><div class="hotPrice">${it.price.toLocaleString('uk-UA')} ₴</div>`;
    const img=document.createElement('img'); img.alt=it.title; img.referrerPolicy="no-referrer";
    img.onerror=()=>{img.src=IMG_FALLBACK(it.title)};
    img.src=(it.images&&it.images[0])||IMG_FALLBACK(it.title);
    img.style.cssText="position:absolute;inset:0;width:100%;height:100%;object-fit:cover";
    th.appendChild(img);
    const body=document.createElement('div'); body.style.padding="8px"; body.innerHTML = `<div class="title">${it.title}</div><div class="meta">${it.city} • ${it.cat}</div>`;
    el.appendChild(th); el.appendChild(body); hotGrid.appendChild(el);
  });
}

function renderCard(it){
  const el=document.createElement('article'); el.className="card"; el.onclick=()=>openDetail(it);
  const th=document.createElement('div'); th.className="thumb";
  if(it.hot){ const h=document.createElement('div'); h.className="pillHot"; h.textContent="HOT"; th.appendChild(h); }
  const pr=document.createElement('div'); pr.className="price"; pr.textContent = `${(it.price||0).toLocaleString('uk-UA')} ₴`;
  th.appendChild(pr);
  const img=document.createElement('img'); img.alt=it.title; img.referrerPolicy="no-referrer";
  img.onerror=()=>{img.src=IMG_FALLBACK(it.title)}; img.src=(it.images&&it.images[0])||IMG_FALLBACK(it.title);
  th.appendChild(img);
  const body=document.createElement('div'); body.className="body";
  body.innerHTML = `<div class="title">${it.title}</div>
                    <div class="meta">${it.cat} • ${it.cond}</div>
                    <div class="meta">${it.region} • ${it.city}</div>`;
  el.appendChild(th); el.appendChild(body); grid.appendChild(el);
}

function openDetail(it){
  const d=$("#detail"); d.classList.add("on"); d.setAttribute("aria-hidden","false");
  $("#dClose").onclick=()=>{ d.classList.remove("on"); d.setAttribute("aria-hidden","true"); };
  $("#dTitle").textContent = it.title;

  const big=$("#dBig"); big.innerHTML="";
  const img=document.createElement('img'); img.src=(it.images&&it.images[0])||IMG_FALLBACK(it.title); img.alt="photo"; img.referrerPolicy="no-referrer";
  img.onerror=()=>{img.src=IMG_FALLBACK(it.title)};
  big.appendChild(img);
  // overlays
  const like=document.createElement('div'); like.className='ovLike'; like.textContent=`❤ ${(it.likes||0)}`;
  const views=document.createElement('div'); views.className='ovViews'; views.textContent=`👁 ${(it.views||0)}`;
  const price=document.createElement('div'); price.className='ovPrice'; price.textContent=`${(it.price||0).toLocaleString('uk-UA')} ₴`;
  big.appendChild(like); big.appendChild(views); big.appendChild(price);

  $("#dSpecs").innerHTML = `
    <div class="pill" style="height:auto">${it.cat}</div>
    <div class="pill" style="height:auto">${it.cond}</div>
    <div class="pill" style="height:auto">${it.region}</div>
    <div class="pill" style="height:auto">${it.city}</div>
    <div class="pill" style="height:auto">${new Date(it.created).toLocaleDateString('uk-UA')}</div>
  `;
  $("#dDesc").textContent = it.desc||"";
  $("#dSeller").innerHTML = `<div style="font-weight:900">Продавець</div>
                             <div>${it.contact?.name||"—"}</div>
                             <div>${it.contact?.phone||"—"}</div>`;
  $("#dShare").onclick=()=> {
    const url = location.origin + location.pathname + '#' + it.id;
    if(navigator.share){ navigator.share({title: it.title, url}).catch(()=>{}); }
    else { navigator.clipboard?.writeText(url); alert("Посилання скопійовано"); }
  };
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadConfig();
  await trackVisit();
  await visitors();
  await loadListings();
  btnMore.onclick=showMore;
  $("#btnSearch").onclick=()=>alert("Пошук поки що простий: поле скоро повернеться 🙂");
});
</script>
</body>
</html>
