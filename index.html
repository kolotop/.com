<!-- index.html — OG теги с авто-URL, плавные оверлеи без фризов, карусель предзагружает фото -->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>KOLO — дошка оголошень</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#10b981">

<!-- Open Graph (подставляется BASE на сервере) -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="KOLO — дошка оголошень">
<meta property="og:title" content="KOLO — дошка оголошень">
<meta property="og:description" content="Дошка оголошень №1 в Україні. Швидко та зручно додай оголошення.">
<meta property="og:url" content="{{OG_URL}}">
<meta property="og:image" content="{{OG_IMAGE}}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="KOLO — дошка оголошень">
<meta name="twitter:description" content="Дошка оголошень №1 в Україні. Швидко та зручно додай оголошення.">
<meta name="twitter:image" content="{{OG_IMAGE}}">

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%2310b981'/%3E%3Ccircle cx='50' cy='50' r='40' fill='none' stroke='%23fff' stroke-width='6'/%3E%3Ctext x='50' y='58' text-anchor='middle' font-family='Russo One,Arial' font-size='22' fill='%23fff'%3EKOLO%3C/text%3E%3C/svg%3E">

<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">

<style>
:root{--g:#10b981;--r:#e94251;--txt:#0b1720}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:'Russo One',Arial,system-ui;background:#f5f7f6;color:var(--txt);-webkit-font-smoothing:antialiased;max-width:100%;overflow-x:hidden}
a{color:inherit;text-decoration:none}
.wrap{max-width:1140px;margin:0 auto;padding:10px 14px}
body.locked{overflow:hidden}

/* splash */
#splash{position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:60}
.loader{position:relative;width:220px;height:220px;border-radius:50%;border:12px solid #e6faf2;border-top-color:var(--g);animation:spin 1s linear infinite}
.loader span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#10b981;font-size:38px}
#splash .sub{margin-top:18px;color:#0b1720aa}
@keyframes spin{to{transform:rotate(360deg)}}

/* header */
header{position:sticky;top:0;z-index:40;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.topbar{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center}
.logo svg{width:44px;height:44px}
.pill{background:var(--g);color:#fff;border-radius:12px;padding:8px 14px;font-size:13px}
.btn{border:none;background:var(--g);color:#fff;border-radius:12px;padding:10px 16px;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,.25);font-family:inherit;transition:transform .12s ease, opacity .2s ease}
.btn:active{transform:scale(.98)}
.btn.plus{background:#fff;color:var(--g);border:3px solid var(--g);width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:none}
.btn.ghost{background:#fff;color:#10b981;border:3px solid #10b981}

/* banner */
.banner{margin:8px 0;position:relative;overflow:hidden;transition:max-height .35s ease, opacity .35s ease, margin .35s ease;max-height:180px;will-change:max-height,opacity,margin}
.banner img{width:100%;height:170px;object-fit:cover;border-radius:10px;display:block;box-shadow:0 8px 18px rgba(0,0,0,.08)}
@media(max-width:760px){ .banner{max-height:none} .banner img{height:auto;object-fit:cover;background:transparent} }
.banner.min{max-height:0;opacity:0;margin:0}
.ad-under{display:flex;justify-content:flex-end;margin-top:6px}
.ad-under a{font-size:12px;color:#2b7;background:#fff;border-radius:8px;padding:4px 8px;box-shadow:0 6px 12px rgba(0,0,0,.06)}

/* sections */
.hsec{display:flex;align-items:center;gap:8px;color:#fff;padding:8px 14px;border-radius:12px;margin:12px 0;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.hsec svg{width:18px;height:18px;fill:#fff}
.hsec.top{background:linear-gradient(90deg,#ff4d4d,#ff7a1a)}
.hsec.new{background:var(--g)}

/* cards */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
@media(min-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{background:#fff;border-radius:16px;padding:12px;position:relative;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06);transition:transform .12s ease, box-shadow .2s ease, opacity .2s ease}
.card:hover{transform:translateY(-2px);box-shadow:0 12px 22px rgba(0,0,0,.08)}
.card .ph{position:relative;border-radius:10px;min-height:150px;display:flex;align-items:center;justify-content:center;background:#eefaf5;color:#6cc8a8;overflow:hidden}
.card .ph img{width:100%;height:100%;object-fit:cover;display:block}
.badge-hot{position:absolute;right:12px;top:12px;background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff;border-radius:12px;padding:4px 10px;font-size:12px;z-index:3}
.card .ttl{margin-top:10px;line-height:1.1;font-size:14px}
.priceTag{position:absolute;right:10px;bottom:10px;background:var(--g);color:#fff;border:none;border-radius:16px;padding:6px 12px;box-shadow:0 8px 18px rgba(16,185,129,.25);font-family:inherit;z-index:3;pointer-events:none}

/* modal */
dialog{border:none;border-radius:16px;padding:0;width:96%;max-width:980px}
dialog::backdrop{background:rgba(0,0,0,.68)}
#modalBox{border-radius:16px;background:#fff;overflow:hidden;position:relative;box-shadow:0 18px 40px rgba(0,0,0,.28);transition:opacity .2s ease}
.modHead{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #edf3f0}
.modTitle{flex:1}
.closeX{border:none;background:#fff;color:#10b981;border:3px solid #10b981;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;line-height:1;cursor:pointer}

/* carousel */
.carousel{position:relative;border-bottom:1px solid #edf3f0;background:#000}
#carStage{position:relative;height:520px;max-height:52vh}
#carStage img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .25s ease;pointer-events:none}
#carStage img.show{opacity:1}
.navbtn{position:absolute;top:50%;transform:translateY(-50%);background:transparent;color:#fff;border:none;width:auto;height:auto;display:flex;align-items:center;justify-content:center;font-size:34px;font-weight:800;line-height:1;padding:6px 10px;user-select:none;z-index:5}
.navbtn.left{left:10px}.navbtn.right{right:10px}
#carCount{position:absolute;right:10px;bottom:10px;background:#000b;color:#fff;border-radius:10px;padding:4px 8px;font-size:12px;z-index:4}
.statOverlay{position:absolute;right:10px;top:10px;display:flex;gap:8px;z-index:6}
.statLeft{position:absolute;left:10px;top:10px;display:flex;gap:8px;z-index:6}
.pillStat{display:inline-flex;align-items:center;gap:8px;border-radius:18px;padding:6px 10px;box-shadow:0 6px 14px rgba(0,0,0,.25);font-family:'Russo One',Arial,system-ui;background:var(--g);color:#fff}
.pillStat svg{width:16px;height:16px;fill:#fff}
.pillStat b{font-family:'Russo One',Arial,system-ui;font-size:14px}

.modBody{padding:14px}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{background:#eefaf5;color:#0b1720;border-radius:12px;padding:10px 12px}

/* overlays */
#chooser,#addForm,#searchBox,#supportBox,#payBox{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;touch-action:none}
#chooser,#addForm,#searchBox,#payBox{z-index:50}
#supportBox{z-index:70}
.chooseBox{position:relative;width:90%;max-width:420px;background:#fff;border-radius:16px;padding:24px;display:flex;flex-direction:column;gap:14px;align-items:center;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.chooseBtn{width:100%;padding:16px;border:none;border-radius:12px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06);font-family:inherit}
.chooseBtn.green{background:var(--g);color:#fff}
.chooseBtn.red{background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff}
.formBox{width:92%;max-width:560px;max-height:90vh;overflow:auto;background:#fff;border-radius:16px;padding:0 16px 16px;position:relative;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.formTop{position:sticky;top:0;background:#fff;display:flex;justify-content:space-between;align-items:center;padding:12px 0 8px;margin-bottom:10px;z-index:1;border-bottom:1px solid #edf3f0}
.badgeSmall{background:var(--g);color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
.badgeSmall.gray{background:#eefaf5;color:#0b1720}
.imagePh{border-radius:12px;min-height:220px;display:flex;align-items:center;justify-content:center;margin:8px 0;overflow:hidden;background:#eefaf5}
.imagePh.bannerPh{min-height:200px}
.imagePh img{max-width:100%;max-height:100%;object-fit:contain;display:block}
.inp{background:var(--g);color:#fff;border:none;border-radius:12px;padding:12px 14px;width:100%;margin-top:10px;caret-color:#fff;font-family:inherit}
.inprow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
::placeholder{color:#fff;opacity:.9}
.btnPub{width:100%;margin-top:14px;border-radius:12px;font-family:inherit}

/* search */
#searchBox{align-items:flex-start}
.searchInner{background:#fff;border-radius:16px;padding:12px;width:92%;max-width:560px;display:flex;gap:8px;box-shadow:0 18px 40px rgba(0,0,0,.28);margin:14px auto}
.searchInner input{flex:1;border:2px solid #e3f4ef;border-radius:12px;padding:12px 14px;font-family:inherit}

/* support */
.supInner{background:#fff;border-radius:16px;padding:16px;width:92%;max-width:520px;box-shadow:0 18px 40px rgba(0,0,0,.28);position:relative}
.supInner .inp{background:#eefaf5;color:#0b1720}
.supInner .inp::placeholder{color:#6aa}
.supInner .closeX{position:absolute;right:12px;top:12px}

/* pay */
.payInner{background:#fff;border-radius:16px;padding:12px 16px 20px;width:92%;max-width:560px;box-shadow:0 18px 40px rgba(0,0,0,.28);position:relative}
.payHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.payRight{display:flex;gap:8px;align-items:center}
.copy{cursor:pointer;border:2px solid #e3f4ef;border-radius:8px;padding:6px 8px;font-size:13px;user-select:none}
.payRow{display:grid;grid-template-columns:140px 1fr;gap:10px;margin:8px 0;padding:10px;border:2px solid #e3f4ef;border-radius:12px;align-items:center}
.payBtn{width:100%;margin-top:12px}

/* footer */
footer{padding:18px 0;margin-top:20px;color:#0b1720a0;text-align:center}
.tagline{margin-top:6px}
</style>
</head>
<body>
<div id="splash" aria-hidden="true">
  <div class="loader" role="status" aria-live="polite"><span>KOLO</span></div>
  <div class="sub">Дошка оголошень №1 в Україні</div>
</div>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="logo" aria-label="KOLO">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="48" fill="#10b981"/>
          <circle cx="50" cy="50" r="40" fill="none" stroke="#fff" stroke-width="6"/>
          <text x="50" y="58" font-size="22" text-anchor="middle" fill="#fff" font-family="Russo One,Arial">KOLO</text>
        </svg>
      </div>
      <div><span id="visitors" class="pill">27369 відвідувачів</span></div>
      <button class="btn plus" id="btnPlus" aria-label="Додати">+</button>
      <button class="btn" id="btnSearch">ПОШУК</button>
    </div>

    <div id="banner" class="banner">
      <a id="bannerLink" href="#" target="_blank" rel="noopener">
        <img id="bannerImg" src="" alt="banner" loading="lazy" onerror="this.style.display='none'">
      </a>
    </div>
    <div class="ad-under"><a href="#" id="bannerOrder">Замовити рекламу</a></div>
  </div>
</header>

<main class="wrap">
  <div class="hsec top">
    <svg viewBox="0 0 24 24"><path d="M12 2c2 3 6 5.5 6 10.2A6 6 0 0 1 6 12.2C6 8 9 5 11 3.2c-.2 2.1.8 3.5 2.5 4.8C14 6.5 13 4.2 12 2Z"/></svg>
    <span>ТОП пропозицій</span>
  </div>
  <div id="hotGrid" class="grid"></div>

  <div class="hsec new">Нові оголошення</div>
  <div id="listGrid" class="grid"></div>
  <div style="display:flex;justify-content:center;margin:18px 0">
    <button id="btnMore" class="btn" style="background:#fff;color:#10b981;border:2px solid #10b981">Показати ще</button>
  </div>
</main>

<footer>
  <div>© KOLO, 2025</div>
  <div class="tagline">Дошка оголошень №1 в Україні</div>
</footer>

<!-- DETAIL -->
<dialog id="dlgDetail">
  <div id="modalBox">
    <div class="modHead">
      <div class="modTitle" id="modTitle">ОГОЛОШЕННЯ</div>
      <button class="closeX" id="closeDetail" title="Закрити">✕</button>
    </div>
    <div class="carousel">
      <div class="statLeft"><div class="pillStat" id="priceTop"></div></div>
      <div class="statOverlay">
        <div class="pillStat" title="Перегляди">
          <svg viewBox="0 0 24 24"><path d="M12 5C5 5 1 12 1 12s4 7 11 7 11-7 11-7-4-7-11-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg>
          <b id="vNum">0</b>
        </div>
        <button class="pillStat" id="likeTop" style="border:none;cursor:pointer" title="Лайк">
          <svg viewBox="0 0 24 24"><path d="M12 21s-7.5-4.35-10-8.5C.5 8.5 3 5 6.5 5 8.7 5 10 6.2 12 8c2-1.8 3.3-3 5.5-3 3.5 0 6 3.5 4.5 7.5C19.5 16.7 12 21 12 21Z"/></svg>
          <b id="lNum">0</b>
        </button>
      </div>
      <button class="navbtn left" id="navLeft" aria-label="Попереднє">‹</button>
      <div id="carStage"></div>
      <div id="carCount">1/1</div>
      <button class="navbtn right" id="navRight" aria-label="Наступне">›</button>
    </div>
    <div class="modBody">
      <div id="modDesc" style="margin-bottom:12px;white-space:pre-wrap"></div>
      <div class="chips" id="chips"></div>
    </div>
  </div>
</dialog>

<!-- CHOOSER -->
<div id="chooser"><div class="chooseBox" id="chooseBox">
  <button class="chooseBtn green" id="chooseNormal">Звичайне оголошення — 39 грн / 30 днів</button>
  <button class="chooseBtn red" id="chooseHot">HOT оголошення — 299 грн / 7 днів</button>
</div></div>

<!-- ADD FORM -->
<div id="addForm"><div class="formBox" id="addInner">
  <div class="formTop">
    <div class="badgeSmall" id="btnAddPhoto">Додати фото <span id="phCnt">0/5</span></div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="hotBadge" class="badgeSmall" style="background:#e94251;display:none">HOT</div>
      <button class="closeX" id="closeAdd" title="Закрити">✕</button>
    </div>
  </div>

  <div class="imagePh" id="imgPh"></div>
  <input type="file" id="f_imgs" accept="image/*" multiple hidden>

  <div id="adFields">
    <input class="inp" id="f_title" placeholder="Заголовок">
    <div class="inprow">
      <input class="inp" id="f_price" placeholder="Ціна, грн">
      <input class="inp" id="f_city" placeholder="Місто">
    </div>
    <div class="inprow">
      <input class="inp" id="f_region" placeholder="Область">
      <input class="inp" id="f_phone" placeholder="+380">
    </div>
    <textarea class="inp" id="f_desc" placeholder="Опис" rows="4" style="height:110px"></textarea>
  </div>

  <div id="bannerHint" style="display:none;color:#0b1720a0;margin-top:8px">Додайте картинку реклами <b>1200×200</b> (1 файл).</div>
  <button class="btn btnPub" id="btnPay">Опублікувати</button>
</div></div>

<!-- SEARCH -->
<div id="searchBox"><div class="searchInner" id="searchInner">
  <input id="q" placeholder="Код, телефон, заголовок, опис, місто чи область...">
  <button class="btn" id="go">Пошук</button>
</div></div>

<!-- SUPPORT -->
<div id="supportBox"><div class="supInner">
  <button class="closeX" id="closeSupport">✕</button>
  <h3 style="margin:0 0 8px 0">Підтримка</h3>
  <input class="inp" id="s_name" placeholder="Ім'я">
  <input class="inp" id="s_phone" placeholder="+380">
  <textarea class="inp" id="s_msg" placeholder="Опишіть проблему" rows="4" style="height:110px"></textarea>
  <button class="btn" id="s_send" style="width:100%;margin-top:10px">Надіслати</button>
</div></div>

<!-- PAY -->
<div id="payBox"><div class="payInner">
  <div class="payHead">
    <div style="font-size:18px">Оплата</div>
    <div class="payRight">
      <button class="btn ghost" id="btnSupportPay" title="Підтримка" style="height:36px;padding:6px 10px">ПІДТРИМКА</button>
      <button class="closeX" id="closePay" title="Закрити">✕</button>
    </div>
  </div>

  <div id="payLines" style="font-size:14px;margin-bottom:8px"></div>
  <div class="payRow"><div>Картка</div><div id="cardNum" class="copy" title="Скопіювати">5168 7451 9757 8328</div></div>
  <div class="payRow"><div>Сума</div><div id="amt">0</div></div>
  <div class="payRow"><div>Призначення</div><div id="purpose" class="copy" title="Скопіювати" style="white-space:normal"></div></div>

  <button class="btn payBtn" id="goPrivat">Сплатити</button>
  <div style="font-size:12px;color:#0b1720aa;margin-top:8px">Обов'язково вкажіть номер оголошення у призначенні платежу.</div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
<script>
const SERVER = 'https://video-hoping-tile-jeremy.trycloudflare.com';
const $ = s=>document.querySelector(s);

/* overlay helpers — стопим прокрутку страницы аккуратно */
let LOCKY=0;
function anyOverlayOpen(){
  return ['chooser','addForm','searchBox','supportBox','payBox'].some(id=>document.getElementById(id).style.display==='flex');
}
function lock(){ LOCKY = scrollY||0; document.body.classList.add('locked'); }
function unlock(){ document.body.classList.remove('locked'); window.scrollTo(0,LOCKY); }
document.documentElement.style.overscrollBehavior='none';

/* Splash короткий */
lock(); setTimeout(()=>{ const sp=document.getElementById('splash'); if(sp){ sp.style.display='none'; if(!anyOverlayOpen()) unlock(); } },1200);

/* socket */
const uidLocal = localStorage.getItem('kolo_uid') || (localStorage.setItem('kolo_uid','u_'+Math.random().toString(36).slice(2)), localStorage.getItem('kolo_uid'));
const socket = io(SERVER,{transports:['websocket'],auth:{uid:uidLocal}});

/* banner collapse — сглаживание через rAF */
const bannerEl = $('#banner');
let lastY=0, ticking=false;
addEventListener('scroll', ()=>{ lastY = window.scrollY||0;
  if(!ticking){
    requestAnimationFrame(()=>{ if(lastY>80) bannerEl.classList.add('min'); else bannerEl.classList.remove('min'); ticking=false; });
    ticking=true;
}}, {passive:true});

let ALL={hot:[],normal:[]}, page=1, ADD_TYPE='normal', CAR=[], idx=0, CUR=null;
let bannerList=[], bannerIdx=0, bannerTimer=null;
let lastPublished = null;
const PAGE_SIZE = 12;

/* sockets */
socket.on('visitors', n=>$('#visitors').textContent=n+' відвідувачів');
socket.on('banner', b=>{ setBanner(b); });
socket.on('listings', d=>{ ALL=d; page=1; draw(); });

/* initial */
fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>{ ALL=j.data||ALL; draw(); setBanner(j.banner||{}); });

/* banner rotator */
function setBanner(b){
  const imgEl = $('#bannerImg');
  const linkEl = $('#bannerLink');
  bannerList = (b && b.images && b.images.length)? b.images.slice() : (b && b.image?[b.image]:[]);
  linkEl.href = (b && b.link) ? b.link : '#';
  if(bannerTimer){ clearInterval(bannerTimer); bannerTimer=null; }
  if(!bannerList.length){ imgEl.style.display='none'; return; }
  bannerIdx = 0; imgEl.style.display='block'; imgEl.src = bannerList[bannerIdx];
  if(bannerList.length>1){
    bannerTimer = setInterval(()=>{ bannerIdx = (bannerIdx+1)%bannerList.length; imgEl.src = bannerList[bannerIdx]; }, 5000);
  }
}

/* cards/draw */
function mkCard(ad){
  const img = (ad.images && ad.images[0]) ? ad.images[0] : '';
  return `<div class="card" onclick="openDetail('${ad.id}')">
    <div class="ph">
      ${ad.type==='hot'?'<div class="badge-hot">HOT</div>':''}
      ${img?`<img src="${img}" alt="" loading="lazy" decoding="async">`:'КАРТИНКА оголошення'}
      <div class="priceTag">${(ad.price||0).toLocaleString('uk-UA')} ₴</div>
    </div>
    <div class="ttl">${(ad.title||'Оголошення').toUpperCase()}</div>
  </div>`;
}
function draw(){
  $('#hotGrid').innerHTML = (ALL.hot||[]).map(mkCard).join('');
  const slice = (ALL.normal||[]).slice(0,page*PAGE_SIZE);
  $('#listGrid').innerHTML = slice.map(mkCard).join('');
  $('#btnMore').style.display = (ALL.normal||[]).length>slice.length ? 'inline-block':'none';
}

/* preload helper для карусели */
function preloadImages(urls){
  urls.forEach(u=>{
    const im = new Image();
    im.decoding='async';
    im.loading='eager';
    im.src = u;
  });
}

/* detail */
window.openDetail = (id)=>{
  CUR = [...(ALL.hot||[]),...(ALL.normal||[])].find(a=>a.id===id); if(!CUR) return;
  $('#modTitle').textContent = (CUR.title||'').toUpperCase();
  $('#vNum').textContent = CUR.views||0; 
  $('#lNum').textContent = CUR.likes||0;
  $('#priceTop').textContent = ((CUR.price||0).toLocaleString('uk-UA'))+' ₴';
  $('#modDesc').textContent = CUR.desc||'';
  $('#chips').innerHTML = [
    'Код: '+(CUR.code||'00000'),
    'Телефон: '+(CUR.phone||'+380'),
    'Місто: '+(CUR.city||'-'),
    'Область: '+(CUR.region||'-'),
    'Дата публікації: '+(new Date().toLocaleDateString('uk-UA')),
  ].map(t=>`<div class="chip">${t}</div>`).join('');

  CAR=(CUR.images&&CUR.images.length)?CUR.images.slice(0,5):['https://picsum.photos/seed/1/1200/800']; 
  preloadImages(CAR);
  idx=0; renderCar(true);

  const dlg=$('#dlgDetail'); dlg.showModal(); lock();
  dlg.addEventListener('click', e=>{ if(e.target===dlg){ dlg.close(); if(!anyOverlayOpen()) unlock(); }},{once:true});

  fetch(SERVER+`/api/view/${encodeURIComponent(CUR.id)}`,{method:'POST',headers:{'X-KOLO-UID':uidLocal}});
  CUR.views = (CUR.views||0)+1; $('#vNum').textContent=CUR.views; draw();
};
$('#closeDetail').onclick=()=>{ $('#dlgDetail').close(); if(!anyOverlayOpen()) unlock(); };

function renderCar(initial=false){
  const st = $('#carStage');
  if(initial){
    st.innerHTML = CAR.map((u,i)=>`<img src="${u}" class="${i===0?'show':''}" alt="" loading="eager" decoding="async">`).join('');
  } else {
    [...st.querySelectorAll('img')].forEach((im,i)=>im.classList.toggle('show', i===idx));
  }
  $('#carCount').textContent = `${idx+1}/${CAR.length}`;
  $('#navLeft').style.display = $('#navRight').style.display = (CAR.length>1)?'flex':'none';
}
window.car = d=>{ idx=(idx+d+CAR.length)%CAR.length; renderCar(false); };
$('#navLeft').onclick=()=>window.car(-1);
$('#navRight').onclick=()=>window.car(1);

/* like */
$('#likeTop').onclick = async (e)=>{
  e.stopPropagation();
  if(!CUR) return;
  try{
    const j = await fetch(SERVER+`/api/like/${encodeURIComponent(CUR.id)}`,{
      method:'POST', headers:{'X-KOLO-UID':uidLocal,'Content-Type':'text/plain'}
    }).then(r=>r.json());
    if(j && j.likes!==undefined){ $('#lNum').textContent=j.likes; CUR.likes=j.likes; draw(); }
  }catch(e){}
};

/* chooser/add */
function showChooser(){ $('#chooser').style.display='flex'; lock(); }
function hideChooser(){ $('#chooser').style.display='none'; if(!anyOverlayOpen()) unlock(); }
function resetAddForm(){
  chosenFiles=[]; $('#imgPh').innerHTML=''; $('#phCnt').textContent='0/5';
  ['f_title','f_price','f_city','f_region','f_phone','f_desc'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; });
  $('#f_imgs').value='';
}
function showAdd(){
  $('#addForm').style.display='flex'; lock();
  $('#hotBadge').style.display = ADD_TYPE==='hot'?'inline-block':'none';
  const isBanner = (ADD_TYPE==='banner');
  $('#adFields').style.display = isBanner?'none':'block';
  $('#bannerHint').style.display = isBanner?'block':'none';
  $('#imgPh').classList.toggle('bannerPh', isBanner);
  $('#phCnt').textContent = isBanner? '0/1':'0/5';
}
function hideAdd(){ $('#addForm').style.display='none'; if(!anyOverlayOpen()) unlock(); }
$('#chooser').addEventListener('click',e=>{ if(e.target.id==='chooser') hideChooser(); });
$('#addForm').addEventListener('click',e=>{ if(e.target.id==='addForm') hideAdd(); });
$('#closeAdd').onclick=hideAdd;

$('#btnPlus').onclick=showChooser;
$('#chooseNormal').onclick=()=>{ADD_TYPE='normal'; hideChooser(); resetAddForm(); showAdd();}
$('#chooseHot').onclick=()=>{ADD_TYPE='hot'; hideChooser(); resetAddForm(); showAdd();}
$('#bannerOrder').onclick=(e)=>{ e.preventDefault(); ADD_TYPE='banner'; resetAddForm(); showAdd(); };

/* photos preview */
let chosenFiles=[];
const fInput = $('#f_imgs');
const imgPh = $('#imgPh');
const phCnt = $('#phCnt');
function redrawPreview(){
  const limit = (ADD_TYPE==='banner')?1:5;
  imgPh.innerHTML = chosenFiles.length
    ? chosenFiles.slice(0,limit).map(f=>`<img src="${URL.createObjectURL(f)}" alt="">`).slice(0,1).join('')
    : '';
  phCnt.textContent = `${Math.min(chosenFiles.length,limit)}/${limit}`;
}
$('#btnAddPhoto').onclick=()=>fInput.click();
imgPh.onclick=()=>fInput.click();
fInput.onchange=()=>{ const limit=(ADD_TYPE==='banner')?1:5; chosenFiles=[...fInput.files].slice(0,limit); redrawPreview(); };

/* publish -> строго pending; публикации нет */
$('#btnPay').onclick=async ()=>{
  const fd=new FormData();
  fd.append('type', ADD_TYPE);
  if(ADD_TYPE!=='banner'){
    fd.append('title', ($('#f_title').value||'Оголошення'));
    fd.append('price', ($('#f_price').value||0));
    fd.append('city', ($('#f_city').value||''));
    fd.append('region', ($('#f_region').value||''));
    fd.append('desc', ($('#f_desc').value||''));
    fd.append('phone', ($('#f_phone').value||'+380'));
  }
  chosenFiles.slice(0,(ADD_TYPE==='banner')?1:5).forEach(f=>fd.append('images',f));

  const j = await fetch(SERVER+'/api/create',{method:'POST',body:fd,headers:{'X-KOLO-UID':uidLocal}}).then(r=>r.json()).catch(()=>({}));
  if(!(j && j.ok)){ alert('Сервер недоступний'); return; }
  lastPublished = j;
  openPayBox(j.kind, j.code, j.amount);
  hideAdd();
};

/* search — серверный, с нормализацией/транслитом */
function showSearch(e){ if(e) e.preventDefault(); $('#searchBox').style.display='flex'; $('#q').focus({preventScroll:true}); lock(); }
function hideSearch(){ $('#searchBox').style.display='none'; if(!anyOverlayOpen()) unlock(); }
$('#searchBox').addEventListener('click',e=>{ if(e.target.id==='searchBox') hideSearch(); });
$('#btnSearch').onclick=showSearch;
$('#go').onclick=async ()=>{
  const k=($('#q').value||'').trim();
  hideSearch();
  if(!k){
    const j = await fetch(SERVER+'/api/list').then(r=>r.json()).catch(()=>null);
    if(j && j.ok){ ALL=j.data; page=1; draw(); }
    return;
  }
  const j = await fetch(SERVER+'/api/search?q='+encodeURIComponent(k)).then(r=>r.json()).catch(()=>null);
  if(j && j.ok){ ALL=j.data; page=100; draw(); }
};

/* more */
$('#btnMore').onclick=()=>{ page++; draw(); };

/* SUPPORT */
function openSupport(fromPay=false){
  $('#supportBox').style.display='flex';
  if(!fromPay && !anyOverlayOpen()) lock();
}
$('#closeSupport').onclick=()=>{ $('#supportBox').style.display='none'; if(!anyOverlayOpen()) unlock(); };
$('#s_send').onclick=async ()=>{
  const payload = {name:$('#s_name').value||'', phone:$('#s_phone').value||'', msg:$('#s_msg').value||''};
  await fetch(SERVER+'/api/support',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  alert('Дякуємо! Звернення надіслано.'); $('#supportBox').style.display='none'; if(!anyOverlayOpen()) unlock();
};

/* PAY BOX — копирование по клику */
function openPayBox(kind, code, amount){
  const purp = (kind==='banner'?'Банер ':'') + (kind==='hot'?'HOT ':'Звичайне ') + 'оголошення №'+code;
  $('#purpose').textContent = purp;
  $('#amt').textContent = amount + (kind==='hot'?' грн (7 днів)': (kind==='banner'?' грн (7 днів)':' грн (30 днів)'));
  $('#payLines').innerHTML = `Ваш номер: <b>№${code}</b>. Після оплати ми перевіримо платіж і опублікуємо.`;
  $('#payBox').style.display='flex'; lock();
}
$('#closePay').onclick=()=>{ $('#payBox').style.display='none'; if(!anyOverlayOpen()) unlock(); };
$('#btnSupportPay').onclick=()=>openSupport(true);
async function copyText(t){ try{ await navigator.clipboard.writeText(t); }catch{} }
$('#cardNum').onclick=()=>copyText($('#cardNum').textContent.trim());
$('#purpose').onclick=()=>copyText($('#purpose').textContent.trim());

/* Privat24 — лог и открытие */
$('#goPrivat').onclick=async ()=>{
  if(!lastPublished) return;
  await fetch(SERVER+'/api/order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(lastPublished)});
  await copyText($('#cardNum').textContent.trim());
  const url = 'https://www.privat24.ua/send/3g9dp';
  const w = window.open(url,'_blank'); if(!w){ window.location.href = url; }
};
</script>
</body>
</html>
