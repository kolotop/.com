<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<title>KOLO ‚Äî –±–∞—Ä–∞—Ö–æ–ª–∫–∞ –æ–≥–æ–ª–æ—à–µ–Ω—å</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no"/>
<meta name="theme-color" content="#10b981"/>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6fbf8;--paper:#fff;--ink:#0f172a;--muted:#64748b;--brand:#10b981;--brand-press:#0c8f63;--line:#d6e8de;--hot:#ff4d4f;--shadow-sm:0 4px 12px rgba(2,44,34,.08);--shadow-lg:0 14px 40px rgba(2,44,34,.14);--top:60px;}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--ink);font-family:"Montserrat",system-ui,Segoe UI,Roboto,Arial}body.modal-open{overflow:hidden}
.topbar{position:sticky;top:0;z-index:40;height:var(--top);display:flex;gap:10px;align-items:center;padding:10px 12px;background:#ffffffcc;backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--line)}
.pill{display:inline-flex;align-items:center;gap:8px;height:38px;padding:0 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:700}
.grow{flex:1}
.visitors{display:inline-flex;align-items:center;gap:8px;height:38px;padding:0 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:800;color:#0b3b2d}
.btnPlus{width:38px;height:38px;border-radius:10px;background:var(--brand);border:none;color:#fff;display:grid;place-items:center;font:900 22px/1 "Russo One";box-shadow:var(--shadow-sm);cursor:pointer}
.btnPlus:active{transform:translateY(1px);background:var(--brand-press)}
.container{max-width:1200px;margin:12px auto;padding:0 12px}
.panel{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow-sm)}
.adWrap{margin:8px 0}.adBanner{position:relative;height:160px;border:1px solid var(--line);border-radius:16px;overflow:hidden}.adBanner img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}.adNote{font-size:12px;opacity:.85;text-align:right;margin-top:6px}
@media(max-width:640px){.adBanner{height:140px}}
.hotHead{display:flex;gap:10px;align-items:center;margin:10px 0 8px}.tagHot{display:inline-flex;align-items:center;gap:6px;background:var(--hot);color:#fff;border:1px solid #ff6567;border-radius:12px;padding:6px 10px;font:700 13px/1 "Russo One"}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}@media(max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}}@media(max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;cursor:pointer;box-shadow:var(--shadow-sm)}
.thumb{position:relative;padding-top:62%;background:#e7f4ee;overflow:hidden}.thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.hotPill{position:absolute;left:8px;top:8px;background:var(--hot);color:#fff;border:1px solid #ff6567;border-radius:999px;padding:4px 8px;font:800 11px/1 "Russo One";z-index:2}
.badge{position:absolute;right:8px;bottom:8px;background:var(--brand);color:#fff;border-radius:10px;padding:4px 8px;font:800 12px/1 "Russo One";z-index:2}
.body{padding:10px;display:flex;gap:6px;flex-direction:column}.title{font:700 16px/1.2 "Russo One"}
.detail{position:fixed;inset:0;z-index:100;display:none;background:rgba(0,0,0,.35)}.detail.active{display:block}
.sheet{position:absolute;left:50%;top:6vh;transform:translateX(-50%);width:min(1080px,96vw);max-height:88vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow-lg)}
.modalHead{display:flex;gap:10px;align-items:center;margin-bottom:8px}
.iconBtn{height:34px;width:34px;border:1px solid var(--line);background:var(--brand);color:#fff;border-radius:10px;display:grid;place-items:center;box-shadow:var(--shadow-sm);cursor:pointer}
.closeX{height:34px;border:1px solid var(--line);background:#fff;border-radius:10px;padding:0 12px;font:700 13px/34px 'Russo One';cursor:pointer}
.big{position:relative;padding-top:56%;background:#e7f4ee;border-radius:12px;overflow:hidden}.big img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.navBtn{position:absolute;top:50%;transform:translateY(-50%);height:48px;min-width:48px;padding:0 12px;border-radius:14px;border:1px solid var(--line);background:#ffffffdd;color:#065f46;font-weight:900;font-size:26px;line-height:46px;cursor:pointer;box-shadow:var(--shadow-sm)}.navPrev{left:8px}.navNext{right:8px}
.specs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}@media(max-width:900px){.specs{grid-template-columns:repeat(2,1fr)}}.spec{background:#f4fbf7;border:1px solid var(--line);border-radius:12px;padding:8px;font-size:13px}.h{font:700 14px/1 "Russo One";margin:10px 0 6px}
.pager{display:flex;justify-content:center;margin:16px 0 12px}.btn{height:42px;border:none;border-radius:12px;background:var(--brand);color:#fff;font:700 16px/42px "Russo One";padding:0 18px;cursor:pointer;box-shadow:var(--shadow-sm)}.btn:active{transform:translateY(1px);background:var(--brand-press)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:150}.overlay.on{display:flex}
.modal{width:min(960px,96vw);max-height:88vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow-lg)}
label{font-size:12px;font-weight:800;opacity:.92;display:block;margin:0 0 6px;color:#0b3b2d}
.input,.select{width:100%;height:46px;border-radius:12px;border:1px solid var(--line);background:#edf7f1;color:#064e3b;padding:0 12px;font-size:14px;outline:none}textarea.input{height:auto;padding:10px}
.preloader{position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;z-index:9999}.pl-ring{width:140px;height:140px;border-radius:50%;border:12px solid #e7f4ee;border-top-color:#10b981;animation:spin 1.2s linear infinite}.pl-sub{font:800 16px/1.2 "Montserrat";color:#0b3b2d}@keyframes spin{to{transform:rotate(360deg)}}
.helpFab{position:fixed;right:14px;bottom:14px;width:54px;height:54px;border-radius:50%;background:var(--brand);color:#fff;display:grid;place-items:center;border:1px solid #0e9f76;box-shadow:0 10px 25px rgba(1,60,44,.2);z-index:160;cursor:pointer;font:900 22px/1 'Russo One'}
</style>
</head>
<body class="modal-open">
<!-- preloader -->
<div id="preloader" class="preloader"><div class="pl-ring"></div><div class="pl-sub">–î–æ—à–∫–∞ –æ–≥–æ–ª–æ—à–µ–Ω—å ‚Ññ1 –≤ –£–∫—Ä–∞—ó–Ω—ñ üòä</div></div>

<header class="topbar">
  <div class="pill" id="tabSearch">–ü–æ—à—É–∫</div>
  <div class="visitors"><span id="visCount">20000</span> –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>
  <div class="grow"></div>
  <button class="btnPlus" id="tabSell">+</button>
</header>

<main class="container">
  <div class="adWrap">
    <div class="adBanner"><img id="adBannerImg" alt="—Ä–µ–∫–ª–∞–º–∞"></div>
    <div class="adNote"><button class="pill" id="btnAds">–ó–∞–º–æ–≤–∏—Ç–∏ —Ä–µ–∫–ª–∞–º—É</button></div>
  </div>

  <section id="hotPanel" class="panel" style="display:none">
    <div class="hotHead"><div class="tagHot">HOT</div></div>
    <div class="grid" id="hotGrid"></div>
  </section>

  <section class="panel" style="margin-top:10px">
    <div style="display:flex;gap:10px;align-items:center">
      <input class="input" id="fltQuery" placeholder="–ó–Ω–∞–π—Ç–∏‚Ä¶">
      <button class="btn" id="btnApply">–ó–Ω–∞–π—Ç–∏</button>
      <div class="grow"></div>
    </div>
  </section>

  <section class="grid" id="grid" style="margin-top:12px"></section>
  <div class="pager"><button class="btn" id="btnMore" style="display:none">–ü–æ–∫–∞–∑–∞—Ç–∏ —â–µ</button></div>
</main>

<!-- DETAIL -->
<div id="detail" class="detail" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="modalHead">
      <button class="iconBtn" id="dShare" title="–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è">‚ñ£</button>
      <button class="iconBtn" id="dLike" title="–õ–∞–π–∫">‚ù§</button><span id="dLikeCnt" style="font-weight:800"></span>
      <div class="grow"></div>
      <button class="closeX" id="dClose">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <div id="dHeader" style="display:flex;gap:10px;align-items:center;margin-bottom:8px"></div>
    <div id="dGal"></div>
    <div class="specs" id="dSpecs" style="margin-top:10px"></div>
    <div class="h">–û–ø–∏—Å</div><div id="dDesc" style="opacity:.9"></div>
    <div class="h">–ü—Ä–æ–¥–∞–≤–µ—Ü—å</div><div class="spec" id="dSeller" style="background:#fff"></div>
  </div>
</div>

<!-- SELL -->
<div class="overlay" id="sellOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sellTitle">
    <div class="modalHead">
      <h3 id="sellTitle" style="margin:0;font:700 18px/1 'Russo One'">–î–æ–¥–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h3>
      <div class="grow"></div><button class="closeX" id="sellClose">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <div class="actions" style="margin-bottom:8px">
      <span id="sellModeBadge" class="pill">–ó–≤–∏—á–∞–π–Ω–µ</span>
      <button class="pill" id="setNormal">–ó–≤–∏—á–∞–π–Ω–µ</button>
      <button class="pill" id="setHot" style="background:#ff4d4f;color:#fff;border-color:#ff6567">HOT</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
      <div><label>–û–±–ª–∞—Å—Ç—å</label><input class="input" id="sRegion"></div>
      <div><label>–ú—ñ—Å—Ç–æ</label><input class="input" id="sCity"></div>
      <div><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
        <select class="select" id="sCat">
          <option>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option>–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞</option><option>–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å</option>
          <option>–ú–µ–±–ª—ñ</option><option>–ü–æ–±—É—Ç–æ–≤–∞ —Ç–µ—Ö–Ω—ñ–∫–∞</option><option>–í–µ–ª–æ—Å–∏–ø–µ–¥–∏</option>
          <option>–¢–≤–∞—Ä–∏–Ω–∏</option><option>–ü–æ—Å–ª—É–≥–∏</option><option>–î—ñ–º —ñ —Å–∞–¥</option>
        </select></div>
      <div style="grid-column:1/-1"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input class="input" id="sTitle"></div>
      <div><label>–°—Ç–∞–Ω</label><select class="select" id="sCond"><option>–ù–æ–≤–µ</option><option>–í–∂–∏–≤–∞–Ω–µ</option><option>–ü—ñ—Å–ª—è —Ä–µ–º–æ–Ω—Ç—É</option></select></div>
      <div><label>–¶—ñ–Ω–∞, ‚Ç¥</label><input class="input" id="sPrice" inputmode="numeric"></div>
      <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input class="input" id="sPhone" placeholder="+380"></div>
      <div><label>–Ü–º'—è</label><input class="input" id="sName" placeholder="–í–∞—à–µ —ñ–º'—è"></div><div></div><div></div>
      <div style="grid-column:1/-1"><label>–û–ø–∏—Å</label><textarea class="input" id="sDesc" rows="3"></textarea></div>
      <div style="grid-column:1/-1">
        <label>–§–æ—Ç–æ (–¥–æ 5)</label>
        <input id="sImages" type="file" accept="image/*" multiple style="display:none">
        <button class="pill" id="btnPickImages" type="button">–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button>
        <span id="imgCount" style="margin-left:8px;opacity:.8;font-weight:700"></span>
        <div id="thumbs" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"></div>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button class="btn" id="sSave">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
      <span style="opacity:.8">–ü—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑‚Äô—è–≤–∏—Ç—å—Å—è –≤—ñ–∫–Ω–æ –æ–ø–ª–∞—Ç–∏ —Ç–∞ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó üí≥</span>
    </div>
  </div>
</div>

<!-- SUPPORT -->
<div class="helpFab" id="helpFab">?</div>
<div class="overlay" id="helpOverlay">
  <div class="modal">
    <div class="modalHead"><h3 style="margin:0">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</h3><div class="grow"></div><button class="closeX" id="helpClose">–ó–∞–∫—Ä–∏—Ç–∏</button></div>
    <div id="helpLog" style="max-height:50vh;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff;margin-bottom:8px"></div>
    <div style="display:flex;gap:8px">
      <input class="input" id="helpText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶"><button class="btn" id="helpSend">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
    </div>
  </div>
</div>

<script>
// ===== –£–ö–ê–ñ–ò URL –°–ï–†–í–ï–†–ê =====
const API = "https://fountain-doc-envelope-gcc.trycloudflare.com"; // <= –≤—Å—Ç–∞–≤—å —Å–≤–æ–π –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞/—Ç—É–Ω–Ω–µ–ª—è

const $=s=>document.querySelector(s);
const LOG=(extra={})=>fetch(`${API}/track`,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({page:location.pathname,...extra})}).catch(()=>{});

// —Å—á—ë—Ç—á–∏–∫ 1..3/15—Å —É –≤—Å–µ—Ö –æ–¥–∏–Ω–∞–∫–æ–≤–æ
const VIS_BASE=20000,TICK_MS=15000;
const epochDay=()=>{const n=new Date();return Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate());}
const tickNow=()=>Math.floor((Date.now()-epochDay())/TICK_MS);
const incByTick=t=>((t*1103515245+12345)>>>0)%3+1;
function visitorsNow(){let add=0,tn=tickNow();for(let i=0;i<=tn;i++)add+=incByTick(i);return VIS_BASE+add;}

const fmtUA=d=>new Date(d).toLocaleDateString('uk-UA');
const elImg=(src,alt)=>{const i=new Image();i.loading="lazy";i.alt=alt||"";i.referrerPolicy="no-referrer";i.src=src||"";return i;}
let adsImgs=[],page=0,pageSize=24;

// –∞–¥–º–∏–Ω—Å–∫–∏–π –±–æ—Ç –Ω–∞–º –Ω–µ –Ω—É–∂–µ–Ω –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ. ¬´–ó–∞–º–æ–≤–∏—Ç–∏ —Ä–µ–∫–ª–∞–º—É¬ª ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∏:
$("#btnAds").onclick=()=>{$("#helpOverlay").classList.add('on');document.body.classList.add('modal-open');};

// visitors UI
const updVisitors=()=>$("#visCount").textContent=visitorsNow().toLocaleString('uk-UA');

// preloader
setTimeout(()=>{$("#preloader").style.display='none';document.body.classList.remove('modal-open');}, 1500);

// banner
async function loadConfig(){
  const js = await fetch(`${API}/config`).then(r=>r.json()).catch(()=>({}));
  adsImgs = js.ads?.images||[];
  if(adsImgs.length){
    let i=0; const b=$("#adBannerImg");
    const set=()=>{ b.src=adsImgs[i%adsImgs.length]; i++; };
    set(); setInterval(set, 5000);
  }
}

// HOT + grid
async function loadHot(){
  const js = await fetch(`${API}/listings/hot`).then(r=>r.json()).catch(()=>({items:[]}));
  const items = js.items||[];
  const grid=$("#hotGrid"); grid.innerHTML="";
  if(!items.length){ $("#hotPanel").style.display="none"; return; }
  $("#hotPanel").style.display="block";
  items.forEach(renderCardTo(grid));
}

function renderCardTo(container){
  return (it)=>{
    const el=document.createElement('article'); el.className='card'; el.onclick=()=>openDetail(it.id);
    const th=document.createElement('div'); th.className='thumb';
    if(it.hot){const hot=document.createElement('div');hot.className='hotPill';hot.textContent='HOT';th.appendChild(hot);}
    const price=document.createElement('div');price.className='badge';price.textContent=`${(it.price||0).toLocaleString('uk-UA')} ${it.currency||"‚Ç¥"}`;th.appendChild(price);
    th.appendChild(elImg((it.images&&it.images[0])||"", it.title));
    el.appendChild(th);
    const body=document.createElement('div');body.className='body';
    body.innerHTML=`<div class="title">${it.title}</div><div class="meta">${it.cat} ‚Ä¢ ${it.cond}</div><div class="meta">${it.region} ‚Ä¢ ${it.city}</div>`;
    el.appendChild(body);
    container.appendChild(el);
  }
}

let lastTotal=0;
async function applyFilters(reset=true){
  if(reset){ page=0; $("#grid").innerHTML=""; }
  const q=$("#fltQuery").value.trim();
  const js = await fetch(`${API}/listings?search=${encodeURIComponent(q)}&page=${page}&size=${pageSize}`).then(r=>r.json()).catch(()=>({total:0,items:[]}));
  lastTotal = js.total||0;
  (js.items||[]).forEach(renderCardTo($("#grid")));
  const hasMore=((page+1)*pageSize<lastTotal);
  $("#btnMore").style.display = hasMore? "inline-flex":"none";
}

$("#btnMore").onclick=()=>{page++;applyFilters(false);};
$("#btnApply").onclick=()=>applyFilters(true);

// ===== DETAIL
let current=null, galImgs=[],galIdx=0;
const dLikeBtn=$("#dLike"), dLikeCnt=$("#dLikeCnt"), dShareBtn=$("#dShare");

async function openDetail(id){
  const q=$("#fltQuery").value.trim();
  const js = await fetch(`${API}/listings?search=${encodeURIComponent(q)}&page=0&size=9999`).then(r=>r.json()).catch(()=>({items:[]}));
  current=(js.items||[]).find(x=>x.id===id); if(!current) return;
  fetch(`${API}/listings/${id}/view`,{method:"POST"}).catch(()=>{});
  const d=$("#detail"); d.classList.add('active'); d.setAttribute('aria-hidden','false'); document.body.classList.add('modal-open');
  $("#dClose").onclick=()=>{ d.classList.remove('active'); d.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); };

  const head=document.createElement('div'); head.style.display='flex'; head.style.alignItems='center'; head.style.gap='10px';
  head.innerHTML=`<div class="title" style="font:700 20px/1.2 'Russo One'">${current.title}</div>
                  <div class="pill" style="background:#10b981;color:#fff">‚Ç¥ ${(current.price||0).toLocaleString('uk-UA')}</div>`;
  $("#dHeader").innerHTML=""; $("#dHeader").appendChild(head);

  galImgs=(current.images&&current.images.length)?current.images:[""]; galIdx=0; renderGallery(current.title);

  $("#dSpecs").innerHTML =
    `<div class="spec"><div class="h">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</div>${current.cat}</div>
     <div class="spec"><div class="h">–°—Ç–∞–Ω</div>${current.cond}</div>
     <div class="spec"><div class="h">–û–±–ª–∞—Å—Ç—å</div>${current.region}</div>
     <div class="spec"><div class="h">–ú—ñ—Å—Ç–æ</div>${current.city}</div>
     <div class="spec"><div class="h">–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ</div>${fmtUA(current.created||Date.now())}</div>`;

  $("#dDesc").textContent = current.desc||"";
  $("#dSeller").innerHTML = `<b>${current.contact?.name||"–ü—Ä–æ–¥–∞–≤–µ—Ü—å"}</b><br>${current.contact?.phone||""}`;
  dLikeCnt.textContent = current.likes||0;

  dLikeBtn.onclick=(e)=>{e.preventDefault();e.stopPropagation();fetch(`${API}/listings/${id}/like`,{method:"POST"}).then(r=>r.json()).then(js=>{dLikeCnt.textContent=js.likes}).catch(()=>{});};
  dShareBtn.onclick=()=>{const url=location.origin+location.pathname+"#"+id; if(navigator.share) navigator.share({title:current.title,url}).catch(()=>{}); else {navigator.clipboard?.writeText(url); alert("–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ");}};
}

function renderGallery(title){
  const gal=$("#dGal"); gal.innerHTML=`<div class="big"><button class="navBtn navPrev">‚Äπ</button><button class="navBtn navNext">‚Ä∫</button></div>`;
  const big=gal.querySelector(".big"); big.appendChild(elImg(galImgs[galIdx]||"", title));
  gal.querySelector(".navPrev").onclick=()=>{galIdx=(galIdx-1+galImgs.length)%galImgs.length; renderGallery(title);}
  gal.querySelector(".navNext").onclick=()=>{galIdx=(galIdx+1)%galImgs.length; renderGallery(title);}
}

// ===== SELL =====
const inputImages=$("#sImages"), btnPick=$("#btnPickImages"), thumbs=$("#thumbs"), imgCount=$("#imgCount");
let pickedImgs=[]; btnPick.onclick=()=>inputImages.click();
inputImages.onchange=async()=>{const files=[...(inputImages.files||[])].slice(0,5); for(const f of files){const b=await fileToDataURL(f); pickedImgs.push(b);} renderThumbs(); inputImages.value="";}
function renderThumbs(){imgCount.textContent=pickedImgs.length?`${pickedImgs.length}/5`:"";thumbs.innerHTML="";pickedImgs.forEach(src=>{const im=elImg(src,"");im.style.cssText="width:72px;height:52px;object-fit:cover;border-radius:10px;border:1px solid var(--line)";thumbs.appendChild(im);});}
function fileToDataURL(file){return new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result);r.readAsDataURL(file);});}

let postMode="normal"; const modeBadge=$("#sellModeBadge");
$("#setNormal").onclick=()=>{postMode="normal";modeBadge.textContent="–ó–≤–∏—á–∞–π–Ω–µ";modeBadge.style.background="#fff";modeBadge.style.color="#0f172a";}
$("#setHot").onclick=()=>{postMode="hot";modeBadge.textContent="HOT";modeBadge.style.background="#ff4d4f";modeBadge.style.color="#fff";}

function openSell(){ $("#sellOverlay").classList.add('on'); $("#sellOverlay").setAttribute('aria-hidden','false'); document.body.classList.add('modal-open'); }
$("#tabSell").onclick=openSell;
$("#sellClose").onclick=()=>{ $("#sellOverlay").classList.remove('on'); $("#sellOverlay").setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); }

$("#sSave").onclick=async ()=>{
  const region=$("#sRegion").value.trim(), city=$("#sCity").value.trim(), cat=$("#sCat").value, title=$("#sTitle").value.trim();
  const cond=$("#sCond").value, price=+($("#sPrice").value||0), phone=$("#sPhone").value.trim(), name=$("#sName").value.trim()||"–ü—Ä–æ–¥–∞–≤–µ—Ü—å", desc=$("#sDesc").value.trim();
  if(!region||!city||!cat||!title||!desc||price<0) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è —ñ –∫–æ—Ä–µ–∫—Ç–Ω—É —Ü—ñ–Ω—É.");
  const images=pickedImgs.slice(0,5);
  const body={region,city,cat,cond,title,price, currency:"‚Ç¥", desc, contact:{name,phone}, images, mode:postMode};
  const js = await fetch(`${API}/submit`,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()).catch(()=>({ok:false}));
  if(js.ok){
    // –æ–∫–Ω–æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∏ –æ–ø–ª–∞—Ç—ã
    const sid = js.sid;
    alert(`‚úÖ –ó–∞—è–≤–∫—É –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!\n\n–ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ${sid}\n\n–£ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—ñ –ø–ª–∞—Ç–µ–∂—É –û–ë–û–í'–Ø–ó–ö–û–í–û –≤–∫–∞–∂—ñ—Ç—å: ${sid}\n\n–ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –æ—á—ñ–∫—É–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞.`);
    window.open("https://www.privat24.ua/send/3g9dp","_blank");
  }else{
    alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.");
  }
  pickedImgs=[]; renderThumbs(); $("#sellOverlay").classList.remove('on'); document.body.classList.remove('modal-open');
};

// ===== SUPPORT =====
const SID_SUPPORT = localStorage.getItem("kolo_support_sid") || "";
async function ensureSupportSid(){
  let sid = localStorage.getItem("kolo_support_sid");
  if(!sid){
    const js = await fetch(`${API}/support/open`,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({sid:null})}).then(r=>r.json()).catch(()=>({}));
    if(js.sid){ sid=js.sid; localStorage.setItem("kolo_support_sid", sid); }
  }
}
function addHelpLine(who, text){
  const row=document.createElement("div");
  row.style.cssText="margin:6px 0;"; row.innerHTML = `<b>${who==='admin'?'KOLO':'–Ø'}:</b> ${text}`;
  $("#helpLog").appendChild(row); $("#helpLog").scrollTop = 1e9;
}
async function pullHelp(){
  const sid = localStorage.getItem("kolo_support_sid"); if(!sid) return;
  const js = await fetch(`${API}/support/inbox?sid=${encodeURIComponent(sid)}`).then(r=>r.json()).catch(()=>({items:[]}));
  $("#helpLog").innerHTML=""; (js.items||[]).forEach(m=>addHelpLine(m.who,m.text));
}
$("#helpFab").onclick=()=>{$("#helpOverlay").classList.add('on');document.body.classList.add('modal-open');pullHelp();};
$("#helpClose").onclick=()=>{$("#helpOverlay").classList.remove('on');document.body.classList.remove('modal-open');};
$("#helpSend").onclick=async()=>{const t=$("#helpText").value.trim(); if(!t) return; await ensureSupportSid(); const sid=localStorage.getItem("kolo_support_sid"); await fetch(`${API}/support/send`,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({sid,text:t})}); $("#helpText").value=""; addHelpLine('user',t);};

// ===== init =====
(async function init(){
  LOG(); updVisitors(); setInterval(updVisitors,1000);
  await loadConfig(); await loadHot(); await applyFilters(true);
  if(location.hash && location.hash.length>1){ const id=location.hash.slice(1); setTimeout(()=>openDetail(id),600); }
  $("#tabSearch").onclick=()=>{ alert("–ü–æ—à—É–∫ –ø–æ–∫–∏ —â–æ –ø—Ä–æ—Å—Ç–∏–π: –ø–æ–ª–µ –∑–≤–µ—Ä—Ö—É –≤–∂–µ –ø—Ä–∞—Ü—é—î üòä"); };
})();
</script>
</body>
</html>
