<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>KOLO — дошка оголошень</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#10b981">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%2310b981'/%3E%3Ccircle cx='50' cy='50' r='40' fill='none' stroke='%23fff' stroke-width='6'/%3E%3Ctext x='50' y='58' text-anchor='middle' font-family='Russo One,Arial' font-size='22' fill='%23fff'%3EKOLO%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
<style>
:root{--g:#10b981;--r:#e94251;--txt:#0b1720}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:'Russo One',Arial,system-ui;background:#f5f7f6;color:var(--txt);-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none}
.wrap{max-width:1140px;margin:0 auto;padding:10px 14px}

/* splash */
#splash{position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:60}
.loader{position:relative;width:220px;height:220px;border-radius:50%;border:12px solid #e6faf2;border-top-color:var(--g);animation:spin 1s linear infinite}
.loader span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--g);font-size:38px}
#splash .sub{margin-top:18px;color:#0b1720aa}
@keyframes spin{to{transform:rotate(360deg)}}

/* header */
header{position:sticky;top:0;z-index:40;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.topbar{display:grid;grid-template-columns:auto 1fr auto auto auto;gap:10px;align-items:center}
.logo svg{width:44px;height:44px}
.pill{background:var(--g);color:#fff;border-radius:12px;padding:8px 14px;font-size:13px}
.btn{border:none;background:var(--g);color:#fff;border-radius:12px;padding:10px 16px;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,.25);font-family:inherit}
.btn.plus{background:#fff;color:var(--g);border:3px solid var(--g);width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:none}

/* support */
.btn.supp{background:#fff;color:var(--g);border:3px solid var(--g)}

/* banner */
.banner{margin:8px 0;position:relative;overflow:hidden;transition:max-height .35s ease, opacity .35s ease, margin .35s ease;max-height:180px}
.banner img{width:100%;height:170px;object-fit:cover;border-radius:10px;display:block;box-shadow:0 8px 18px rgba(0,0,0,.08)}
/* ТОЛЬКО телефон: картинка строго как есть, без серых полей */
@media(max-width:760px){
  .banner{max-height:none}
  .banner img{height:auto;object-fit:cover;background:transparent}
}
.banner .adlink{position:absolute;right:10px;bottom:8px;font-size:12px;color:#2b7;background:#fff;border-radius:8px;padding:4px 8px;opacity:.92}
.banner.min{max-height:0;opacity:0;margin:0}

/* sections */
.hsec{display:flex;align-items:center;gap:8px;color:#fff;padding:8px 14px;border-radius:12px;margin:12px 0;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.hsec svg{width:18px;height:18px;fill:#fff}
.hsec.top{background:linear-gradient(90deg,#ff4d4d,#ff7a1a)}
.hsec.new{background:var(--g)}

/* cards */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
@media(min-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{background:#fff;border-radius:16px;padding:12px;position:relative;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06);transition:transform .12s ease}
.card:hover{transform:translateY(-2px)}
.card .ph{position:relative;border-radius:10px;height:150px;display:flex;align-items:center;justify-content:center;background:#eefaf5;color:#6cc8a8;overflow:hidden}
.card .ph img{width:100%;height:100%;object-fit:cover;display:block}
.badge-hot{position:absolute;right:12px;top:12px;background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff;border-radius:12px;padding:4px 10px;font-size:12px;z-index:3}
.card .ttl{margin-top:10px;line-height:1.1;font-size:14px}
/* цена — НЕ ссылка, не звонит */
.priceTag{position:absolute;right:10px;bottom:10px;background:var(--g);color:#fff;border:none;border-radius:16px;padding:6px 12px;box-shadow:0 8px 18px rgba(16,185,129,.25);font-family:inherit;z-index:3;pointer-events:none}

/* modal */
dialog{border:none;border-radius:16px;padding:0;width:96%;max-width:980px}
dialog::backdrop{background:rgba(0,0,0,.68)}
#modalBox{border-radius:16px;background:#fff;overflow:hidden;position:relative;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.modHead{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #edf3f0}
.modTitle{flex:1}
.closeX{border:none;background:#fff;color:var(--g);border:3px solid var(--g);width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}

/* карусель */
.carousel{position:relative;border-bottom:1px solid #edf3f0;background:#000}
#carStage{position:relative;height:520px;max-height:52vh}
#carStage img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .25s ease;pointer-events:none}
#carStage img.show{opacity:1}
/* стрелки поверх и кликабельные всегда */
.navbtn{position:absolute;top:50%;transform:translateY(-50%);background:transparent;color:#fff;border:none;width:auto;height:auto;display:flex;align-items:center;justify-content:center;font-size:34px;font-weight:800;line-height:1;padding:6px 10px;user-select:none;z-index:5}
.navbtn.left{left:10px}.navbtn.right{right:10px}
#carCount{position:absolute;right:10px;bottom:10px;background:#000b;color:#fff;border-radius:10px;padding:4px 8px;font-size:12px;z-index:4}
/* лайки/просмотры/цена — общий размер цифры одинаковый */
.statOverlay{position:absolute;right:10px;top:10px;display:flex;gap:8px;z-index:6}
.statLeft{position:absolute;left:10px;top:10px;display:flex;gap:8px;z-index:6}
.pillStat{display:inline-flex;align-items:center;gap:8px;border-radius:18px;padding:6px 10px;box-shadow:0 6px 14px rgba(0,0,0,.25);font-family:'Russo One',Arial,system-ui;background:var(--g);color:#fff}
.pillStat svg{width:16px;height:16px;fill:#fff}
.pillStat b{font-family:'Russo One',Arial,system-ui;font-size:14px}

/* описание сразу под фото */
.modBody{padding:14px}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{background:#eefaf5;color:#0b1720;border-radius:12px;padding:10px 12px}

/* chooser/add/search */
#chooser,#addForm,#searchBox,#supportBox,#payBox{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
.chooseBox{position:relative;width:90%;max-width:420px;background:#fff;border-radius:16px;padding:24px;display:flex;flex-direction:column;gap:14px;align-items:center;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.chooseBtn{width:100%;padding:16px;border:none;border-radius:12px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06);font-family:inherit}
.chooseBtn.green{background:var(--g);color:#fff}
.chooseBtn.red{background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff}
.formBox{width:92%;max-width:560px;background:#fff;border-radius:16px;padding:16px;position:relative;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.formTop{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.badgeSmall{background:var(--g);color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
.badgeSmall.gray{background:#eef3f0;color:#0b1720}
.imagePh{border-radius:12px;min-height:220px;display:flex;align-items:center;justify-content:center;margin:8px 0;overflow:hidden;background:#eefaf5}
.imagePh img{width:100%;height:100%;object-fit:contain}
.inp{background:var(--g);color:#fff;border:none;border-radius:12px;padding:12px 14px;width:100%;margin-top:10px;caret-color:#fff;font-family:inherit}
.inprow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
::placeholder{color:#fff;opacity:.9}
.btnPub{width:100%;margin-top:14px;border-radius:12px;font-family:inherit}

/* search box — сверху, не скроллит */
#searchBox{align-items:flex-start}
.searchInner{background:#fff;border-radius:16px;padding:12px;width:92%;max-width:560px;display:flex;gap:8px;box-shadow:0 18px 40px rgba(0,0,0,.28);margin:14px auto}
.searchInner input{flex:1;border:2px solid #e3f4ef;border-radius:12px;padding:12px 14px;font-family:inherit}

/* pay box */
.payInner{background:#fff;border-radius:16px;padding:16px 16px 20px;width:92%;max-width:520px;box-shadow:0 18px 40px rgba(0,0,0,.28);position:relative}
.payHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.copy{cursor:pointer;border:2px solid #e3f4ef;border-radius:8px;padding:6px 8px}
.payRow{display:flex;justify-content:space-between;gap:10px;margin:8px 0;padding:10px;border:2px solid #e3f4ef;border-radius:12px}
.payBtn{width:100%;margin-top:12px}

/* support box */
.supInner{background:#fff;border-radius:16px;padding:16px;width:92%;max-width:520px;box-shadow:0 18px 40px rgba(0,0,0,.28);position:relative}
.supInner .inp{background:#eefaf5;color:#0b1720}
.supInner .inp::placeholder{color:#6aa}
.supInner .closeX{position:absolute;right:12px;top:12px}

/* footer */
footer{padding:18px 0;margin-top:20px;color:#0b1720a0;text-align:center}
.tagline{margin-top:6px}
</style>
</head>
<body>
<div id="splash">
  <div class="loader"><span>KOLO</span></div>
  <div class="sub">Дошка оголошень №1 в Україні</div>
</div>

<header>
  <div class="wrap">
    <div class="topbar">
      <button class="btn supp" id="btnSupport">ПІДТРИМКА</button>
      <div class="logo">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="48" fill="#10b981"/>
          <circle cx="50" cy="50" r="40" fill="none" stroke="#fff" stroke-width="6"/>
          <text x="50" y="58" font-size="22" text-anchor="middle" fill="#fff" font-family="Russo One,Arial">KOLO</text>
        </svg>
      </div>
      <div><span id="visitors" class="pill">27369 відвідувачів</span></div>
      <button class="btn plus" id="btnPlus">+</button>
      <button class="btn" id="btnSearch">ПОШУК</button>
    </div>

    <div id="banner" class="banner">
      <img id="bannerImg" src="" alt="banner" onerror="this.style.display='none'">
      <a href="#" id="bannerLink" class="adlink">Замовити рекламу</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="hsec top">
    <svg viewBox="0 0 24 24"><path d="M12 2c2 3 6 5.5 6 10.2A6 6 0 0 1 6 12.2C6 8 9 5 11 3.2c-.2 2.1.8 3.5 2.5 4.8C14 6.5 13 4.2 12 2Z"/></svg>
    <span>ТОП пропозицій</span>
  </div>
  <div id="hotGrid" class="grid"></div>

  <div class="hsec new">Нові оголошення</div>
  <div id="listGrid" class="grid"></div>
  <div style="display:flex;justify-content:center;margin:18px 0">
    <button id="btnMore" class="btn" style="background:#fff;color:#10b981;border:2px solid #10b981">Показати ще</button>
  </div>
</main>

<footer>
  <div>© KOLO, 2025</div>
  <div class="tagline">Дошка оголошень №1 в Україні</div>
</footer>

<!-- DETAIL -->
<dialog id="dlgDetail">
  <div id="modalBox">
    <div class="modHead">
      <div class="modTitle" id="modTitle">ОГОЛОШЕННЯ</div>
      <button class="closeX" id="closeDetail" title="Закрити">✕</button>
    </div>
    <div class="carousel">
      <!-- лево: цена; право: просмотры/лайки -->
      <div class="statLeft"><div class="pillStat" id="priceTop"></div></div>
      <div class="statOverlay">
        <div class="pillStat" title="Перегляди">
          <svg viewBox="0 0 24 24"><path d="M12 5C5 5 1 12 1 12s4 7 11 7 11-7 11-7-4-7-11-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg>
          <b id="vNum">0</b>
        </div>
        <button class="pillStat" id="likeTop" style="border:none;cursor:pointer" title="Лайк">
          <svg viewBox="0 0 24 24"><path d="M12 21s-7.5-4.35-10-8.5C.5 8.5 3 5 6.5 5 8.7 5 10 6.2 12 8c2-1.8 3.3-3 5.5-3C21 5 23.5 8.5 22 12.5 19.5 16.7 12 21 12 21Z"/></svg>
          <b id="lNum">0</b>
        </button>
      </div>
      <button class="navbtn left" id="navLeft" aria-label="Попереднє">‹</button>
      <div id="carStage"></div>
      <div id="carCount">1/1</div>
      <button class="navbtn right" id="navRight" aria-label="Наступне">›</button>
    </div>
    <div class="modBody">
      <div id="modDesc" style="margin-bottom:12px;white-space:pre-wrap"></div>
      <div class="chips" id="chips"></div>
    </div>
  </div>
</dialog>

<!-- CHOOSER -->
<div id="chooser"><div class="chooseBox" id="chooseBox">
  <button class="chooseBtn green" id="chooseNormal">Звичайне оголошення — 39 грн / 30 днів</button>
  <button class="chooseBtn red" id="chooseHot">HOT оголошення — 299 грн / 30 днів</button>
</div></div>

<!-- ADD FORM -->
<div id="addForm"><div class="formBox" id="addInner">
  <div class="formTop">
    <div class="badgeSmall" id="btnAddPhoto">Додати фото <span id="phCnt">0/5</span></div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="hotBadge" class="badgeSmall" style="background:#e94251;display:none">HOT</div>
      <button class="closeX" id="closeAdd" title="Закрити">✕</button>
    </div>
  </div>
  <div class="imagePh" id="imgPh"></div>
  <input type="file" id="f_imgs" accept="image/*" multiple hidden>

  <input class="inp" id="f_title" placeholder="Заголовок">
  <div class="inprow">
    <input class="inp" id="f_price" placeholder="Ціна, грн">
    <input class="inp" id="f_city" placeholder="Місто">
  </div>
  <div class="inprow">
    <input class="inp" id="f_region" placeholder="Область">
    <input class="inp" id="f_phone" placeholder="+380">
  </div>
  <textarea class="inp" id="f_desc" placeholder="Опис" rows="4" style="height:110px"></textarea>

  <button class="btn btnPub" id="btnPay">Опублікувати</button>
</div></div>

<!-- SEARCH -->
<div id="searchBox"><div class="searchInner" id="searchInner">
  <input id="q" placeholder="Ключові слова... (заголовок, опис, місто, область)">
  <button class="btn" id="go">Пошук</button>
</div></div>

<!-- SUPPORT -->
<div id="supportBox"><div class="supInner">
  <button class="closeX" id="closeSupport">✕</button>
  <h3 style="margin:0 0 8px 0">Підтримка</h3>
  <input class="inp" id="s_name" placeholder="Ім'я">
  <input class="inp" id="s_phone" placeholder="+380">
  <textarea class="inp" id="s_msg" placeholder="Опишіть проблему" rows="4" style="height:110px"></textarea>
  <button class="btn" id="s_send" style="width:100%;margin-top:10px">Надіслати</button>
</div></div>

<!-- PAY BOX (Privat24) -->
<div id="payBox"><div class="payInner">
  <div class="payHead">
    <div style="font-size:18px">Оплата оголошення</div>
    <button class="closeX" id="closePay">✕</button>
  </div>
  <div id="payLines" style="font-size:14px;margin-bottom:8px"></div>
  <div class="payRow"><div>Картка для оплати</div><div id="cardNum">5168 7451 9757 8328</div></div>
  <div class="payRow"><div>Сума</div><div id="amt">0</div></div>
  <div class="payRow"><div>Призначення</div><div id="purpose" class="copy" title="Скопіювати">—</div></div>
  <button class="btn payBtn" id="goPrivat">Сплатити</button>
  <div style="font-size:12px;color:#0b1720aa;margin-top:8px">Обов'язково вкажіть номер оголошення у призначенні платежу.</div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
<script>
const SERVER = 'https://heater-health-looking-lawrence.trycloudflare.com';
const $ = s=>document.querySelector(s);

/* Splash 5s (без скролла) */
document.body.style.overflow='hidden';
setTimeout(()=>{
  document.getElementById('splash').style.display='none';
  document.body.style.overflow='';
},5000);

/* socket */
const uidLocal = localStorage.getItem('kolo_uid') || (localStorage.setItem('kolo_uid','u_'+Math.random().toString(36).slice(2)), localStorage.getItem('kolo_uid'));
const socket = io(SERVER,{transports:['websocket'],auth:{uid:uidLocal}});

/* баннер — аккуратно сворачивается */
const bannerEl = $('#banner');
window.addEventListener('scroll', ()=>{ if(window.scrollY>80) bannerEl.classList.add('min'); else bannerEl.classList.remove('min'); });

let ALL={hot:[],normal:[]}, page=1, ADD_TYPE='normal', CAR=[], idx=0, CUR=null;
let bannerList=[], bannerIdx=0, bannerTimer=null;
let lastPublished = null; // для окна оплаты

/* sockets */
socket.on('visitors', n=>$('#visitors').textContent=n+' відвідувачів');
socket.on('banner', b=>{ setBanner(b); });
socket.on('listings', d=>{ ALL=d; page=1; draw(); });

/* initial data */
fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>{
  ALL=j.data||ALL; draw();
  setBanner(j.banner||{});
});

/* banner rotator */
function setBanner(b){
  const imgEl = document.getElementById('bannerImg');
  const linkEl = document.getElementById('bannerLink');
  bannerList = (b && b.images && b.images.length)? b.images.slice() : (b && b.image?[b.image]:[]);
  linkEl.onclick = (e)=>{ e.preventDefault(); openBannerOrder(); };

  if(bannerTimer){ clearInterval(bannerTimer); bannerTimer=null; }
  if(!bannerList.length){ imgEl.style.display='none'; return; }

  bannerIdx = 0;
  imgEl.style.display='block';
  imgEl.src = bannerList[bannerIdx];

  if(bannerList.length>1){
    bannerTimer = setInterval(()=>{ bannerIdx = (bannerIdx+1)%bannerList.length; imgEl.src = bannerList[bannerIdx]; }, 5000);
  }
}

/* cards */
function mkCard(ad){
  const img = (ad.images && ad.images[0]) ? ad.images[0] : '';
  return `<div class="card" onclick="openDetail('${ad.id}')">
    <div class="ph">
      ${ad.type==='hot'?'<div class="badge-hot">HOT</div>':''}
      ${img?`<img src="${img}" alt="">`:'КАРТИНКА оголошення'}
      <div class="priceTag">${(ad.price||0).toLocaleString('uk-UA')} ₴</div>
    </div>
    <div class="ttl">${(ad.title||'Оголошення').toUpperCase()}</div>
  </div>`;
}
function draw(){
  document.getElementById('hotGrid').innerHTML = (ALL.hot||[]).map(mkCard).join('');
  const slice = (ALL.normal||[]).slice(0,page*6);
  document.getElementById('listGrid').innerHTML = slice.map(mkCard).join('');
  document.getElementById('btnMore').style.display = (ALL.normal||[]).length>slice.length ? 'inline-block':'none';
}

/* scroll lock helpers */
function disableScroll(){ document.body.style.overflow='hidden'; }
function enableScroll(){ document.body.style.overflow=''; }

/* detail */
window.openDetail = (id)=>{
  CUR = [...(ALL.hot||[]),...(ALL.normal||[])].find(a=>a.id===id); if(!CUR) return;
  document.getElementById('modTitle').textContent = (CUR.title||'').toUpperCase();
  document.getElementById('vNum').textContent = CUR.views||0; 
  document.getElementById('lNum').textContent = CUR.likes||0;
  document.getElementById('priceTop').textContent = ((CUR.price||0).toLocaleString('uk-UA'))+' ₴';
  document.getElementById('modDesc').textContent = CUR.desc||'';
  document.getElementById('chips').innerHTML = [
    'Код: '+(CUR.code||'00000'),
    'Телефон: '+(CUR.phone||'+380'),
    'Місто: '+(CUR.city||'-'),
    'Область: '+(CUR.region||'-'),
    'Дата публікації: '+(new Date().toLocaleDateString('uk-UA')),
  ].map(t=>`<div class="chip">${t}</div>`).join('');

  CAR=(CUR.images&&CUR.images.length)?CUR.images.slice(0,5):['https://picsum.photos/seed/1/1200/800']; 
  idx=0; renderCar(true);

  const dlg=document.getElementById('dlgDetail'); dlg.showModal(); disableScroll();
  dlg.addEventListener('click', e=>{ if(e.target===dlg){ dlg.close(); enableScroll(); }});

  // +1 перегляд на сервер
  fetch(SERVER+`/api/view/${encodeURIComponent(CUR.id)}`,{method:'POST',headers:{'X-KOLO-UID':uidLocal}});
  CUR.views = (CUR.views||0)+1; document.getElementById('vNum').textContent=CUR.views; draw();
};

document.getElementById('closeDetail').onclick=()=>{ document.getElementById('dlgDetail').close(); enableScroll(); };

function renderCar(initial=false){
  const st = document.getElementById('carStage');
  if(initial){
    st.innerHTML = CAR.map((u,i)=>`<img src="${u}" class="${i===0?'show':''}" alt="">`).join('');
  }else{
    const imgs = [...st.querySelectorAll('img')];
    imgs.forEach((im,i)=>im.classList.toggle('show', i===idx));
  }
  document.getElementById('carCount').textContent = `${idx+1}/${CAR.length}`;
  document.getElementById('navLeft').style.display = document.getElementById('navRight').style.display = (CAR.length>1)?'flex':'none';
}
window.car = d=>{ idx=(idx+d+CAR.length)%CAR.length; renderCar(false); };
document.getElementById('navLeft').onclick=()=>window.car(-1);
document.getElementById('navRight').onclick=()=>window.car(1);

/* like — работает всегда */
document.getElementById('likeTop').onclick = async (e)=>{
  e.stopPropagation();
  if(!CUR) return;
  try{
    const j = await fetch(SERVER+`/api/like/${encodeURIComponent(CUR.id)}`,{
      method:'POST',
      headers:{'X-KOLO-UID':uidLocal,'Content-Type':'text/plain'}
    }).then(r=>r.json());
    if(j && j.likes!==undefined){ 
      document.getElementById('lNum').textContent=j.likes; 
      CUR.likes=j.likes; 
      draw(); 
    }
  }catch(e){}
};

/* chooser/add */
function showChooser(){ document.getElementById('chooser').style.display='flex'; disableScroll(); }
function hideChooser(){ document.getElementById('chooser').style.display='none'; enableScroll(); }
function showAdd(){ document.getElementById('addForm').style.display='flex'; document.getElementById('hotBadge').style.display = ADD_TYPE==='hot'?'inline-block':'none'; disableScroll(); }
function hideAdd(){ document.getElementById('addForm').style.display='none'; enableScroll(); }
document.getElementById('chooser').addEventListener('click',e=>{ if(e.target.id==='chooser') hideChooser(); });
document.getElementById('addForm').addEventListener('click',e=>{ if(e.target.id==='addForm') hideAdd(); });
document.getElementById('closeAdd').onclick=hideAdd;

document.getElementById('btnPlus').onclick=showChooser;
document.getElementById('chooseNormal').onclick=()=>{ADD_TYPE='normal'; hideChooser(); showAdd();}
document.getElementById('chooseHot').onclick=()=>{ADD_TYPE='hot'; hideChooser(); showAdd();}

/* banner order window */
function openBannerOrder(){
  ADD_TYPE='banner';
  hideChooser();
  // подсказываем про размер
  alert('Розмір банера має бути 1200×200. Додайте зображення у формі + Опублікувати.');
  showAdd();
}
document.getElementById('bannerLink').onclick=(e)=>{ e.preventDefault(); openBannerOrder(); };

/* photos preview (max 5) */
let chosenFiles=[];
const fInput = document.getElementById('f_imgs');
const imgPh = document.getElementById('imgPh');
const phCnt = document.getElementById('phCnt');

function redrawPreview(){
  imgPh.innerHTML = chosenFiles.length
    ? chosenFiles.map(f=>`<img src="${URL.createObjectURL(f)}">`).slice(0,1).join('')
    : '';
  phCnt.textContent = `${chosenFiles.length}/5`;
}
document.getElementById('btnAddPhoto').onclick=()=>fInput.click();
imgPh.onclick=()=>fInput.click();
fInput.onchange=()=>{ chosenFiles=[...fInput.files].slice(0,5); redrawPreview(); };

/* publish -> сервер сохраняет; затем наше окно оплаты (Privat24) */
document.getElementById('btnPay').onclick=async ()=>{
  const fd=new FormData();
  fd.append('type', ADD_TYPE);
  fd.append('title', (document.getElementById('f_title').value||'Оголошення'));
  fd.append('price', (document.getElementById('f_price').value||0));
  fd.append('city', (document.getElementById('f_city').value||''));
  fd.append('region', (document.getElementById('f_region').value||''));
  fd.append('desc', (document.getElementById('f_desc').value||''));
  fd.append('phone', (document.getElementById('f_phone').value||'+380'));
  chosenFiles.slice(0,5).forEach(f=>fd.append('images',f));

  const j = await fetch(SERVER+'/api/create',{method:'POST',body:fd,headers:{'X-KOLO-UID':uidLocal}}).then(r=>r.json()).catch(()=>({}));
  if(!(j && j.ok)){ alert('Сервер недоступний'); return; }
  lastPublished = j; // {kind, code, amount, title}
  openPayBox(j.kind, j.code, j.amount);
  hideAdd();
};

/* search — сверху, без скролла страницы */
function showSearch(e){ if(e) e.preventDefault(); document.getElementById('searchBox').style.display='flex'; document.getElementById('q').focus({preventScroll:true}); disableScroll(); }
function hideSearch(){ document.getElementById('searchBox').style.display='none'; enableScroll(); }
document.getElementById('searchBox').addEventListener('click',e=>{ if(e.target.id==='searchBox') hideSearch(); });
document.getElementById('btnSearch').onclick=showSearch;
document.getElementById('go').onclick=()=>{ const k=(document.getElementById('q').value||'').toLowerCase(); hideSearch();
  if(!k){ fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>{ALL=j.data;draw();}); return; }
  const F=a=>(a.title+a.desc+a.city+a.region).toLowerCase().includes(k);
  const data={hot:(ALL.hot||[]).filter(F), normal:(ALL.normal||[]).filter(F)}; ALL=data; page=10; draw();
};

/* more */
document.getElementById('btnMore').onclick=()=>{ page++; draw(); };

/* SUPPORT */
document.getElementById('btnSupport').onclick=()=>{ document.getElementById('supportBox').style.display='flex'; disableScroll(); };
document.getElementById('closeSupport').onclick=()=>{ document.getElementById('supportBox').style.display='none'; enableScroll(); };
document.getElementById('s_send').onclick=async ()=>{
  const payload = {name:$('#s_name').value||'', phone:$('#s_phone').value||'', msg:$('#s_msg').value||''};
  await fetch(SERVER+'/api/support',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  alert('Дякуємо! Звернення надіслано.'); document.getElementById('supportBox').style.display='none'; enableScroll();
};

/* PAY BOX (Privat24) */
function openPayBox(kind, code, amount){
  const pb = document.getElementById('payBox');
  const lines = document.getElementById('payLines');
  const purp = (kind==='banner'?'Банер ':'') + (kind==='hot'?'HOT ':'Звичайне ') + 'оголошення №'+code;
  document.getElementById('purpose').textContent = purp;
  document.getElementById('amt').textContent = amount+' грн';
  lines.innerHTML = `Ваш номер оголошення: <b>№${code}</b> — виконайте оплату на вказану картку.`;
  pb.style.display='flex'; disableScroll();
}
document.getElementById('closePay').onclick=()=>{ document.getElementById('payBox').style.display='none'; enableScroll(); };
document.getElementById('purpose').onclick=async (e)=>{
  const txt = e.target.textContent; try{ await navigator.clipboard.writeText(txt); alert('Призначення скопійовано'); }catch{}
};
document.getElementById('goPrivat').onclick=async ()=>{
  if(!lastPublished) return;
  // логируем заказ
  await fetch(SERVER+'/api/order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(lastPublished)});
  window.open('https://www.privat24.ua/send/3g9dp','_blank');
};
</script>
</body>
</html>
