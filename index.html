<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KOLO ‚Äî –¥–æ—à–∫–∞ –æ–≥–æ–ª–æ—à–µ–Ω—å</title>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
  :root{
    --brand:#16a57b;
    --brand-dark:#0f7b5c;
    --hot:#ff5f5f;
    --hot2:#ff8a1e;
    --bg:#f5f7f6;
    --txt:#2c2c2c;
    --pill:#13b486;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family: 'Russo One', system-ui, Arial;}
  a{color:inherit;text-decoration:none}
  /* header */
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid #ececec}
  .wrap{max-width:1200px;margin:0 auto;padding:10px 16px}
  .row{display:flex;align-items:center;gap:12px}
  .logo{display:flex;align-items:center;gap:10px}
  .logo-badge{width:34px;height:34px;border-radius:50%;background:var(--brand);display:grid;place-items:center}
  .logo-badge span{display:block;width:28px;height:28px;border-radius:50%;border:2px solid #fff;display:grid;place-items:center;color:#fff;font-size:14px;letter-spacing:1px}
  .vis{background:var(--brand);color:#fff;border-radius:18px;padding:6px 12px;font-size:14px}
  .spacer{flex:1}
  .btn{display:inline-flex;align-items:center;justify-content:center;border:2px solid var(--brand);color:#fff;background:var(--brand);border-radius:12px;padding:8px 14px;cursor:pointer;transition:.2s}
  .btn:hover{transform:translateY(-1px)}
  .btn-ghost{background:#fff;color:var(--brand)}
  .add-btn{width:36px;height:36px;border-radius:12px}
  /* banner */
  #banner{max-width:1200px;margin:10px auto 0}
  #banner a, #banner img{display:block;width:100%;height:140px;object-fit:cover;border-radius:10px}
  /* stripes */
  .stripe{max-width:1200px;margin:10px auto;padding:10px 16px}
  .cap{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;color:#fff}
  .cap .dot{width:10px;height:10px;border-radius:50%;background:#fff}
  .cap.hot{background:linear-gradient(90deg,#ff5145, #ff8a1e)}
  .cap.new{background:var(--brand)}
  /* grid */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;max-width:1200px;margin:12px auto;padding:0 16px}
  @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)} #banner img{height:120px}}
  @media(max-width:640px){.grid{grid-template-columns:1fr} #banner img{height:100px}}
  .card{background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:14px;display:flex;flex-direction:column;gap:10px;min-height:160px;position:relative}
  .price{position:absolute;right:16px;bottom:12px;background:var(--brand);color:#fff;padding:6px 12px;border-radius:18px;font-size:14px}
  .badge-hot{position:absolute;top:12px;right:12px;background:#ff5f5f;color:#fff;border-radius:14px;padding:4px 8px;font-size:12px}
  .title{font-size:16px;color:#2c2c2c;opacity:.9}
  /* modal */
  dialog{border:none;border-radius:16px;width:min(960px,96vw);padding:0;box-shadow:0 30px 70px rgba(0,0,0,.35)}
  dialog::backdrop{background:rgba(0,0,0,.55)} /* —Ç–µ–º–Ω–µ–µ */
  .detail{background:#fff;border-radius:16px;overflow:hidden}
  .d-head{display:flex;align-items:center;gap:12px;justify-content:flex-end;padding:10px 14px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);color:#fff;border-radius:16px;padding:6px 10px;font-size:14px}
  .gallery{position:relative;background:#f1f5f4}
  .gallery img{display:block;width:100%;max-height:540px;object-fit:cover;transition:opacity .25s ease}
  .g-nav{position:absolute;top:50%;transform:translateY(-50%);display:flex;justify-content:space-between;left:10px;right:10px;pointer-events:none}
  .g-btn{pointer-events:all;background:var(--brand);color:#fff;border:none;border-radius:10px;width:42px;height:42px;font-size:18px;display:grid;place-items:center;cursor:pointer}
  .g-count{position:absolute;right:12px;bottom:12px;background:rgba(0,0,0,.55);color:#fff;font-size:12px;border-radius:12px;padding:4px 8px}
  .d-body{padding:14px;display:grid;gap:10px}
  .meta{display:flex;flex-wrap:wrap;gap:10px}
  .chip{background:var(--brand);color:#fff;border-radius:14px;padding:6px 10px;font-size:14px}
  .btn-like{background:var(--pill);color:#fff;border:none;border-radius:12px;padding:8px 14px;cursor:pointer}
  /* chooser & form */
  #chooser dialog,#addForm dialog{max-width:560px}
  .sheet{background:#fff;border-radius:16px;padding:14px}
  .field{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:12px 12px;width:100%;font-size:16px}
  .field::placeholder{color:#e9fffa}
  .filebox{background:#e7f6f1;border-radius:12px;height:160px;display:grid;place-items:center;margin-bottom:10px;overflow:hidden}
  .filebox img{max-height:160px}
  .fab{position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:16px;background:var(--brand);color:#fff;display:grid;place-items:center;font-size:26px;cursor:pointer;box-shadow:0 10px 25px rgba(0,0,0,.18)}
  .more{display:grid;place-items:center;margin:18px 0}
  .more .btn-ghost{font-size:16px}
</style>
</head>
<body>
  <div id="splash" class="wrap" style="display:none"></div>

  <header>
    <div class="wrap row">
      <div class="logo">
        <div class="logo-badge"><span>KOLO</span></div>
        <div id="vis" class="vis">27369 –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤</div>
      </div>
      <div class="spacer"></div>
      <button id="addBtn" class="btn add-btn">+</button>
      <button id="searchBtn" class="btn">–ü–û–®–£–ö</button>
    </div>
  </header>

  <div id="banner" class="wrap"></div>

  <section class="stripe">
    <div class="cap hot"><div class="dot"></div>–¢–û–ü –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π</div>
  </section>
  <div id="hotGrid" class="grid"></div>

  <section class="stripe">
    <div class="cap new"><div class="dot"></div>–ù–æ–≤—ñ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</div>
  </section>
  <div id="normGrid" class="grid"></div>

  <div class="more"><button id="moreBtn" class="btn btn-ghost">–ü–æ–∫–∞–∑–∞—Ç–∏ —â–µ</button></div>

  <footer class="wrap" style="text-align:center;margin:24px auto 40px;color:#6e6e6e">¬© KOLO, 2025<br/>–î–æ—à–∫–∞ –æ–≥–æ–ª–æ—à–µ–Ω—å ‚Ññ1 –≤ –£–∫—Ä–∞—ó–Ω—ñ</footer>

  <!-- DETAIL -->
  <dialog id="dlgDetail">
    <div class="detail">
      <div class="d-head">
        <div class="pill" id="pillViews">üëÅ 0</div>
        <div class="pill" id="pillLikes">‚ù§ 0</div>
      </div>
      <div class="gallery">
        <img id="gImg" src="" alt="">
        <div class="g-nav">
          <button class="g-btn" id="gPrev"><</button>
          <button class="g-btn" id="gNext">></button>
        </div>
        <div class="g-count" id="gCount">1/1</div>
      </div>
      <div class="d-body">
        <div class="title" id="dTitle">–û–ì–û–õ–û–®–ï–ù–ù–Ø</div>
        <div class="meta">
          <div class="chip" id="dNum">‚Ññ -----</div>
          <div class="chip" id="dPhone">–ù–æ–º–µ—Ä: +380</div>
          <div class="chip" id="dCity">–º—ñ—Å—Ç–æ: -</div>
          <div class="chip" id="dRegion">–æ–±–ª–∞—Å—Ç—å: -</div>
          <div class="chip" id="dDate">–¥–∞—Ç–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó: -</div>
        </div>
        <div class="chip" id="dDesc" style="background:#14b48a;width:100%">–û–ø–∏—Å</div>
        <button class="btn-like" id="btnLike">‚ù§ –ü–æ–¥–æ–±–∞—î—Ç—å—Å—è</button>
        <div class="price" id="dPrice" style="position:static;align-self:flex-end">0 ‚Ç¥</div>
      </div>
    </div>
  </dialog>

  <!-- CHOOSER -->
  <dialog id="chooser">
    <div class="sheet">
      <div class="row" style="gap:10px">
        <button data-type="normal" class="btn" style="flex:1">–ó–≤–∏—á–∞–π–Ω–µ</button>
        <button data-type="hot" class="btn" style="flex:1;background:linear-gradient(90deg,#ff5145,#ff8a1e)">HOT</button>
        <button data-type="banner" class="btn btn-ghost" style="flex:1">–ó–∞–º–æ–≤–∏—Ç–∏ —Ä–µ–∫–ª–∞–º—É</button>
      </div>
    </div>
  </dialog>

  <!-- ADD FORM -->
  <dialog id="addForm">
    <form class="sheet" id="frmAdd">
      <div class="title" style="margin-bottom:6px">–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</div>
      <div class="filebox"><img id="preview" alt=""></div>
      <input type="file" id="images" accept="image/*" multiple style="margin-bottom:10px"/>
      <input class="field" id="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required style="margin-top:6px">
      <div class="row" style="gap:10px;margin-top:6px">
        <input class="field" id="price" placeholder="–¶—ñ–Ω–∞, –≥—Ä–Ω" style="flex:1">
        <input class="field" id="city" placeholder="–ú—ñ—Å—Ç–æ" style="flex:1">
      </div>
      <div class="row" style="gap:10px;margin-top:6px">
        <input class="field" id="region" placeholder="–û–±–ª–∞—Å—Ç—å" style="flex:1">
        <input class="field" id="phone" placeholder="+380" style="flex:1" value="+380">
      </div>
      <textarea class="field" id="desc" placeholder="–û–ø–∏—Å" rows="4" style="margin-top:6px"></textarea>
      <button class="btn" id="btnPublish" style="width:100%;margin-top:10px">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </form>
  </dialog>

  <div class="fab" id="fab">+</div>

<script>
const API_BASE = 'https://buddy-unity-eye-breakdown.trycloudflare.com'; // <<< –ü–û–î–ú–ï–ù–ò –ù–ê –°–í–û–ô –¢–£–ù–ù–ï–õ–¨. –î–ª—è –ª–æ–∫–∞–ª–∏: 'http://127.0.0.1:8000'
const socket = io(API_BASE, { transports:['websocket'], auth:{ uid: uid() } });

/* ---------- small utils ---------- */
function uid(){
  let u = localStorage.getItem('k_uid');
  if(!u){ u = 'u_'+Math.random().toString(36).slice(2,12); localStorage.setItem('k_uid',u);}
  return u;
}
const $ = sel => document.querySelector(sel);
const fmt = n => (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,' ');
const qs = (node,sel)=>node.querySelector(sel);

let ALL = {hot:[], normal:[]};
let SHOW_N = 6; // —Å–∫–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞
let cur = { ad:null, idx:0 };

/* ---------- sockets ---------- */
socket.on('visitors', n => { $('#vis').textContent = `${fmt(n)} –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤`; });
socket.on('banner', b => renderBanner(b));
socket.on('listings', data => { ALL=data; renderGrids(); });

/* ---------- initial fetch (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä—è–º–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è) ---------- */
fetch(`${API_BASE}/api/list`)
  .then(r=>r.json())
  .then(x=>{
    ALL = x.data; renderBanner(x.banner); renderGrids();
  });

/* ---------- banner ---------- */
function renderBanner(b){
  const box = $('#banner'); box.innerHTML='';
  if(!b || !b.enabled) return;
  const imgs = (b.images && b.images.length ? b.images : [b.image]);
  let i=0;
  const img = document.createElement('img');
  img.src = imgs[0];
  const a = document.createElement('a');
  a.href = b.link || '#'; a.target='_blank'; a.appendChild(img);
  box.appendChild(a);
  if(imgs.length>1){
    setInterval(()=>{ i=(i+1)%imgs.length; img.src=imgs[i]; },5000);
  }
}

/* ---------- grids ---------- */
function card(ad){
  const el = document.createElement('div');
  el.className='card';
  el.innerHTML = `
    <div class="badge-hot" ${ad.type==='hot'?'':'style="display:none"'}>HOT</div>
    <div class="title">${ad.title || '–û–ì–û–õ–û–®–ï–ù–ù–Ø'}</div>
    <div style="background:#eaf7f3;border-radius:12px;flex:1;display:grid;place-items:center;color:#87b4a3">–ö–ê–†–¢–ò–ù–ö–ê –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</div>
    <div class="price">${fmt(ad.price)} ‚Ç¥</div>
  `;
  el.onclick = ()=>openDetail(ad,0);
  return el;
}
function renderGrids(){
  const h = $('#hotGrid'); const n = $('#normGrid');
  h.innerHTML=''; n.innerHTML='';
  ALL.hot.forEach(ad=>h.appendChild(card(ad)));
  ALL.normal.slice(0,SHOW_N).forEach(ad=>n.appendChild(card(ad)));
}
$('#moreBtn').onclick = ()=>{ SHOW_N+=6; renderGrids(); };

/* ---------- detail ---------- */
function openDetail(ad, i){
  cur.ad = ad; cur.idx=i||0;
  $('#dTitle').textContent = ad.title || '–û–ì–û–õ–û–®–ï–ù–ù–Ø';
  $('#dPhone').textContent = '–ù–æ–º–µ—Ä: '+(ad.phone||'+380');
  $('#dCity').textContent = '–º—ñ—Å—Ç–æ: '+(ad.city||'-');
  $('#dRegion').textContent = '–æ–±–ª–∞—Å—Ç—å: '+(ad.region||'-');
  $('#dDate').textContent = '–¥–∞—Ç–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó: '+(new Date(ad.activeTill- (ad.type==='hot'?7:30)*86400000)).toLocaleDateString('uk-UA');
  $('#dPrice').textContent = `${fmt(ad.price)} ‚Ç¥`;
  $('#dNum').textContent = `‚Ññ ${ad.num||'-----'}`;
  $('#pillViews').textContent = `üëÅ ${fmt(ad.views||0)}`;
  $('#pillLikes').textContent = `‚ù§ ${fmt(ad.likes||0)}`;
  renderGallery();
  $('#dlgDetail').showModal();
  // –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
  fetch(`${API_BASE}/api/view/${ad.id}`,{method:'POST',headers:{'X-KOLO-UID':uid()}});
}
// –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –ø–æ —Ñ–æ–Ω—É
['dlgDetail','chooser','addForm'].forEach(id=>{
  const d = $('#'+id);
  d.addEventListener('click', (e)=>{ if(e.target===d) d.close(); });
});
function renderGallery(){
  const ad = cur.ad;
  const imgs = ad.images||[];
  const idx = ((cur.idx%imgs.length)+imgs.length)%imgs.length;
  cur.idx = idx;
  $('#gImg').style.opacity=0.2;
  setTimeout(()=>{ $('#gImg').src = imgs[idx]; $('#gImg').style.opacity=1; },50);
  $('#gCount').textContent = `${idx+1}/${imgs.length}`;
}
$('#gPrev').onclick = ()=>{ cur.idx--; renderGallery(); };
$('#gNext').onclick = ()=>{ cur.idx++; renderGallery(); };
$('#btnLike').onclick = ()=>{
  fetch(`${API_BASE}/api/like/${cur.ad.id}`, {method:'POST',headers:{'X-KOLO-UID':uid()}})
    .then(r=>r.json()).then(x=>{
      $('#pillLikes').textContent = `‚ù§ ${fmt(x.likes||0)}`;
    });
};

/* ---------- chooser & add ---------- */
const chooser = $('#chooser');
$('#addBtn').onclick = ()=> chooser.showModal();
$('#fab').onclick = ()=> chooser.showModal();

let publishType = 'normal';
chooser.querySelectorAll('button').forEach(b=>{
  b.onclick = ()=>{
    publishType = b.dataset.type || 'normal';
    chooser.close();
    $('#addForm').showModal();
  };
});

const imgInput = $('#images');
const preview = $('#preview');
imgInput.onchange = ()=>{
  const f = imgInput.files?.[0];
  if(f){
    const r = new FileReader();
    r.onload = e => { preview.src=e.target.result; };
    r.readAsDataURL(f);
  }
};

// publish
$('#frmAdd').addEventListener('submit', (e)=>{
  e.preventDefault();
  const fd = new FormData();
  const fs = Array.from(imgInput.files||[]).slice(0,5);
  fs.forEach(f=>fd.append('images', f));
  fd.append('type', publishType);
  fd.append('title',$('#title').value);
  fd.append('price',$('#price').value);
  fd.append('city',$('#city').value);
  fd.append('region',$('#region').value);
  fd.append('phone',$('#phone').value);
  fd.append('desc',$('#desc').value);
  fetch(`${API_BASE}/pay/start`, {method:'POST', body:fd, headers:{'X-KOLO-UID':uid()}})
    .then(r=>r.json())
    .then(x=>{
      if(x && x.payment_url){ window.open(x.payment_url, '_blank'); }
      $('#addForm').close();
      // –ø–æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
      $('#frmAdd').reset(); preview.src='';
    })
    .catch(()=>$('#addForm').close());
});

/* ---------- search button (—Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª) ---------- */
$('#searchBtn').onclick = ()=> alert('–ü–æ—à—É–∫: –≤–≤–µ–¥—ñ—Ç—å –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ —É –∑–∞–≥–æ–ª–æ–≤–∫—É ‚Äî —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ñ—ñ–ª—å—Ç—Ä–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –º–æ–∂–µ –±—É—Ç–∏ –¥–æ–¥–∞–Ω–∞ —Ç—É—Ç.');

</script>
</body>
</html>
