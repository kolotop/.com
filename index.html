<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>KOLO — дошка оголошень</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#10b981">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%2310b981'/%3E%3Ccircle cx='50' cy='50' r='40' fill='none' stroke='%23fff' stroke-width='6'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-family='Montserrat,Arial' font-size='30' font-weight='800' fill='%23fff'%3EKOLO%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
<style>
:root{--g:#10b981;--g2:#0b7d60;--r:#e94251;--txt:#0b1720;--b:2px}
*{box-sizing:border-box} html,body{margin:0;padding:0;font-family:Montserrat,system-ui,Arial;background:#f5f7f6;color:var(--txt)}
a{color:inherit;text-decoration:none} .wrap{max-width:1140px;margin:0 auto;padding:10px 14px}

/* splash */
#splash{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:60}
.loader{position:relative;width:200px;height:200px;border-radius:50%;border:12px solid #e6faf2;border-top-color:var(--g);animation:spin 1s linear infinite}
.loader span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--g);font-size:34px}
@keyframes spin{to{transform:rotate(360deg)}}

/* header */
header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #e8f2ef}
.topbar{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center}
.logo{display:flex;align-items:center;gap:10px}
.logo svg{width:36px;height:36px}
.pill{background:var(--g);color:#fff;border-radius:12px;padding:8px 14px;font-weight:800;font-size:13px}
.btn{border:none;background:var(--g);color:#fff;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer}
.btn.plus{background:#fff;color:var(--g);border:3px solid var(--g);width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
.banner{margin:8px 0;border-top:1px solid #e8f2ef;border-bottom:1px solid #e8f2ef;padding:6px 0}
.banner img{width:100%;height:200px;object-fit:cover;border-radius:6px}
.banner .adlink{display:block;text-align:right;font-size:12px;color:#2b7;margin-top:4px}

/* section tags */
.hsec{display:inline-block;background:#e83b3b;color:#fff;padding:8px 14px;border-radius:8px;font-weight:800;margin:12px 0}
.hsec.green{background:var(--g)}

/* grid */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
@media(min-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{border:var(--b) solid var(--g);border-radius:12px;background:#fff;padding:10px;position:relative;cursor:pointer}
.badge-hot{position:absolute;right:10px;top:10px;background:var(--r);color:#fff;font-weight:800;border-radius:8px;padding:4px 10px;font-size:12px}
.card .title{font-weight:800;margin:2px 0 8px}
.card .ph{border:var(--b) solid var(--g);border-radius:8px;height:150px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#000;background:#fff}
.priceBtn{position:absolute;right:16px;bottom:14px;background:var(--g);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-weight:800}

/* detail */
dialog{border:none;border-radius:12px;padding:0;width:96%;max-width:820px}
#modalBox{border:var(--b) solid var(--g);border-radius:12px;background:#fff;overflow:hidden;position:relative}
.closeX{position:absolute;right:10px;top:10px;background:#fff;border:var(--b) solid var(--g);border-radius:10px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--g);cursor:pointer}
.modHead{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:var(--b) solid var(--g)}
.modTitle{font-weight:800;flex:1}
.stat{display:inline-flex;align-items:center;gap:6px;background:var(--g);color:#fff;font-weight:800;border-radius:10px;padding:2px 8px;font-size:13px}
.stat svg{width:16px;height:16px;fill:#fff}
.carousel{position:relative;border-bottom:var(--b) solid var(--g);background:#fff}
.carousel img{width:100%;max-height:420px;object-fit:contain;background:#fff}
.navbtn{position:absolute;top:50%;transform:translateY(-50%);background:#fff;color:var(--g);border:var(--b) solid var(--g);font-weight:900;border-radius:8px;width:38px;height:32px;display:flex;align-items:center;justify-content:center}
.navbtn.left{left:10px}.navbtn.right{right:10px}
.modPrice{display:flex;justify-content:flex-end;padding:12px 14px}
.modBody{padding:14px;border-top:var(--b) solid var(--g)}
.blockTitle{background:var(--g);color:#fff;border-radius:10px;padding:16px;text-align:center;font-weight:800;margin-bottom:12px}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{background:var(--g);color:#fff;border-radius:10px;padding:8px 12px;font-weight:800}

/* chooser & add form */
#chooser,#addForm,#searchBox{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
.chooseBox{width:90%;max-width:420px;background:#fff;border:var(--b) solid var(--g);border-radius:12px;padding:24px;display:flex;flex-direction:column;gap:14px;align-items:center}
.chooseBtn{width:100%;padding:16px;border:none;font-weight:800;border-radius:10px;cursor:pointer}
.chooseBtn.green{background:var(--g);color:#fff}
.chooseBtn.red{background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff}
.formBox{width:92%;max-width:560px;background:#fff;border:var(--b) solid var(--g);border-radius:12px;padding:16px;position:relative}
.formTop{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.badgeSmall{background:var(--g);color:#fff;border-radius:8px;padding:6px 10px;font-weight:800}
.imagePh{border:var(--b) solid var(--g);border-radius:8px;height:220px;display:flex;align-items:center;justify-content:center;font-weight:800;margin:8px 0;overflow:hidden}
.imagePh img{width:100%;height:100%;object-fit:contain;background:#fff}
.inp{background:var(--g);color:#fff;border:none;border-radius:10px;padding:12px 14px;width:100%;font-weight:800;margin-top:10px}
::placeholder{color:#eaff}
.inprow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btnPub{width:100%;margin-top:14px;border-radius:10px}

/* search overlay */
.searchInner{background:#fff;border:var(--b) solid var(--g);border-radius:12px;padding:12px;width:92%;max-width:560px;display:flex;gap:8px}
.searchInner input{flex:1;border:var(--b) solid var(--g);border-radius:10px;padding:12px 14px;font-weight:800}

/* footer */
footer{border-top:1px solid #e8f2ef;padding:18px 0;margin-top:20px;color:#0b1720a0;text-align:center}
.tagline{font-weight:800;margin-top:6px}

/* responsive tweaks */
@media(max-width:420px){.card .ph{height:130px}}
</style>
</head>
<body>
<!-- splash -->
<div id="splash"><div class="loader"><span>KOLO</span></div></div>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <!-- svg logo (текст не вылазит) -->
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="48" fill="#10b981"/>
          <circle cx="50" cy="50" r="40" fill="none" stroke="#fff" stroke-width="6"/>
          <text x="50" y="60" font-size="28" font-weight="800" text-anchor="middle" fill="#fff" font-family="Montserrat,Arial">KOLO</text>
        </svg>
      </div>
      <div><span id="visitors" class="pill">27369 відвідувачів</span></div>
      <button class="btn plus" id="btnPlus">+</button>
      <button class="btn" id="btnSearch">ПОШУК</button>
    </div>
    <div class="banner">
      <img id="bannerImg" src="https://picsum.photos/seed/kolo-banner/1200/200" alt="banner">
      <a href="#" id="bannerLink" class="adlink">Замовити рекламу</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="hsec">ТОП пропозицій</div>
  <div id="hotGrid" class="grid"></div>

  <div class="hsec green" style="margin-top:22px">Нові оголошення</div>
  <div id="listGrid" class="grid"></div>
  <div style="display:flex;justify-content:center;margin:18px 0"><button id="btnMore" class="btn" style="background:#fff;color:var(--g);border:var(--b) solid var(--g)">Показати ще</button></div>
</main>

<footer>
  <div>© KOLO, 2025</div>
  <div class="tagline">Дошка оголошень №1 в Україні</div>
</footer>

<!-- DETAIL -->
<dialog id="dlgDetail">
  <div id="modalBox">
    <div class="closeX" onclick="document.getElementById('dlgDetail').close()">✕</div>
    <div class="modHead">
      <div class="modTitle" id="modTitle">ОГОЛОШЕННЯ</div>
      <div class="stat" id="modViews">
        <svg viewBox="0 0 24 24"><path d="M12 5C5 5 1 12 1 12s4 7 11 7 11-7 11-7-4-7-11-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg><b id="vNum">0</b>
      </div>
      <div class="stat" id="modLikes" style="margin-left:6px">
        <svg viewBox="0 0 24 24"><path d="M12 21s-7.5-4.35-10-8.5C.5 8.5 3 5 6.5 5 8.7 5 10 6.2 12 8c2-1.8 3.3-3 5.5-3C21 5 23.5 8.5 22 12.5 19.5 16.7 12 21 12 21Z"/></svg><b id="lNum">0</b>
      </div>
    </div>
    <div class="carousel">
      <button class="navbtn left" onclick="car(-1)">&lt;</button>
      <div id="carImgs"></div>
      <button class="navbtn right" onclick="car(1)">&gt;</button>
    </div>
    <div class="modPrice"><button class="btn" id="btnCall">Ціна</button></div>
    <div class="modBody">
      <div class="blockTitle">ОПИСАННЯ</div>
      <div id="modDesc" style="margin-bottom:12px;white-space:pre-wrap"></div>
      <div class="chips" id="chips"></div>
      <div style="margin-top:12px"><button class="btn" id="btnLike">❤ Подобається</button></div>
    </div>
  </div>
</dialog>

<!-- CHOOSER -->
<div id="chooser"><div class="chooseBox">
  <button class="chooseBtn green" id="chooseNormal">Звичайне оголошення — 39 грн / 30 днів</button>
  <button class="chooseBtn red" id="chooseHot">HOT оголошення — 299 грн / 7 днів</button>
  <button class="chooseBtn" id="chooseBanner" style="background:#fff;border:var(--b) solid var(--g);color:var(--g)">Банер — 999 грн / 7 днів</button>
</div></div>

<!-- ADD FORM -->
<div id="addForm"><div class="formBox">
  <div class="closeX" onclick="hideAdd()">✕</div>
  <div class="formTop">
    <div class="badgeSmall">Додати фото</div>
    <div id="hotBadge" class="badgeSmall" style="background:#e94251;display:none">HOT</div>
  </div>
  <div class="imagePh" id="imgPh"><span>КАРТИНКА оголошення</span></div>
  <input class="inp" id="f_title" placeholder="Заголовок">
  <div class="inprow">
    <input class="inp" id="f_price" placeholder="Ціна, грн">
    <input class="inp" id="f_city" placeholder="Місто">
  </div>
  <div class="inprow">
    <input class="inp" id="f_region" placeholder="Область">
    <input class="inp" id="f_phone" value="+380" placeholder="+380">
  </div>
  <textarea class="inp" id="f_desc" placeholder="Опис" rows="4" style="height:110px"></textarea>
  <input type="file" id="f_imgs" accept="image/*" multiple hidden>
  <button class="btn btnPub" id="btnPay">Сплатити (демо)</button>
</div></div>

<!-- SEARCH OVERLAY -->
<div id="searchBox"><div class="searchInner">
  <input id="q" placeholder="Ключові слова... (заголовок, опис, місто, область)">
  <button class="btn" id="go">Пошук</button>
  <div class="closeX" onclick="hideSearch()" style="position:static">✕</div>
</div></div>

<!-- CHAT -->
<div id="chatFab" style="position:fixed;right:14px;bottom:14px;background:#fff;border:3px solid var(--g);color:var(--g);width:56px;height:56px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-weight:900;cursor:pointer;z-index:55">💬</div>
<div id="chatBox" style="position:fixed;right:14px;bottom:84px;width:320px;max-height:60vh;background:#fff;border:var(--b) solid var(--g);border-radius:12px;overflow:hidden;display:none;flex-direction:column;z-index:55">
  <div style="padding:8px 10px;border-bottom:var(--b) solid var(--g);font-weight:800">Онлайн-чат</div>
  <div id="msgs" style="padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px"></div>
  <div style="display:flex;gap:8px;padding:8px;border-top:var(--b) solid var(--g)">
    <input id="msg" placeholder="Ваше повідомлення..." style="flex:1;border:var(--b) solid var(--g);border-radius:10px;padding:8px 10px;font-weight:800">
    <button class="btn" id="send">OK</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
<script>
const SERVER = localStorage.getItem('kolo_server_url') || 'https://roll-experimental-third-tiger.trycloudflare.com';
setTimeout(()=>document.getElementById('splash').style.display='none', 5000);

const $ = s=>document.querySelector(s);
const socket = io(SERVER, {transports:['websocket'], auth:{uid: localStorage.getItem('kolo_uid')||''}});
const ME = localStorage.getItem('kolo_uid') || (localStorage.setItem('kolo_uid','u_'+Math.random().toString(36).slice(2)), localStorage.getItem('kolo_uid'));
let ALL={hot:[],normal:[]}, page=1, ADD_TYPE='normal', CAR=[], idx=0, CUR=null;

// socket handlers
socket.on('visitors', n=>$('#visitors').textContent = n+' відвідувачів');
socket.on('banner', b=>{ if(b && b.enabled){ $('#bannerImg').src=b.image; $('#bannerLink').href=b.link||'#'; }});
socket.on('listings', d=>{ ALL=d; page=1; draw(); });
socket.on('chat', m=>addMsg((m.from==='admin'?'Адмін':'Користувач')+' #'+m.id, m.text, m.from==='admin'?'other':'me'));
socket.on('payresult', m=>{ if(m.uid===ME){ alert('Оплата (демо) успішна!'); hideAdd(); }});

// render
function mkCard(ad){ return `<div class="card" onclick="openDetail('${ad.id}')">
  ${ad.type==='hot'?'<div class="badge-hot">HOT</div>':''}
  <div class="title">ЗАГОЛОВОК</div>
  <div class="ph">КАРТИНКА оголошення</div>
  <button class="priceBtn">Ціна</button>
</div>`;}
function draw(){
  $('#hotGrid').innerHTML = ALL.hot.map(mkCard).join('');
  const slice = ALL.normal.slice(0,page*6);
  $('#listGrid').innerHTML = slice.map(mkCard).join('');
  $('#btnMore').style.display = ALL.normal.length>slice.length ? 'inline-block':'none';
}

// detail
window.openDetail = (id)=>{
  CUR = [...ALL.hot,...ALL.normal].find(a=>a.id===id); if(!CUR) return;
  $('#modTitle').textContent = CUR.title.toUpperCase();
  $('#vNum').textContent = CUR.views||0; $('#lNum').textContent = CUR.likes||0;
  $('#modDesc').textContent = CUR.desc||'';
  $('#chips').innerHTML = [
    'Номер: '+(CUR.phone||'+380'),
    'місто: '+(CUR.city||'-'),
    'область: '+(CUR.region||'-'),
    'дата публікації: '+(new Date().toLocaleDateString('uk-UA')),
  ].map(t=>`<div class="chip">${t}</div>`).join('');
  $('#btnCall').onclick=()=>location.href='tel:'+(CUR.phone||'');
  CAR = (CUR.images&&CUR.images.length)?CUR.images:['https://picsum.photos/seed/1/1000/700']; idx=0; renderCar();
  document.getElementById('dlgDetail').showModal();
  fetch(SERVER+`/api/view/${CUR.id}`,{method:'POST',headers:{'X-KOLO-UID':ME}});
};
function renderCar(){ $('#carImgs').innerHTML = `<img src="${CAR[idx]}" alt="">`; }
window.car = d=>{ idx=(idx+d+CAR.length)%CAR.length; renderCar(); };
document.getElementById('btnLike').onclick = async ()=>{
  if(!CUR) return;
  const j = await fetch(SERVER+`/api/like/${CUR.id}`,{method:'POST',headers:{'X-KOLO-UID':ME}}).then(r=>r.json());
  if(j && j.likes!==undefined){ $('#lNum').textContent=j.likes; }
};

// chooser/add form
function showChooser(){ $('#chooser').style.display='flex'; }
function hideChooser(){ $('#chooser').style.display='none'; }
function showAdd(){ $('#addForm').style.display='flex'; $('#hotBadge').style.display = ADD_TYPE==='hot'?'inline-block':'none'; }
function hideAdd(){ $('#addForm').style.display='none'; }
$('#btnPlus').onclick=showChooser;
$('#chooseNormal').onclick=()=>{ADD_TYPE='normal'; hideChooser(); showAdd();}
$('#chooseHot').onclick=()=>{ADD_TYPE='hot'; hideChooser(); showAdd();}
$('#chooseBanner').onclick=()=>{ hideChooser(); ADD_TYPE='banner'; showAdd(); $('#f_price').value=999; $('#f_city').value=''; $('#f_region').value=''; $('#f_title').value='Рекламний банер';};
$('#imgPh').onclick=()=>$('#f_imgs').click();
$('#f_imgs').onchange=()=>{ const f=$('#f_imgs').files[0]; if(f){ const u=URL.createObjectURL(f); $('#imgPh').innerHTML=`<img src="${u}">`; } };

$('#btnPay').onclick=async ()=>{
  const fd=new FormData();
  fd.append('type', ADD_TYPE);
  fd.append('title', ($('#f_title').value||'Оголошення'));
  fd.append('price', ($('#f_price').value||0));
  fd.append('city', ($('#f_city').value||''));
  fd.append('region', ($('#f_region').value||''));
  fd.append('desc', ($('#f_desc').value||''));
  fd.append('phone', ($('#f_phone').value||'+380'));
  for(const f of $('#f_imgs').files) fd.append('images',f);
  const j = await fetch(SERVER+'/pay/start',{method:'POST',body:fd,headers:{'X-KOLO-UID':ME}}).then(r=>r.json()).catch(()=>({}));
  if(j && j.status==='ok'){ /* сервер вышлет payresult */ } else { alert('Сервер недоступний'); }
};

// search
function showSearch(){ $('#searchBox').style.display='flex'; $('#q').focus(); }
function hideSearch(){ $('#searchBox').style.display='none'; }
$('#btnSearch').onclick=showSearch;
$('#go').onclick=()=>{ const k=($('#q').value||'').toLowerCase(); hideSearch(); if(!k){ draw(); return; }
  const F=a=>(a.title+a.desc+a.city+a.region).toLowerCase().includes(k);
  const data={hot:ALL.hot.filter(F), normal:ALL.normal.filter(F)}; ALL=data; page=10; draw();
  // подгрузим назад оригинальные
  fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>ALL=j.data);
};

// чат
function addMsg(who,text,cls){
  const d=document.createElement('div'); d.style.padding='8px 10px'; d.style.borderRadius='10px';
  d.style.background = cls==='me' ? '#e8fff5' : '#f3f4f6'; d.textContent=who+': '+text;
  const m=$('#msgs'); m.appendChild(d); m.scrollTop=99999;
}
$('#chatFab').onclick=()=>{ const b=$('#chatBox'); b.style.display = b.style.display==='flex' ? 'none':'flex'; };
$('#send').onclick=()=>{ const v=$('#msg').value.trim(); if(!v) return; $('#msg').value=''; socket.emit('chat',{from:'user',uid:ME,text:v}); addMsg('Я',v,'me'); };

// more
$('#btnMore').onclick=()=>{ page++; draw(); };

// init
fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>{ ALL=j.data; draw(); });
</script>
</body>
</html>
