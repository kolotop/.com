<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>KOLO — дошка оголошень</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#10b981">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%2310b981'/%3E%3Ccircle cx='50' cy='50' r='40' fill='none' stroke='%23fff' stroke-width='6'/%3E%3Ctext x='50' y='58' text-anchor='middle' font-family='Russo One,Arial' font-size='22' fill='%23fff'%3EKOLO%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
<style>
:root{--g:#10b981;--r:#e94251;--txt:#0b1720}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:'Russo One',Arial,system-ui;background:#f5f7f6;color:var(--txt);-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none}
.wrap{max-width:1140px;margin:0 auto;padding:10px 14px}

/* splash */
#splash{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:60}
.loader{position:relative;width:220px;height:220px;border-radius:50%;border:12px solid #e6faf2;border-top-color:var(--g);animation:spin 1s linear infinite}
.loader span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--g);font-size:38px}
@keyframes spin{to{transform:rotate(360deg)}}

/* header */
header{position:sticky;top:0;z-index:40;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.topbar{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center}
.logo svg{width:36px;height:36px}
.pill{background:var(--g);color:#fff;border-radius:12px;padding:8px 14px;font-size:13px}
.btn{border:none;background:var(--g);color:#fff;border-radius:12px;padding:10px 16px;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,.25);font-family:inherit}
.btn.plus{background:#fff;color:var(--g);border:3px solid var(--g);width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:none}

/* banner */
.banner{margin:8px 0;overflow:hidden;transition:max-height .35s ease, opacity .35s ease;max-height:170px}
.banner img{width:100%;height:160px;object-fit:cover;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.08)}
.banner.min{max-height:70px;opacity:.95}

/* sections */
.hsec{display:flex;align-items:center;gap:8px;color:#fff;padding:8px 14px;border-radius:12px;margin:12px 0;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.hsec svg{width:18px;height:18px;fill:#fff}
.hsec.top{background:linear-gradient(90deg,#ff4d4d,#ff7a1a)}
.hsec.new{background:var(--g)}

/* cards */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
@media(min-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{background:#fff;border-radius:16px;padding:12px;position:relative;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06);transition:transform .12s ease}
.card:hover{transform:translateY(-2px)}
.badge-hot{position:absolute;right:12px;top:12px;background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff;border-radius:12px;padding:4px 10px;font-size:12px}
.card .ph{border-radius:10px;height:150px;display:flex;align-items:center;justify-content:center;background:#eefaf5;color:#6cc8a8;overflow:hidden}
.card .ph img{width:100%;height:100%;object-fit:cover}
.card .ttl{margin-top:10px;line-height:1.1;font-size:14px}
.priceBtn{position:absolute;right:16px;bottom:14px;background:var(--g);color:#fff;border:none;border-radius:16px;padding:8px 16px;box-shadow:0 8px 18px rgba(16,185,129,.25);font-family:inherit}

/* modal */
.pillStat{display:inline-flex;align-items:center;gap:8px;border-radius:18px;padding:6px 10px;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.pillStat svg{width:16px;height:16px}
.pillStat.green{background:var(--g);color:#fff}
.pillStat.green svg{fill:#fff}
.pillStat b{font-family:inherit}
dialog{border:none;border-radius:16px;padding:0;width:96%;max-width:980px}
dialog::backdrop{background:rgba(0,0,0,.68)}
#modalBox{border-radius:16px;background:#fff;overflow:hidden;position:relative;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.modHead{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #edf3f0}
.modTitle{flex:1}
.carousel{position:relative;border-bottom:1px solid #edf3f0;background:#fff}
#carStage{position:relative;height:520px;max-height:52vh}
#carStage img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity .25s ease}
#carStage img.show{opacity:1}
.navbtn{position:absolute;top:50%;transform:translateY(-50%);background:var(--g);color:#fff;border:none;border-radius:10px;width:38px;height:32px;display:flex;align-items:center;justify-content:center}
.navbtn.left{left:10px}.navbtn.right{right:10px}
#carCount{position:absolute;right:10px;bottom:10px;background:#000b;color:#fff;border-radius:10px;padding:4px 8px;font-size:12px}
.modPrice{display:flex;justify-content:flex-end;padding:12px 14px}
.modBody{padding:14px}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{background:#eefaf5;color:#0b1720;border-radius:12px;padding:10px 12px}

/* chooser/add/search */
#chooser,#addForm,#searchBox{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
.chooseBox{position:relative;width:90%;max-width:420px;background:#fff;border-radius:16px;padding:24px;display:flex;flex-direction:column;gap:14px;align-items:center;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.chooseBtn{width:100%;padding:16px;border:none;border-radius:12px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06);font-family:inherit}
.chooseBtn.green{background:var(--g);color:#fff}
.chooseBtn.red{background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff}
.formBox{width:92%;max-width:560px;background:#fff;border-radius:16px;padding:16px;position:relative;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.formTop{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.badgeSmall{background:var(--g);color:#fff;border-radius:10px;padding:6px 10px}
.imagePh{border-radius:12px;height:220px;display:flex;align-items:center;justify-content:center;margin:8px 0;overflow:hidden;background:#eefaf5}
.imagePh img{width:100%;height:100%;object-fit:contain}
.inp{background:var(--g);color:#fff;border:none;border-radius:12px;padding:12px 14px;width:100%;margin-top:10px;caret-color:#fff;font-family:inherit}
.inprow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
::placeholder{color:#fff;opacity:.9}
.btnPub{width:100%;margin-top:14px;border-radius:12px;font-family:inherit}

/* search box */
.searchInner{background:#fff;border-radius:16px;padding:12px;width:92%;max-width:560px;display:flex;gap:8px;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.searchInner input{flex:1;border:2px solid #e3f4ef;border-radius:12px;padding:12px 14px;font-family:inherit}

footer{padding:18px 0;margin-top:20px;color:#0b1720a0;text-align:center}
.tagline{margin-top:6px}
</style>
</head>
<body>
<div id="splash"><div class="loader"><span>KOLO</span></div></div>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="48" fill="#10b981"/>
          <circle cx="50" cy="50" r="40" fill="none" stroke="#fff" stroke-width="6"/>
          <text x="50" y="58" font-size="22" text-anchor="middle" fill="#fff" font-family="Russo One,Arial">KOLO</text>
        </svg>
      </div>
      <div><span id="visitors" class="pill">27369 відвідувачів</span></div>
      <button class="btn plus" id="btnPlus">+</button>
      <button class="btn" id="btnSearch">ПОШУК</button>
    </div>

    <div id="banner" class="banner">
      <img id="bannerImg" src="" alt="banner" onerror="this.style.display='none'">
      <a href="#" id="bannerLink" class="adlink" style="display:block;text-align:right;font-size:12px;color:#2b7;margin-top:6px">Замовити рекламу</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="hsec top">
    <svg viewBox="0 0 24 24"><path d="M13 3s5 4 5 9a6 6 0 0 1-12 0c0-3 2-6 5-9l1 3 1-3Z"/></svg>
    <span>ТОП пропозицій</span>
  </div>
  <div id="hotGrid" class="grid"></div>

  <div class="hsec new">Нові оголошення</div>
  <div id="listGrid" class="grid"></div>
  <div style="display:flex;justify-content:center;margin:18px 0">
    <button id="btnMore" class="btn" style="background:#fff;color:#10b981;border:2px solid #10b981">Показати ще</button>
  </div>
</main>

<footer>
  <div>© KOLO, 2025</div>
  <div class="tagline">Дошка оголошень №1 в Україні</div>
</footer>

<!-- DETAIL -->
<dialog id="dlgDetail">
  <div id="modalBox">
    <div class="modHead">
      <div class="modTitle" id="modTitle">ОГОЛОШЕННЯ</div>
      <div class="pillStat green" title="Перегляди">
        <svg viewBox="0 0 24 24"><path d="M12 5C5 5 1 12 1 12s4 7 11 7 11-7 11-7-4-7-11-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg>
        <b id="vNum">0</b>
      </div>
      <button class="pillStat green" id="likeTop" style="border:none;cursor:pointer">
        <svg viewBox="0 0 24 24"><path d="M12 21s-7.5-4.35-10-8.5C.5 8.5 3 5 6.5 5 8.7 5 10 6.2 12 8c2-1.8 3.3-3 5.5-3C21 5 23.5 8.5 22 12.5 19.5 16.7 12 21 12 21Z"/></svg>
        <b id="lNum">0</b>
      </button>
    </div>
    <div class="carousel">
      <button class="navbtn left" onclick="car(-1)">&lt;</button>
      <div id="carStage"></div>
      <div id="carCount">1/1</div>
      <button class="navbtn right" onclick="car(1)">&gt;</button>
    </div>
    <div class="modPrice"><button class="btn" id="btnCall">Ціна</button></div>
    <div class="modBody">
      <div id="modDesc" style="margin-bottom:12px;white-space:pre-wrap"></div>
      <div class="chips" id="chips"></div>
    </div>
  </div>
</dialog>

<!-- CHOOSER -->
<div id="chooser"><div class="chooseBox" id="chooseBox">
  <button class="chooseBtn green" id="chooseNormal">Звичайне оголошення — 39 грн / 30 днів</button>
  <button class="chooseBtn red" id="chooseHot">HOT оголошення — 299 грн / 7 днів</button>
</div></div>

<!-- ADD FORM -->
<div id="addForm"><div class="formBox" id="addInner">
  <div class="formTop">
    <div class="badgeSmall">Додати фото</div>
    <div id="hotBadge" class="badgeSmall" style="background:#e94251;display:none">HOT</div>
  </div>
  <div class="imagePh" id="imgPh"><span>КАРТИНКА оголошення</span></div>
  <input class="inp" id="f_title" placeholder="Заголовок">
  <div class="inprow">
    <input class="inp" id="f_price" placeholder="Ціна, грн">
    <input class="inp" id="f_city" placeholder="Місто">
  </div>
  <div class="inprow">
    <input class="inp" id="f_region" placeholder="Область">
    <input class="inp" id="f_phone" placeholder="+380">
  </div>
  <textarea class="inp" id="f_desc" placeholder="Опис" rows="4" style="height:110px"></textarea>
  <input type="file" id="f_imgs" accept="image/*" multiple hidden>
  <button class="btn btnPub" id="btnPay">Опублікувати</button>
</div></div>

<!-- SEARCH -->
<div id="searchBox"><div class="searchInner" id="searchInner">
  <input id="q" placeholder="Ключові слова... (заголовок, опис, місто, область)">
  <button class="btn" id="go">Пошук</button>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
<script>
const SERVER = 'https://defensive-girls-senators-harley.trycloudflare.com';
const $ = s=>document.querySelector(s);

/* Splash 5s */
setTimeout(()=>document.getElementById('splash').style.display='none',5000);

/* socket */
const uidLocal = localStorage.getItem('kolo_uid') || (localStorage.setItem('kolo_uid','u_'+Math.random().toString(36).slice(2)), localStorage.getItem('kolo_uid'));
const socket = io(SERVER,{transports:['websocket'],auth:{uid:uidLocal}});

/* banner shrink */
const bannerEl = $('#banner');
window.addEventListener('scroll', ()=>{ if(window.scrollY>80) bannerEl.classList.add('min'); else bannerEl.classList.remove('min'); });

let ALL={hot:[],normal:[]}, page=1, ADD_TYPE='normal', CAR=[], idx=0, CUR=null;
let bannerList=[], bannerIdx=0, bannerTimer=null;

/* sockets */
socket.on('visitors', n=>$('#visitors').textContent=n+' відвідувачів');
socket.on('banner', b=>{ setBanner(b); });
socket.on('listings', d=>{ ALL=d; page=1; draw(); });
socket.on('payresult', m=>{ if(m.uid===uidLocal || !m.uid){ alert('Оплата успішна!'); hideAdd(); }});

/* initial data */
fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>{
  ALL=j.data||ALL; draw();
  setBanner(j.banner||{});
});

/* banner rotator */
function setBanner(b){
  const imgEl = document.getElementById('bannerImg');
  const linkEl = document.getElementById('bannerLink');
  bannerList = (b && b.images && b.images.length)? b.images.slice() : (b && b.image?[b.image]:[]);
  linkEl.href = (b && b.link) ? b.link : '#';

  if(bannerTimer){ clearInterval(bannerTimer); bannerTimer=null; }
  if(!bannerList.length){ imgEl.style.display='none'; return; }

  bannerIdx = 0;
  imgEl.style.display='block';
  imgEl.src = bannerList[bannerIdx];

  if(bannerList.length>1){
    bannerTimer = setInterval(()=>{
      bannerIdx = (bannerIdx+1)%bannerList.length;
      imgEl.src = bannerList[bannerIdx];
    }, 5000);
  }
}

/* cards (no likes/views on grid) */
function mkCard(ad){
  const img = (ad.images && ad.images[0]) ? ad.images[0] : '';
  return `<div class="card" onclick="openDetail('${ad.id}')">
    ${ad.type==='hot'?'<div class="badge-hot">HOT</div>':''}
    <div class="ph">${img?`<img src="${img}" alt="">`:'КАРТИНКА оголошення'}</div>
    <div class="ttl">${(ad.title||'Оголошення').toUpperCase()}</div>
    <button class="priceBtn">${(ad.price||0).toLocaleString('uk-UA')} ₴</button>
  </div>`;
}
function draw(){
  document.getElementById('hotGrid').innerHTML = (ALL.hot||[]).map(mkCard).join('');
  const slice = (ALL.normal||[]).slice(0,page*6);
  document.getElementById('listGrid').innerHTML = slice.map(mkCard).join('');
  document.getElementById('btnMore').style.display = (ALL.normal||[]).length>slice.length ? 'inline-block':'none';
}

/* detail */
window.openDetail = (id)=>{
  CUR = [...(ALL.hot||[]),...(ALL.normal||[])].find(a=>a.id===id); if(!CUR) return;
  document.getElementById('modTitle').textContent = (CUR.title||'').toUpperCase();
  document.getElementById('vNum').textContent = CUR.views||0; 
  document.getElementById('lNum').textContent = CUR.likes||0;
  document.getElementById('modDesc').textContent = CUR.desc||'';
  document.getElementById('chips').innerHTML = [
    'Код: '+(CUR.code||'00000'),
    'Телефон: '+(CUR.phone||'+380'),
    'Місто: '+(CUR.city||'-'),
    'Область: '+(CUR.region||'-'),
    'Ціна: '+((CUR.price||0).toLocaleString('uk-UA'))+' ₴',
    'Дата публікації: '+(new Date().toLocaleDateString('uk-UA')),
  ].map(t=>`<div class="chip">${t}</div>`).join('');
  document.getElementById('btnCall').onclick=()=>location.href='tel:'+(CUR.phone||'');

  CAR=(CUR.images&&CUR.images.length)?CUR.images.slice(0,5):['https://picsum.photos/seed/1/1200/800']; 
  idx=0; renderCar(true);

  const dlg=document.getElementById('dlgDetail'); dlg.showModal();
  dlg.addEventListener('click', e=>{ if(e.target===dlg) dlg.close(); });

  /* views */
  document.getElementById('vNum').textContent = (parseInt(document.getElementById('vNum').textContent,10)||0)+1;
  CUR.views = (CUR.views||0)+1; draw();
  fetch(SERVER+`/api/view/${encodeURIComponent(CUR.id)}`,{method:'POST',headers:{'X-KOLO-UID':uidLocal}});
};

function renderCar(initial=false){
  const st = document.getElementById('carStage');
  if(initial){
    st.innerHTML = CAR.map((u,i)=>`<img src="${u}" class="${i===0?'show':''}" alt="">`).join('');
  }else{
    const imgs = [...st.querySelectorAll('img')];
    imgs.forEach((im,i)=>im.classList.toggle('show', i===idx));
  }
  document.getElementById('carCount').textContent = `${idx+1}/${CAR.length}`;
}
window.car = d=>{ idx=(idx+d+CAR.length)%CAR.length; renderCar(false); };

/* like — одномоментний клік з uid */
document.getElementById('likeTop').onclick = async ()=>{
  if(!CUR) return;
  try{
    const j = await fetch(SERVER+`/api/like/${encodeURIComponent(CUR.id)}`,{
      method:'POST',
      headers:{'X-KOLO-UID':uidLocal,'Content-Type':'text/plain'}
    }).then(r=>r.json());
    if(j && j.likes!==undefined){ 
      document.getElementById('lNum').textContent=j.likes; 
      CUR.likes=j.likes; 
      draw(); 
    }
  }catch(e){}
};

/* chooser/add */
function showChooser(){ document.getElementById('chooser').style.display='flex'; }
function hideChooser(){ document.getElementById('chooser').style.display='none'; }
function showAdd(){ document.getElementById('addForm').style.display='flex'; document.getElementById('hotBadge').style.display = ADD_TYPE==='hot'?'inline-block':'none'; }
function hideAdd(){ document.getElementById('addForm').style.display='none'; }
document.getElementById('chooser').addEventListener('click',e=>{ if(e.target.id==='chooser') hideChooser(); });
document.getElementById('addForm').addEventListener('click',e=>{ if(e.target.id==='addForm') hideAdd(); });

document.getElementById('btnPlus').onclick=showChooser;
document.getElementById('chooseNormal').onclick=()=>{ADD_TYPE='normal'; hideChooser(); showAdd();}
document.getElementById('chooseHot').onclick=()=>{ADD_TYPE='hot'; hideChooser(); showAdd();}

/* banner order -> addForm */
document.getElementById('bannerLink').onclick=(e)=>{ e.preventDefault(); ADD_TYPE='banner'; hideChooser(); showAdd(); };

/* photos preview (max 5) */
let chosenFiles=[];
document.getElementById('imgPh').onclick=()=>document.getElementById('f_imgs').click();
document.getElementById('f_imgs').onchange=()=>{
  const fs=[...document.getElementById('f_imgs').files].slice(0,5); chosenFiles=fs;
  if (fs[0]) { const u=URL.createObjectURL(fs[0]); document.getElementById('imgPh').innerHTML=`<img src="${u}">`; }
};

/* publish + open LiqPay/demo */
document.getElementById('btnPay').onclick=async ()=>{
  const fd=new FormData();
  fd.append('type', ADD_TYPE);
  fd.append('title', (document.getElementById('f_title').value||'Оголошення'));
  fd.append('price', (document.getElementById('f_price').value||0));
  fd.append('city', (document.getElementById('f_city').value||''));
  fd.append('region', (document.getElementById('f_region').value||''));
  fd.append('desc', (document.getElementById('f_desc').value||''));
  fd.append('phone', (document.getElementById('f_phone').value||'+380'));
  chosenFiles.slice(0,5).forEach(f=>fd.append('images',f));

  const j = await fetch(SERVER+'/pay/start',{method:'POST',body:fd,headers:{'X-KOLO-UID':uidLocal}}).then(r=>r.json()).catch(()=>({}));
  if(!(j && j.status==='ok')){ alert('Сервер недоступний'); return; }
  if(j.checkout_url){ window.open(j.checkout_url, '_blank'); }
};

/* search */
function showSearch(){ document.getElementById('searchBox').style.display='flex'; document.getElementById('q').focus(); }
function hideSearch(){ document.getElementById('searchBox').style.display='none'; }
document.getElementById('searchBox').addEventListener('click',e=>{ if(e.target.id==='searchBox') hideSearch(); });
document.getElementById('btnSearch').onclick=showSearch;
document.getElementById('go').onclick=()=>{ const k=(document.getElementById('q').value||'').toLowerCase(); hideSearch();
  if(!k){ fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>{ALL=j.data;draw();}); return; }
  const F=a=>(a.title+a.desc+a.city+a.region).toLowerCase().includes(k);
  const data={hot:(ALL.hot||[]).filter(F), normal:(ALL.normal||[]).filter(F)}; ALL=data; page=10; draw();
};

/* more */
document.getElementById('btnMore').onclick=()=>{ page++; draw(); };

/* close detail by click outside */
document.getElementById('dlgDetail').addEventListener('click',e=>{ if(e.target.id==='dlgDetail') document.getElementById('dlgDetail').close(); });
</script>
</body>
</html>
