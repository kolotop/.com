<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>KOLO — дошка оголошень</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#10b981">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%2310b981'/%3E%3Ccircle cx='50' cy='50' r='40' fill='none' stroke='%23fff' stroke-width='6'/%3E%3Ctext x='50' y='58' text-anchor='middle' font-family='Russo One,Arial' font-size='22' fill='%23fff'%3EKOLO%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
<style>
:root{--g:#10b981;--r:#e94251;--txt:#0b1720}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:'Russo One',Arial,system-ui;background:#f5f7f6;color:var(--txt)}
a{color:inherit;text-decoration:none}.wrap{max-width:1140px;margin:0 auto;padding:10px 14px}

/* splash */
#splash{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:60}
.loader{position:relative;width:220px;height:220px;border-radius:50%;border:12px solid #e6faf2;border-top-color:var(--g);animation:spin 1s linear infinite}
.loader span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--g);font-size:38px}
@keyframes spin{to{transform:rotate(360deg)}}

/* header */
header{position:sticky;top:0;z-index:40;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.topbar{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center}
.logo svg{width:36px;height:36px}
.pill{background:var(--g);color:#fff;border-radius:12px;padding:8px 14px;font-size:13px}
.btn{border:none;background:var(--g);color:#fff;border-radius:12px;padding:10px 16px;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,.25)}
.btn.plus{background:#fff;color:var(--g);border:3px solid var(--g);width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:none}

/* banner */
.banner{margin:8px 0;overflow:hidden;transition:max-height .35s ease}
.banner img{width:100%;height:160px;object-fit:cover;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.08)}
.banner.min{max-height:0}
.adlink{display:block;text-align:right;font-size:12px;color:#2b7;margin-top:6px}

/* sections */
.hsec{display:flex;align-items:center;gap:8px;color:#fff;padding:8px 14px;border-radius:12px;margin:12px 0;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.hsec svg{width:18px;height:18px;fill:#fff}
.hsec.top{background:linear-gradient(90deg,#ff4d4d,#ff7a1a)}     /* КРАСНО-ОРАНЖЕВЫЙ */
.hsec.new{background:var(--g)}                                   /* ЗЕЛЕНАЯ */

/* cards */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
@media(min-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{background:#fff;border-radius:16px;padding:12px;position:relative;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.badge-hot{position:absolute;right:12px;top:12px;background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff;border-radius:12px;padding:4px 10px;font-size:12px}
.card .title{margin:2px 0 8px}
.card .ph{border-radius:10px;height:150px;display:flex;align-items:center;justify-content:center;background:#eefaf5;color:#6cc8a8}
.priceBtn{position:absolute;right:16px;bottom:14px;background:var(--g);color:#fff;border:none;border-radius:16px;padding:8px 16px;box-shadow:0 8px 18px rgba(16,185,129,.25)}

/* stat pills */
.pillStat{display:inline-flex;align-items:center;gap:8px;border-radius:18px;padding:6px 10px;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.pillStat svg{width:16px;height:16px}
.pillStat.green{background:var(--g);color:#fff}                   /* белые иконки на зелёном */
.pillStat.green svg{fill:#fff}

/* detail */
dialog{border:none;border-radius:16px;padding:0;width:96%;max-width:980px}
#modalBox{border-radius:16px;background:#fff;overflow:hidden;position:relative;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.modHead{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #edf3f0}
.modTitle{flex:1}
.carousel{position:relative;border-bottom:1px solid #edf3f0;background:#fff}
.carousel img{width:100%;max-height:520px;object-fit:contain;background:#fff}
.navbtn{position:absolute;top:50%;transform:translateY(-50%);background:#fff;color:var(--g);border:2px solid var(--g);border-radius:10px;width:38px;height:32px;display:flex;align-items:center;justify-content:center}
.navbtn.left{left:10px}.navbtn.right{right:10px}
.modPrice{display:flex;justify-content:flex-end;padding:12px 14px}
.modBody{padding:14px}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{background:#eefaf5;color:#0b1720;border-radius:12px;padding:10px 12px}

/* chooser/add/search */
#chooser,#addForm,#searchBox{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
.chooseBox{position:relative;width:90%;max-width:420px;background:#fff;border-radius:16px;padding:24px;display:flex;flex-direction:column;gap:14px;align-items:center;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.chooseBtn{width:100%;padding:16px;border:none;border-radius:12px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.chooseBtn.green{background:var(--g);color:#fff}
.chooseBtn.red{background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff}
.formBox{width:92%;max-width:560px;background:#fff;border-radius:16px;padding:16px;position:relative;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.formTop{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.badgeSmall{background:var(--g);color:#fff;border-radius:10px;padding:6px 10px}
.imagePh{border-radius:12px;height:220px;display:flex;align-items:center;justify-content:center;margin:8px 0;overflow:hidden;background:#eefaf5}
.imagePh img{width:100%;height:100%;object-fit:contain}
.inp{background:var(--g);color:#fff;border:none;border-radius:12px;padding:12px 14px;width:100%;margin-top:10px;caret-color:#fff}
.inprow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
::placeholder{color:#fff;opacity:.9}
.btnPub{width:100%;margin-top:14px;border-radius:12px}

/* search box */
.searchInner{background:#fff;border-radius:16px;padding:12px;width:92%;max-width:560px;display:flex;gap:8px;box-shadow:0 18px 40px rgba(0,0,0,.28)}
.searchInner input{flex:1;border:2px solid #e3f4ef;border-radius:12px;padding:12px 14px}

/* chat */
#chatFab{position:fixed;right:14px;bottom:14px;background:var(--g);color:#fff;width:56px;height:56px;border-radius:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:55;box-shadow:0 12px 30px rgba(16,185,129,.35)}
#chatWrap{position:fixed;inset:0;display:none;z-index:54;background:transparent}
#chatBox{position:absolute;right:14px;bottom:84px;width:320px;max-height:60vh;background:#fff;border-radius:16px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 18px 40px rgba(0,0,0,.28)}
#msgs{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px}
.typing{display:none;color:#777;padding:0 10px 8px}
.typing.on{display:block}
footer{padding:18px 0;margin-top:20px;color:#0b1720a0;text-align:center}
.tagline{margin-top:6px}
</style>
</head>
<body>
<div id="splash"><div class="loader"><span>KOLO</span></div></div>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="48" fill="#10b981"/>
          <circle cx="50" cy="50" r="40" fill="none" stroke="#fff" stroke-width="6"/>
          <text x="50" y="58" font-size="22" text-anchor="middle" fill="#fff" font-family="Russo One,Arial">KOLO</text>
        </svg>
      </div>
      <div><span id="visitors" class="pill">27369 відвідувачів</span></div>
      <button class="btn plus" id="btnPlus">+</button>
      <button class="btn" id="btnSearch">ПОШУК</button>
    </div>

    <div id="banner" class="banner">
      <img id="bannerImg" src="https://i.ibb.co/qFpKrh7z/42.png" alt="banner">
      <a href="#" id="bannerLink" class="adlink">Замовити рекламу</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="hsec top">
    <svg viewBox="0 0 24 24"><path d="M13 3s5 4 5 9a6 6 0 0 1-12 0c0-3 2-6 5-9l1 3 1-3Z"/></svg>
    <span>ТОП пропозицій</span>
  </div>
  <div id="hotGrid" class="grid"></div>

  <div class="hsec new">Нові оголошення</div>
  <div id="listGrid" class="grid"></div>
  <div style="display:flex;justify-content:center;margin:18px 0"><button id="btnMore" class="btn" style="background:#fff;color:#10b981;border:2px solid #10b981">Показати ще</button></div>
</main>

<footer>
  <div>© KOLO, 2025</div>
  <div class="tagline">Дошка оголошень №1 в Україні</div>
</footer>

<!-- DETAIL -->
<dialog id="dlgDetail">
  <div id="modalBox">
    <div class="modHead">
      <div class="modTitle" id="modTitle">ОГОЛОШЕННЯ</div>
      <!-- ГЛАЗ (просмотры) -->
      <div class="pillStat green" title="Перегляди"><svg viewBox="0 0 24 24"><path d="M12 5C5 5 1 12 1 12s4 7 11 7 11-7 11-7-4-7-11-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg><b id="vNum">0</b></div>
      <!-- СЕРДЦЕ (лайк) — именно ЭТА кнопка -->
      <button class="pillStat green" id="likeTop" style="border:none;cursor:pointer"><svg viewBox="0 0 24 24"><path d="M12 21s-7.5-4.35-10-8.5C.5 8.5 3 5 6.5 5 8.7 5 10 6.2 12 8c2-1.8 3.3-3 5.5-3C21 5 23.5 8.5 22 12.5 19.5 16.7 12 21 12 21Z"/></svg><b id="lNum">0</b></button>
    </div>
    <div class="carousel">
      <button class="navbtn left" onclick="car(-1)">&lt;</button>
      <div id="carImgs"></div>
      <button class="navbtn right" onclick="car(1)">&gt;</button>
    </div>
    <div class="modPrice"><button class="btn" id="btnCall">Ціна</button></div>
    <div class="modBody">
      <div id="modDesc" style="margin-bottom:12px;white-space:pre-wrap"></div>
      <div class="chips" id="chips"></div>
    </div>
  </div>
</dialog>

<!-- CHOOSER -->
<div id="chooser"><div class="chooseBox" id="chooseBox">
  <button class="chooseBtn green" id="chooseNormal">Звичайне оголошення — 39 грн / 30 днів</button>
  <button class="chooseBtn red" id="chooseHot">HOT оголошення — 299 грн / 7 днів</button>
</div></div>

<!-- ADD FORM -->
<div id="addForm"><div class="formBox" id="addInner">
  <div class="formTop">
    <div class="badgeSmall">Додати фото</div>
    <div id="hotBadge" class="badgeSmall" style="background:#e94251;display:none">HOT</div>
  </div>
  <div class="imagePh" id="imgPh"><span>КАРТИНКА оголошення</span></div>
  <input class="inp" id="f_title" placeholder="Заголовок">
  <div class="inprow">
    <input class="inp" id="f_price" placeholder="Ціна, грн">
    <input class="inp" id="f_city" placeholder="Місто">
  </div>
  <div class="inprow">
    <input class="inp" id="f_region" placeholder="Область">
    <input class="inp" id="f_phone" placeholder="+380">
  </div>
  <textarea class="inp" id="f_desc" placeholder="Опис" rows="4" style="height:110px"></textarea>
  <input type="file" id="f_imgs" accept="image/*" multiple hidden>
  <button class="btn btnPub" id="btnPay">Сплатити</button>
</div></div>

<!-- SEARCH -->
<div id="searchBox"><div class="searchInner" id="searchInner">
  <input id="q" placeholder="Ключові слова... (заголовок, опис, місто, область)">
  <button class="btn" id="go">Пошук</button>
</div></div>

<!-- CHAT -->
<div id="chatFab">💬</div>
<div id="chatWrap"><div id="chatBox">
  <div style="padding:8px 10px;border-bottom:1px solid #edf3f0">Онлайн-чат</div>
  <div id="msgs"></div>
  <div class="typing" id="typing">Адмін друкує<span>...</span></div>
  <div style="display:flex;gap:8px;padding:8px;border-top:1px solid #edf3f0">
    <input id="msg" placeholder="Ваше повідомлення..." style="flex:1;border:2px solid #e3f4ef;border-radius:12px;padding:8px 10px">
    <button class="btn" id="send">OK</button>
  </div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
<script>
/* === URL сервера === */
const SERVER = window.location.origin;

/* Splash 5s */
setTimeout(()=>document.getElementById('splash').style.display='none',5000);
const $ = s=>document.querySelector(s);

/* сокет */
const uidLocal = localStorage.getItem('kolo_uid') || (localStorage.setItem('kolo_uid','u_'+Math.random().toString(36).slice(2)), localStorage.getItem('kolo_uid'));
const socket = io(SERVER,{transports:['websocket'],auth:{uid:uidLocal}});

/* баннер — сворачивать при скролле */
const bannerEl = $('#banner');
window.addEventListener('scroll', ()=>{ if(window.scrollY>80) bannerEl.classList.add('min'); else bannerEl.classList.remove('min'); });

let ALL={hot:[],normal:[]}, page=1, ADD_TYPE='normal', CAR=[], idx=0, CUR=null;

/* сокет-ивенты */
socket.on('visitors', n=>$('#visitors').textContent=n+' відвідувачів');
socket.on('banner', b=>{
  if(!b) return;
  const imgs = (b.images && b.images.length? b.images : (b.image? [b.image]:[]));
  if(imgs.length){ $('#bannerImg').src=imgs[0]; $('#bannerLink').href=b.link||'#'; }
});
socket.on('listings', d=>{ ALL=d; page=1; draw(); });
socket.on('chat', m=>{
  /* ответ админа показываем; индикатор снимаем */
  $('#typing').classList.remove('on');
  addMsg((m.from==='admin'?'Адмін':'Користувач')+' #'+m.id, m.text, m.from==='admin'?'other':'me');
});
socket.on('payresult', m=>{ if(m.uid===uidLocal){ alert('Оплата успішна!'); hideAdd(); }});

/* карточка */
function mkCard(ad){
  return `<div class="card" onclick="openDetail('${ad.id}')">
    ${ad.type==='hot'?'<div class="badge-hot">HOT</div>':''}
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <div class="pillStat green"><svg viewBox="0 0 24 24"><path d="M12 21s-7.5-4.35-10-8.5C.5 8.5 3 5 6.5 5 8.7 5 10 6.2 12 8c2-1.8 3.3-3 5.5-3C21 5 23.5 8.5 22 12.5 19.5 16.7 12 21 12 21Z"/></svg><b>${ad.likes||0}</b></div>
      <div class="pillStat green"><svg viewBox="0 0 24 24"><path d="M12 5C5 5 1 12 1 12s4 7 11 7 11-7 11-7-4-7-11-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg><b>${ad.views||0}</b></div>
    </div>
    <div class="title">ЗАГОЛОВОК</div>
    <div class="ph">КАРТИНКА оголошення</div>
    <button class="priceBtn">${(ad.price||0).toLocaleString('uk-UA')} ₴</button>
  </div>`;
}
function draw(){
  $('#hotGrid').innerHTML = ALL.hot.map(mkCard).join('');
  const slice = ALL.normal.slice(0,page*6);
  $('#listGrid').innerHTML = slice.map(mkCard).join('');
  $('#btnMore').style.display = ALL.normal.length>slice.length ? 'inline-block':'none';
}

/* деталь */
window.openDetail = (id)=>{
  CUR = [...ALL.hot,...ALL.normal].find(a=>a.id===id); if(!CUR) return;
  $('#modTitle').textContent = CUR.title.toUpperCase();
  $('#vNum').textContent = CUR.views||0; $('#lNum').textContent = CUR.likes||0;
  $('#modDesc').textContent = CUR.desc||'';
  $('#chips').innerHTML = [
    'Номер: '+(CUR.phone||'+380'),
    'місто: '+(CUR.city||'-'),
    'область: '+(CUR.region||'-'),
    'дата публікації: '+(new Date().toLocaleDateString('uk-UA')),
  ].map(t=>`<div class="chip">${t}</div>`).join('');
  $('#btnCall').onclick=()=>location.href='tel:'+(CUR.phone||'');
  CAR=(CUR.images&&CUR.images.length)?CUR.images:['https://picsum.photos/seed/1/1200/800']; idx=0; renderCar();
  const dlg=$('#dlgDetail'); dlg.showModal();
  /* Закрыть кликом вне окна */
  dlg.addEventListener('click', e=>{ if(e.target===dlg) dlg.close(); });
  /* отправить просмотр */
  fetch(SERVER+`/api/view/${CUR.id}`,{method:'POST',headers:{'X-KOLO-UID':uidLocal}});
};
function renderCar(){ $('#carImgs').innerHTML = `<img src="${CAR[idx]}" alt="">`; }
window.car = d=>{ idx=(idx+d+CAR.length)%CAR.length; renderCar(); };
/* Лайк — именно верхняя зелёная пилюля */
$('#likeTop').onclick = async ()=>{
  if(!CUR) return;
  const j = await fetch(SERVER+`/api/like/${CUR.id}`,{method:'POST',headers:{'X-KOLO-UID':uidLocal}}).then(r=>r.json());
  if(j && j.likes!==undefined){ $('#lNum').textContent=j.likes; draw(); }
};

/* chooser/add (закрытие кликом вне) */
function showChooser(){ $('#chooser').style.display='flex'; }
function hideChooser(){ $('#chooser').style.display='none'; }
function showAdd(){ $('#addForm').style.display='flex'; $('#hotBadge').style.display = ADD_TYPE==='hot'?'inline-block':'none'; }
function hideAdd(){ $('#addForm').style.display='none'; }
$('#chooser').addEventListener('click',e=>{ if(e.target.id==='chooser') hideChooser(); });
$('#addForm').addEventListener('click',e=>{ if(e.target.id==='addForm') hideAdd(); });

$('#btnPlus').onclick=showChooser;
$('#chooseNormal').onclick=()=>{ADD_TYPE='normal'; hideChooser(); showAdd();}
$('#chooseHot').onclick=()=>{ADD_TYPE='hot'; hideChooser(); showAdd();}

/* заказ банера */
$('#bannerLink').onclick=(e)=>{ e.preventDefault(); ADD_TYPE='banner'; hideChooser(); showAdd(); };

/* превью выбранного фото */
$('#imgPh').onclick=()=>$('#f_imgs').click();
$('#f_imgs').onchange=()=>{ const f=$('#f_imgs').files[0]; if(f){ const u=URL.createObjectURL(f); $('#imgPh').innerHTML=`<img src="${u}">`; } };

/* публикация */
$('#btnPay').onclick=async ()=>{
  const fd=new FormData();
  fd.append('type', ADD_TYPE);
  fd.append('title', ($('#f_title').value||'Оголошення'));
  fd.append('price', ($('#f_price').value||0));
  fd.append('city', ($('#f_city').value||''));
  fd.append('region', ($('#f_region').value||''));
  fd.append('desc', ($('#f_desc').value||''));
  fd.append('phone', ($('#f_phone').value||'+380'));
  for(const f of $('#f_imgs').files) fd.append('images',f);
  const j = await fetch(SERVER+'/pay/start',{method:'POST',body:fd,headers:{'X-KOLO-UID':uidLocal}}).then(r=>r.json()).catch(()=>({}));
  if(!(j && j.status==='ok')) alert('Сервер недоступний');
};

/* поиск */
function showSearch(){ $('#searchBox').style.display='flex'; $('#q').focus(); }
function hideSearch(){ $('#searchBox').style.display='none'; }
$('#searchBox').addEventListener('click',e=>{ if(e.target.id==='searchBox') hideSearch(); });
$('#btnSearch').onclick=showSearch;
$('#go').onclick=()=>{ const k=($('#q').value||'').toLowerCase(); hideSearch(); if(!k){ draw(); return; }
  const F=a=>(a.title+a.desc+a.city+a.region).toLowerCase().includes(k);
  const data={hot:ALL.hot.filter(F), normal:ALL.normal.filter(F)}; ALL=data; page=10; draw();
  fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>ALL=j.data);
};

/* чат */
const chatWrap=$('#chatWrap'); const chatBox=$('#chatBox');
$('#chatFab').onclick=()=>{ chatWrap.style.display='block'; };
chatWrap.addEventListener('click', (e)=>{ if(e.target===chatWrap) chatWrap.style.display='none'; });
function addMsg(who,text,cls){ const d=document.createElement('div'); d.style.padding='8px 10px'; d.style.borderRadius='12px'; d.style.background=cls==='other'?'#f3f4f6':'#e8fff5'; d.textContent=who+': '+text; $('#msgs').appendChild(d); $('#msgs').scrollTop=99999; }
$('#send').onclick=()=>{ const v=$('#msg').value.trim(); if(!v) return; $('#msg').value='';
  socket.emit('chat',{from:'user',uid:uidLocal,text:v}); addMsg('Я',v,'me');
  /* аккуратный индикатор — без перерисовки всего окна */
  $('#typing').classList.add('on');
};

/* more */
$('#btnMore').onclick=()=>{ page++; draw(); };

/* закрывать диалог-деталь кликом вне окна */
$('#dlgDetail').addEventListener('click',e=>{ if(e.target.id==='dlgDetail') $('#dlgDetail').close(); });

/* init */
fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>{ ALL=j.data; draw(); });
</script>
</body>
</html>
