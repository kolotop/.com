<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>KOLO — дошка оголошень</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#10b981">
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6fbf8; --paper:#fff; --ink:#0f172a; --muted:#64748b;
  --brand:#10b981; --brand-press:#0e9a74; --line:#dcefe6;
  --field-bg:#edf7f1; --field-br:#cfe8da; --hotRed:#ff5155;
  --shadow-sm:0 4px 14px rgba(2,44,34,.08); --shadow-lg:0 18px 46px rgba(2,44,34,.14);
  --top:64px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif}
body.modal-open{overflow:hidden}

/* ===== PRELOADER (5s) ===== */
.preloader{position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;z-index:9999}
.pl-ring{width:220px;height:220px;border-radius:50%;border:16px solid #e7f4ee;border-top-color:var(--brand);animation:spin 1.2s linear infinite;position:relative}
.pl-logo{position:absolute;inset:0;display:grid;place-items:center}
@keyframes spin{to{transform:rotate(360deg)}}
.brand-logo{width:160px;height:160px}
.pl-sub{font:700 13px "Montserrat";color:#0b3b2d;opacity:.96}

/* ===== TOPBAR ===== */
.topbar{position:sticky;top:0;z-index:100;background:#ffffffcc;backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--line);height:var(--top);display:flex;align-items:center;gap:10px;padding:8px 12px}
.logoBtn{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:12px;border:1px solid var(--line);background:#fff;box-shadow:var(--shadow-sm)}
.logoBtn svg{width:32px;height:32px;display:block}
.pill{display:inline-flex;align-items:center;gap:8px;height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700;color:#0f172a}
.pill.green{background:var(--brand);color:#fff;border-color:transparent;font-family:"Russo One";text-transform:uppercase;box-shadow:var(--shadow-sm)}
.pill.green:active{transform:translateY(1px);background:var(--brand-press)}
.grow{flex:1}
.visitors{display:inline-flex;align-items:center;gap:8px;height:40px;padding:0 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:800;color:#0b3b2d}

/* ===== CONTAINER & ADS ===== */
.container{max-width:1200px;margin:12px auto;padding:0 12px}
.panel{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow-sm)}

.adsRow{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:8px 0 6px}
.ad{height:86px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
.ad>a{display:block;width:100%;height:100%}
.ad img{width:100%;height:100%;object-fit:cover;display:block}
.adNote{text-align:right;font-size:12px;opacity:.85;margin-top:6px;padding:0 4px}

/* ===== HOT strip ===== */
.hotWrap{margin:10px 0 6px}
.hotHead{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.hotTag{display:inline-flex;align-items:center;gap:6px;background:var(--hotRed);padding:8px 12px;border-radius:12px;font:700 14px "Russo One";color:#fff}
.hotGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
@media (max-width:1024px){.hotGrid{grid-template-columns:repeat(3,1fr)}}
@media (max-width:640px){.hotGrid{grid-template-columns:repeat(2,1fr)}}
.hotCard{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff;cursor:pointer;box-shadow:var(--shadow-sm)}
.thumb{position:relative;padding-top:56%;background:#eaf6f1;overflow:hidden}
.thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.badge{position:absolute;right:8px;bottom:8px;background:var(--brand);color:#fff;border-radius:10px;padding:6px 8px;font:800 12px "Russo One";z-index:2}
.hotBadge{position:absolute;left:8px;top:8px;background:var(--hotRed);color:#fff;border:1px solid #ff6b6e;border-radius:999px;padding:4px 8px;font:800 12px "Russo One";z-index:2}
.hotBody{padding:8px;font-size:13px}
.hotTTL{font:700 14px "Russo One";color:#0f172a}

/* ===== GRID ===== */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;cursor:pointer;box-shadow:var(--shadow-sm)}
.body{padding:10px;display:flex;flex-direction:column;gap:6px}
.title{font:700 16px "Russo One";letter-spacing:.2px;color:#0f172a}
.meta{color:var(--muted);font-size:13px}

/* ===== DETAIL ===== */
.detail{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:120}
.detail.active{display:block}
.sheet{position:absolute;left:50%;top:6vh;transform:translateX(-50%);width:min(1080px,96vw);max-height:88vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow-lg)}
.modalHead{display:flex;align-items:center;gap:10px;margin-bottom:8px}

/* Gallery */
.big{position:relative;padding-top:56%;background:#eaf6f1;border-radius:12px;overflow:hidden}
.big img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.navBtn{position:absolute;top:50%;transform:translateY(-50%);height:48px;min-width:48px;padding:0 12px;border-radius:14px;border:1px solid var(--line);background:#ffffffdd;color:#065f46;font-weight:900;font-size:26px;line-height:46px;cursor:pointer;box-shadow:var(--shadow-sm);backdrop-filter:saturate(110%) blur(3px)}
.navPrev{left:8px}.navNext{right:8px}
.galCount{position:absolute;right:10px;top:10px;background:#ffffffdd;border:1px solid var(--line);border-radius:10px;font-weight:800;padding:4px 8px}

/* forms */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:150}
.overlay.on{display:flex}
.modal{width:min(960px,96vw);max-height:88vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow-lg)}
.closeX{height:40px;border:1px solid var(--line);background:#fff;color:#0f172a;border-radius:12px;font:700 13px "Russo One";padding:0 12px;cursor:pointer}
label{font-size:12px;font-weight:800;opacity:.92;display:block;margin:0 0 6px;color:#0b3b2d}
.input,.select{width:100%;height:46px;border-radius:12px;border:1px solid var(--field-br);background:var(--field-bg);color:#064e3b;padding:0 12px;font-size:14px;outline:none}
textarea.input{color:#0f172a}
.actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.btn{height:46px;border:none;border-radius:14px;background:var(--brand);color:#fff;font:700 16px/46px "Russo One";padding:0 18px;cursor:pointer;box-shadow:var(--shadow-sm);text-shadow:0 1px 0 rgba(0,0,0,.35)}
.btn:active{transform:translateY(2px);background:var(--brand-press)}
.btn.ghost{background:#fff;color:#0f172a;border:1px solid var(--line)}
.btnMore{height:40px;line-height:40px;margin-bottom:6px}

/* small helpers */
.h{font:700 14px "Russo One";margin-bottom:6px;color:#0b3b2d}
.specs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
@media (max-width:900px){.specs{grid-template-columns:repeat(2,1fr)}}
.spec{background:#f4fbf7;border:1px solid var(--line);border-radius:12px;padding:8px;font-size:13px}
.avatar{width:44px;height:44px;border-radius:50%;background:#dff3ea;color:#065f46;display:flex;align-items:center;justify-content:center;font-weight:800}
.pager{display:flex;justify-content:center;margin:16px 0 8px}
</style>
</head>
<body class="modal-open">

<!-- ===== PRELOADER (KOLO statically, rotating ring only) ===== -->
<div id="preloader" class="preloader" aria-hidden="false">
  <div class="pl-ring">
    <div class="pl-logo">
      <!-- brand svg -->
      <svg class="brand-logo" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="128" cy="128" r="120" fill="#12b981" opacity=".15"/>
        <circle cx="128" cy="128" r="96" fill="#12b981" opacity=".15"/>
        <circle cx="128" cy="128" r="80" fill="#12b981"/>
        <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central"
              font-family="Russo One, Arial Black, Arial" font-size="64" fill="#fff" letter-spacing="2">KOLO</text>
      </svg>
    </div>
  </div>
  <div class="pl-sub">Дошка оголошень №1 в Україні</div>
</div>

<!-- ===== TOPBAR ===== -->
<header class="topbar">
  <div class="logoBtn" aria-label="KOLO">
    <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <circle cx="128" cy="128" r="110" fill="#12b981" opacity=".18"/>
      <circle cx="128" cy="128" r="88" fill="#12b981"/>
      <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central"
            font-family="Russo One, Arial Black, Arial" font-size="64" fill="#fff" letter-spacing="2">KOLO</text>
    </svg>
  </div>
  <button class="pill" id="tabSearch">Пошук</button>
  <div class="visitors"><span id="visCount">17369</span>&nbsp;корисувачів</div>
  <div class="grow"></div>
  <button class="pill green" id="tabSell">Додати оголошення</button>
</header>

<main class="container">

  <!-- ===== Double banner ===== -->
  <div class="adsRow panel">
    <div class="ad">
      <a href="https://t.me/podorozhuy_zi_mnoyu" target="_blank" rel="noopener">
        <img src="https://i.ibb.co/MkPd08Sk/2025-09-17-202413.png" alt="Реклама 1" referrerpolicy="no-referrer">
      </a>
    </div>
    <div class="ad">
      <a href="https://t.me/applab_ua" target="_blank" rel="noopener">
        <img src="https://i.ibb.co/bMMFfXtx/2025-09-17-225853.png" alt="Реклама 2" referrerpolicy="no-referrer">
      </a>
    </div>
    <div class="adNote">Замовити рекламу</div>
  </div>

  <!-- ===== HOT ===== -->
  <section class="panel hotWrap" id="hotPanel" style="display:none">
    <div class="hotHead"><div class="hotTag">HOT</div></div>
    <div class="hotGrid" id="hotGrid"></div>
  </section>

  <!-- ===== LIST ===== -->
  <section class="grid" id="grid"></section>
  <div class="pager"><button class="btn btnMore" id="btnMore" style="display:none">Показати ще</button></div>
</main>

<!-- ===== DETAIL ===== -->
<div id="detail" class="detail" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div class="logoBtn" style="padding:4px 8px">
        <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="width:28px;height:28px">
          <circle cx="128" cy="128" r="88" fill="#12b981"/>
          <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central"
            font-family="Russo One, Arial Black, Arial" font-size="48" fill="#fff" letter-spacing="2">KOLO</text>
        </svg>
      </div>
      <div class="grow"></div>
      <button class="pill green" id="dShare">Поділитися</button>
      <button class="pill green" id="dViews" style="gap:8px"></button>
      <button class="closeX" id="dClose">Закрити</button>
    </div>
    <div id="dHeader" style="display:flex;align-items:center;gap:10px;margin-bottom:8px"></div>
    <div id="dGal"></div>
    <div style="height:1px;background:var(--line);margin:12px 0"></div>
    <div class="specs" id="dSpecs"></div>
    <div style="height:1px;background:var(--line);margin:12px 0"></div>
    <div id="dDesc" style="opacity:.9"></div>
    <div style="height:1px;background:var(--line);margin:12px 0"></div>
    <div class="seller" id="dSeller"></div>
  </div>
</div>

<!-- ===== SELL CHOICE ===== -->
<div class="overlay" id="sellChoiceOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <h3 style="margin:0" class="h">Обрати тип оголошення</h3>
      <div class="grow"></div>
      <button class="closeX" id="choiceClose">Закрити</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="panel" style="cursor:pointer;background:var(--brand);color:#fff" id="chooseNormal">
        <div class="h" style="color:#fff">Звичайне оголошення</div>
        <div>Публікація за замовчуванням</div>
      </div>
      <div class="panel" style="cursor:pointer;background:var(--hotRed);color:#fff" id="chooseHot">
        <div class="h" style="color:#fff">HOT швидкий продаж</div>
        <div>Покращена видимість у списках</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== SELL FORM ===== -->
<div class="overlay" id="sellOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <h3 class="h" style="margin:0">Додати оголошення</h3>
      <div class="grow"></div>
      <button class="closeX" id="sellClose">Закрити</button>
    </div>
    <div class="actions" style="margin:-4px 0 8px">
      <span id="sellModeBadge" class="pill" style="background:var(--hotRed);color:#fff;border-color:#ff6b6e">HOT</span>
    </div>

    <div class="filters" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
      <div><label>Область</label><input class="input" id="sRegion"></div>
      <div><label>Місто</label><input class="input" id="sCity"></div>
      <div><label>Категорія</label><select class="select" id="sCat"></select></div>

      <div><label>Ім’я</label><input class="input" id="sName" placeholder="Ваше ім’я"></div>
      <div><label>Телефон</label><input class="input" id="sPhone" placeholder="+380"></div>
      <div><label>Стан</label><select class="select" id="sCond"></select></div>

      <div style="grid-column:1/-1"><label>Заголовок</label><input class="input" id="sTitle"></div>
      <div><label>Ціна, ₴</label><input class="input" id="sPrice" inputmode="numeric"></div>
      <div style="grid-column:1/-1"><label>Опис</label><textarea class="input" id="sDesc" rows="3" style="height:auto;padding:10px"></textarea></div>

      <!-- Фото -->
      <div style="grid-column:1/-1">
        <label>Фото (до 5)</label>
        <input type="file" id="sImages" accept="image/*" multiple hidden>
        <div class="actions" style="margin-top:6px">
          <button class="closeX" id="btnPick">Додати фото</button>
          <span id="pickedInfo" style="font-weight:700;color:#065f46"></span>
        </div>
      </div>
    </div>

    <div class="actions"><button class="btn" id="sSave">Опублікувати</button></div>
  </div>
</div>

<!-- ===== SEARCH (мінімальний) ===== -->
<div class="overlay" id="searchOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <h3 class="h" style="margin:0">Пошук</h3>
      <div class="grow"></div>
      <button class="closeX" id="searchClose">Закрити</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr;gap:10px">
      <div><label>Ключове слово</label><input class="input" id="fltQuery" placeholder=""></div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="btnApply">Знайти</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= Utils ================= */
const $ = s => document.querySelector(s);
const DB_KEY="kolo_db_v4", VER_KEY="kolo_ver_v4";
const round100 = v => Math.max(0, Math.round(Number(v||0)/100)*100);
const uid=()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
const fmtUA=d=>new Date(d).toLocaleDateString('uk-UA');
const pick=a=>a[Math.floor(Math.random()*a.length)];

/* ===== Visitors: 17369 + таймер 15с +1..3 + на перезавантаження ===== */
(function visitorsInit(){
  const BASE=17369, STEP=15000;
  try{
    const k='kolo_vis_local'; const day=Math.floor(Date.now()/86400000);
    let r=JSON.parse(localStorage.getItem(k)||'{"d":0,"c":0}');
    if(r.d!==day) r={d:day,c:1}; else r.c+=1; // +1 за оновлення
    localStorage.setItem(k, JSON.stringify(r));
  }catch{}
  function baseNow(){
    const sinceMidnight = Date.now() - new Date().setHours(0,0,0,0);
    return BASE + Math.floor(sinceMidnight/STEP)*2; // синхронний базовий ріст для всіх
  }
  function localPlus(){ try{ return JSON.parse(localStorage.getItem('kolo_vis_local')||'{"c":0}').c||0 }catch{return 0} }
  function tick(){
    const el=$("#visCount");
    let v = baseNow() + localPlus();
    el.textContent = v.toLocaleString('uk-UA');
  }
  tick(); setInterval(tick, 1000);
})();

/* ===== Banners are static (already in markup) ===== */

/* ================= Seed data (400 items, real images) ================= */
const ALL_CATS=["Транспорт","Електроніка","Нерухомість","Дім і сад","Меблі","Побутова техніка","Будівництво та ремонт","Велосипеди","Спорт і Хобі","Тварини","Послуги","Дитячий світ","Музичні інструменти","Туризм"];
const CONDS=["Нове","Вживане","Після ремонту"];
const UA_REGIONS={"Київська":["Київ","Біла Церква","Бровари","Бориспіль","Ірпінь","Буча"],"Львівська":["Львів","Дрогобич","Стрий"],"Одеська":["Одеса","Чорноморськ","Южне","Ізмаїл"],"Харківська":["Харків","Лозова","Ізюм"],"Дніпропетровська":["Дніпро","Кривий Ріг","Павлоград"],"Вінницька":["Вінниця","Жмеринка"],"Полтавська":["Полтава","Кременчук"],"Черкаська":["Черкаси","Умань"],"Житомирська":["Житомир","Бердичів"]};
const PLACES = Object.keys(UA_REGIONS).flatMap(r=>UA_REGIONS[r].map(n=>({region:r,city:n})));
const IMG = {
  car:[
    "https://upload.wikimedia.org/wikipedia/commons/2/26/2018_Volkswagen_Golf_SE_NAV_TDi_1.6_Front.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/6/65/2018_Toyota_Camry_LE_front_6.22.18.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/b/b1/2018_BMW_320d_M_Sport_Automatic_2.0_Front.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/1/1e/2018_Volvo_XC60_Momentum_D4_AWD_2.0_Front.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/7/7f/2018_Kia_Sportage_3_CRDi_ISG_1.7_Front.jpg"
  ],
  phone:[
    "https://upload.wikimedia.org/wikipedia/commons/9/94/Samsung_Galaxy_S21_5G.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/3/3c/IPhone_13_Pro_Max_Alpine_Green.png",
    "https://upload.wikimedia.org/wikipedia/commons/1/17/Google_Pixel_6_-_Retail_Package.jpg"
  ],
  tv:["https://upload.wikimedia.org/wikipedia/commons/6/60/Modern_TV.jpg"],
  washer:["https://upload.wikimedia.org/wikipedia/commons/5/5f/Washing_machine_bosch.jpg"],
  sofa:["https://upload.wikimedia.org/wikipedia/commons/1/1d/Sofa_in_living_room.jpg"],
  tools:["https://upload.wikimedia.org/wikipedia/commons/2/2f/Hand_tools.jpg"],
  decor:["https://upload.wikimedia.org/wikipedia/commons/0/0f/Scandinavian_interior_design.jpg"],
  flat:["https://upload.wikimedia.org/wikipedia/commons/2/22/Minimalist_apartment_interior.jpg"],
  bike:["https://upload.wikimedia.org/wikipedia/commons/7/7b/Road_bicycle.jpg"],
  dog:["https://upload.wikimedia.org/wikipedia/commons/6/6e/Golde33443.jpg"],
  cat:["https://upload.wikimedia.org/wikipedia/commons/3/3a/Cat03.jpg"]
};
function poolByCat(cat){
  if(cat==="Транспорт") return IMG.car;
  if(cat==="Електроніка") return [...IMG.phone, ...IMG.tv];
  if(cat==="Нерухомість") return IMG.flat;
  if(cat==="Дім і сад"||cat==="Меблі") return [...IMG.sofa, ...IMG.decor, ...IMG.tools];
  if(cat==="Побутова техніка") return IMG.washer;
  if(cat==="Велосипеди") return IMG.bike;
  if(cat==="Тварини") return [...IMG.dog, ...IMG.cat];
  return [...IMG.phone, ...IMG.tools, ...IMG.sofa];
}
function imgSet(cat,count=3){
  const pool=poolByCat(cat); const out=[];
  for(let i=0;i<count;i++) out.push(pool[(i+Math.floor(Math.random()*pool.length))%pool.length]);
  return out;
}
function genPhone(){
  const ops=["50","63","66","67","68","73","93","95","96","97","98","99"];
  const op=pick(ops);
  return `+380 ${op} ${Math.floor(100+Math.random()*900)}-${Math.floor(10+Math.random()*90)}-${Math.floor(10+Math.random()*90)}`;
}
function seedDB(){
  const out=[]; const now=Date.now();
  for(let i=0;i<400;i++){
    const cat = pick(ALL_CATS);
    const place = PLACES[i%PLACES.length];
    const cond = CONDS[i%CONDS.length];
    const priceBase = (
      cat==="Транспорт" ? 4000 + (i%70)*500 :
      cat==="Нерухомість" ? 15000 + (i%80)*800 :
      cat==="Електроніка" ? 200 + (i%80)*50 :
      cat==="Побутова техніка" ? 300 + (i%60)*40 :
      cat==="Велосипеди" ? 150 + (i%50)*30 :
      100 + (i%80)*20
    ) * (cat==="Нерухомість" ? 1 : 1); // простий розкид
    const title = (
      cat==="Транспорт" ? ["Volkswagen Golf","Toyota Camry","BMW 320d","Volvo XC60","Kia Sportage"] :
      cat==="Електроніка" ? ["iPhone 13 128GB","Samsung S21 256GB","Google Pixel 6","Смарт TV 55''"] :
      cat==="Нерухомість" ? ["1к квартира центр","2к біля парку","Студія, новобудова"] :
      cat==="Дім і сад" ? ["Набір інструментів","Декор сканди","Садовий стіл"] :
      cat==="Меблі" ? ["Диван розкладний","Стіл обідній з дерева"] :
      cat==="Побутова техніка" ? ["Пральна машина Bosch","Холодильник Samsung"] :
      cat==="Велосипеди" ? ["Шосейний велосипед","MTB з амортизацією"] :
      cat==="Тварини" ? ["Лабрадор дорослий • добрий","Кошеня лагідне"] :
      cat==="Послуги" ? ["Майстер на годину","Ремонт техніки"] :
      ["Товар","Пропозиція"]
    )[i%2];

    out.push({
      id: "L"+i.toString(36)+now.toString(36),
      cat, title, cond,
      region: place.region, city: place.city,
      price: round100(priceBase), currency:"₴",
      created: now - (i%60)*86400000,
      views: 120 + (i%500),
      likes: Math.round(40+(i%50)),
      images: imgSet(cat, 3),
      desc: "Опис відповідає фото. Перевірка вітається, можлива відправка Новою поштою або зустріч.",
      contact: {name:"Продавець", phone: genPhone()},
      hot: (i%7===0)
    });
  }
  localStorage.setItem(DB_KEY, JSON.stringify(out));
  localStorage.setItem(VER_KEY, "1");
}
function getDB(){ try{return JSON.parse(localStorage.getItem(DB_KEY)||"[]")}catch{return[]} }
function setDB(v){ localStorage.setItem(DB_KEY, JSON.stringify(v)) }

/* ================= Render HOT & GRID ================= */
const grid=$("#grid"), btnMore=$("#btnMore");
let lastResults=[], page=0, pageSize=24;

function itemPNG(title,seed=0){
  const c=document.createElement('canvas'); c.width=800;c.height=500;const g=c.getContext('2d');
  const grad=g.createLinearGradient(0,0,800,500);grad.addColorStop(0,"#e9f7f1");grad.addColorStop(1,"#cdeee1");
  g.fillStyle=grad;g.fillRect(0,0,800,500);g.fillStyle="#a0dcc8";g.fillRect(0,420,800,80);
  g.fillStyle='#0f172a';g.font="bold 42px 'Russo One'";g.textAlign="center";g.fillText(title.slice(0,22),400,100);
  g.fillStyle="#0002";for(let i=0;i<6;i++){g.fillRect(120+i*90,220+Math.sin(i+seed)*20,60,120)}
  return c.toDataURL('image/png');
}
function createImg(src, alt, fallback){
  const img=new Image(); img.loading="lazy"; img.alt=alt||""; img.referrerPolicy="no-referrer";
  img.src=src; img.onerror=()=>{ img.onerror=null; img.src=fallback };
  return img;
}

function ensureHot(){
  const hot = getDB().filter(x=>x.hot===true);
  if(!hot.length){ $("#hotPanel").style.display="none"; return }
  const now=Date.now();
  const scored=hot.map(x=>({id:x.id,score:(x.likes||0)*6+(x.views||0)+Math.max(0,2000-(now-x.created)/1000)}))
                  .sort((a,b)=>b.score-a.score).slice(0,10).map(s=>s.id);
  renderHot(scored);
}
function renderHot(ids){
  const gridEl=$("#hotGrid"); gridEl.innerHTML=""; $("#hotPanel").style.display="block";
  const db=getDB();
  ids.map(id=>db.find(x=>x.id===id)).filter(Boolean).forEach(it=>{
    const card=document.createElement('div'); card.className="hotCard"; card.onclick=()=>openDetail(it.id);
    const thumb=document.createElement('div'); thumb.className="thumb";
    const fallback=itemPNG(it.title,(it.price+it.created)%7);
    thumb.appendChild(createImg((it.images&&it.images[0])||"",it.title,fallback));
    const price=document.createElement('div'); price.className="badge"; price.textContent=`${it.price.toLocaleString('uk-UA')} ${it.currency}`;
    const hotb=document.createElement('div'); hotb.className="hotBadge"; hotb.textContent="HOT";
    thumb.appendChild(hotb); thumb.appendChild(price);
    const body=document.createElement('div'); body.className='hotBody';
    body.innerHTML=`<div class="hotTTL">${it.title}</div><div class="meta">${it.city} • ${it.cat}</div>`;
    card.appendChild(thumb); card.appendChild(body);
    gridEl.appendChild(card);
  });
}

function applyFilters(){
  const q=($("#fltQuery").value||"").trim().toLowerCase();
  let arr=getDB().filter(it => !q || (it.title||"").toLowerCase().includes(q));
  arr.sort((a,b)=>b.created-a.created);
  lastResults=arr; page=0; grid.innerHTML=""; renderMore();
}
function renderMore(){
  const slice=lastResults.slice(page*pageSize,(page+1)*pageSize);
  slice.forEach(renderCard); page++; btnMore.style.display=(lastResults.length>page*pageSize)?"inline-flex":"none";
}
function renderCard(it){
  const el=document.createElement('article'); el.className="card"; el.title="Дивитися"; el.role="button";
  const thumb=document.createElement('div'); thumb.className="thumb";
  const fallback=itemPNG(it.title,(it.price+it.created)%7);
  thumb.appendChild(createImg((it.images&&it.images[0])||"",it.title,fallback));
  const price=document.createElement('div'); price.className="badge"; price.textContent=`${it.price.toLocaleString('uk-UA')} ${it.currency||"₴"}`;
  thumb.appendChild(price);
  const body=document.createElement('div'); body.className='body';
  body.innerHTML=`<div class="title">${it.title}</div>
                  <div class="meta">${it.cat} • ${it.cond}</div>
                  <div class="meta">${it.region} • ${it.city}</div>`;
  el.appendChild(thumb); el.appendChild(body);
  el.onclick=()=>openDetail(it.id);
  grid.appendChild(el);
}

/* ================= Detail modal with gallery + swipe ================= */
const detail=$("#detail"), dClose=$("#dClose"), dShare=$("#dShare"), dViews=$("#dViews");
let galImgs=[], galIndex=0, currentItem=null;

function renderGallery(title){
  const gal=$("#dGal");
  gal.innerHTML=`<div class="big">
    <button class="navBtn navPrev" id="galPrev" aria-label="Попереднє">‹</button>
    <button class="navBtn navNext" id="galNext" aria-label="Наступне">›</button>
    <div class="galCount" id="galCount"></div>
  </div>`;
  const big=gal.querySelector(".big");
  const url=galImgs[galIndex];
  big.appendChild(createImg(url,'photo',itemPNG(title,galIndex)));
  $("#galCount").textContent = (galIndex+1)+"/"+galImgs.length;

  $("#galPrev").onclick=()=>{ galIndex=(galIndex-1+galImgs.length)%galImgs.length; renderGallery(title) };
  $("#galNext").onclick=()=>{ galIndex=(galIndex+1)%galImgs.length; renderGallery(title) };

  // touch swipe
  let sx=null; big.ontouchstart=e=>{ sx=e.touches[0].clientX };
  big.ontouchmove=e=>{ if(sx===null) return; const dx=e.touches[0].clientX-sx;
    if(Math.abs(dx)>40){ sx=null; (dx>0?$("#galPrev"):$("#galNext")).click() } };
  big.ontouchend=()=>{ sx=null };
}

function openDetail(id){
  const db=getDB(); const ix=db.findIndex(x=>x.id===id); if(ix<0) return;
  currentItem = db[ix];

  // «глобальний» перегляд — у статичному режимі робимо локальний інкремент + відображення
  currentItem.views=(currentItem.views||0)+1; db[ix]=currentItem; setDB(db);

  detail.classList.add('active'); detail.setAttribute('aria-hidden','false'); document.body.classList.add('modal-open');
  dClose.onclick=()=>{ detail.classList.remove('active'); detail.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); applyFilters(); ensureHot(); };

  // header
  const head=document.createElement('div'); head.style.display='flex'; head.style.alignItems='center'; head.style.gap='10px';
  const ttl=document.createElement('div'); ttl.className='title'; ttl.style.fontSize='20px'; ttl.textContent=currentItem.title;
  const price=document.createElement('div'); price.className='pill green'; price.style.cssText='height:38px;line-height:38px;border-radius:12px';
  price.textContent = '₴ '+ currentItem.price.toLocaleString('uk-UA');
  head.appendChild(ttl); head.appendChild(price);
  $("#dHeader").innerHTML=''; $("#dHeader").appendChild(head);

  // views button (icon + number)
  dViews.innerHTML = `Перегляди: <b id="viewsNum">${currentItem.views}</b>`;

  // gallery
  galImgs = (Array.isArray(currentItem.images)&&currentItem.images.length) ? currentItem.images :
            [itemPNG(currentItem.title,0), itemPNG(currentItem.title,1), itemPNG(currentItem.title,2)];
  galIndex=0; renderGallery(currentItem.title);

  // specs & desc & seller
  $("#dSpecs").innerHTML =
    `<div class="spec"><div class="h">Категорія</div>${currentItem.cat}</div>`+
    `<div class="spec"><div class="h">Стан</div>${currentItem.cond}</div>`+
    `<div class="spec"><div class="h">Область</div>${currentItem.region}</div>`+
    `<div class="spec"><div class="h">Місто</div>${currentItem.city}</div>`+
    `<div class="spec"><div class="h">Опубліковано</div>${fmtUA(currentItem.created)}</div>`;
  $("#dDesc").textContent = currentItem.desc || "";
  const initials = (currentItem.contact?.name||"П")[0];
  $("#dSeller").innerHTML = `<div class="avatar">${initials}</div>
    <div><div class="h">Продавець</div><div>${currentItem.contact?.name||"Продавець"}</div>
    <div style="opacity:.85">${currentItem.contact?.phone||"—"}</div></div>`;

  // share
  dShare.onclick=()=>{
    const url = location.origin + location.pathname + '#'+currentItem.id;
    const text=(currentItem.desc||'').slice(0,120);
    if(navigator.share) navigator.share({title:currentItem.title,text,url}).catch(()=>{});
    else { navigator.clipboard?.writeText(`${currentItem.title}\n${text}\n${url}`); alert('Посилання скопійовано.'); }
  };
}

/* ================= Sell form ================= */
const sCat=$("#sCat"), sCond=$("#sCond");
sCat.innerHTML = ALL_CATS.map(x=>`<option>${x}</option>`).join('');
sCond.innerHTML = CONDS.map(x=>`<option>${x}</option>`).join('');

let postMode="hot";
function setPostMode(m){ postMode=m; const b=$("#sellModeBadge"); if(m==="hot"){ b.textContent="HOT"; b.style.background="var(--hotRed)"; b.style.color="#fff"; } else { b.textContent="Звичайне"; b.style.background="var(--brand)"; b.style.color="#fff"; } }

$("#btnPick").onclick=()=>$("#sImages").click();
$("#sImages").addEventListener('change', ()=>{
  const files = [...$("#sImages").files];
  if(files.length>5){ alert("Максимум 5 фото."); $("#sImages").value=""; $("#pickedInfo").textContent=""; return; }
  $("#pickedInfo").textContent = files.length ? `Обрано: ${files.length} / 5` : "";
});

function filesToDataURLs(inputEl){
  const files = [...(inputEl.files||[])].slice(0,5);
  const tasks = files.map(f=>new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); }));
  return Promise.all(tasks);
}

$("#sSave").onclick=async ()=>{
  const region=$("#sRegion").value.trim(), city=$("#sCity").value.trim(), cat=$("#sCat").value, title=$("#sTitle").value.trim();
  const name=$("#sName").value.trim(); const phone=$("#sPhone").value.trim();
  const cond=$("#sCond").value; const price=round100($("#sPrice").value);
  const desc=$("#sDesc").value.trim();
  if(!region||!city||!cat||!title||!name) return alert("Заповни область/місто/категорію/заголовок/ім’я.");
  const imgs = await filesToDataURLs($("#sImages"));
  const db=getDB();
  db.unshift({
    id: uid(), cat, title, cond, price, currency:"₴",
    region, city, created:Date.now(), views:0, likes:0,
    images: imgs.length?imgs:imgSet(cat,3),
    desc: desc||"Без опису",
    contact:{name: name||"Продавець", phone: phone||genPhone()},
    hot: (postMode==="hot")
  });
  setDB(db);
  alert("Оголошення опубліковано.");
  $("#sellOverlay").classList.remove('on'); document.body.classList.remove('modal-open');
  $("#sRegion").value=$("#sCity").value=$("#sTitle").value=$("#sPrice").value=$("#sDesc").value=$("#sPhone").value=$("#sName").value="";
  $("#sImages").value=""; $("#pickedInfo").textContent="";
  setPostMode("normal"); applyFilters(); ensureHot();
};

/* ================= Init / overlays ================= */
(function init(){
  if(!localStorage.getItem(VER_KEY) || !getDB().length) seedDB();
  applyFilters(); ensureHot();

  // preloader off after 5s
  setTimeout(()=>{ $("#preloader").style.display='none'; document.body.classList.remove('modal-open') }, 5000);

  // buttons
  $("#btnMore").onclick=renderMore;
  $("#tabSearch").onclick=()=>{ $("#searchOverlay").classList.add('on'); $("#searchOverlay").setAttribute('aria-hidden','false'); document.body.classList.add('modal-open'); };
  $("#searchClose").onclick=()=>{ $("#searchOverlay").classList.remove('on'); $("#searchOverlay").setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); };
  $("#btnApply").onclick=()=>{ applyFilters(); $("#searchClose").click() };

  $("#tabSell").onclick=()=>{ $("#sellChoiceOverlay").classList.add('on'); $("#sellChoiceOverlay").setAttribute('aria-hidden','false'); document.body.classList.add('modal-open'); };
  $("#choiceClose").onclick=()=>{ $("#sellChoiceOverlay").classList.remove('on'); $("#sellChoiceOverlay").setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); };
  $("#chooseNormal").onclick=()=>{ setPostMode("normal"); $("#sellChoiceOverlay").classList.remove('on'); $("#sellOverlay").classList.add('on'); $("#sellOverlay").setAttribute('aria-hidden','false'); };
  $("#chooseHot").onclick=()=>{ setPostMode("hot"); $("#sellChoiceOverlay").classList.remove('on'); $("#sellOverlay").classList.add('on'); $("#sellOverlay").setAttribute('aria-hidden','false'); };
  $("#sellClose").onclick=()=>{ $("#sellOverlay").classList.remove('on'); $("#sellOverlay").setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); setPostMode("normal"); };

  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'){ detail.classList.remove('active'); $("#sellOverlay").classList.remove('on'); $("#searchOverlay").classList.remove('on'); $("#sellChoiceOverlay").classList.remove('on'); document.body.classList.remove('modal-open'); }
    if(detail.classList.contains('active') && (e.key==='ArrowLeft'||e.key==='ArrowRight')){
      const btn = e.key==='ArrowLeft' ? document.getElementById('galPrev') : document.getElementById('galNext'); btn?.click();
    }
  });

  // deep link
  if(location.hash && location.hash.length>1){ const id=location.hash.slice(1); setTimeout(()=>openDetail(id), 600); }
})();
</script>
</body>
</html>
