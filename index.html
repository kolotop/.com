<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>KOLO ‚Äî –¥–æ—à–∫–∞ –æ–≥–æ–ª–æ—à–µ–Ω—å</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#10b981">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --green:#10b981; --green2:#0b7d60; --red:#e94251; --bg:#f4f6f7; --txt:#0b1720;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Montserrat,system-ui,Arial;background:#fff;color:var(--txt)}
a{color:inherit;text-decoration:none}
.wrap{max-width:1140px;margin:0 auto;padding:10px 14px}

/* Topbar */
header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:2px solid #10b9811a}
.topbar{
  display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;
}
.logo{display:flex;align-items:center;gap:10px}
.logo svg{width:36px;height:36px}
.pill{background:var(--green);color:#fff;border-radius:10px;padding:8px 12px;font-weight:800;font-size:13px}
.btn{border:none;background:var(--green);color:#fff;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer}
.btn.search{border-radius:10px}
.btn.plus{background:#fff;color:var(--green);border:3px solid var(--green);width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}

/* Banner */
.banner{margin:8px 0;border-top:2px solid #10b98120;border-bottom:2px solid #10b98120;padding:6px 0}
.banner img{width:100%;display:block;border-radius:6px}
.banner .adlink{display:block;text-align:right;font-size:12px;color:#2b7; margin-top:4px}

/* Section headers */
.hsec{display:inline-block;background:#e83b3b;color:#fff;padding:8px 14px;border-radius:8px;font-weight:800;margin:12px 0}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
@media(min-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{
  border:3px solid var(--green); border-radius:12px; background:#fff; padding:10px; position:relative; cursor:pointer;
}
.badge-hot{
  position:absolute;right:10px;top:10px;background:var(--red);color:#fff;font-weight:800;border-radius:8px;padding:4px 10px;font-size:12px
}
.card .title{font-weight:800;margin:2px 0 8px}
.card .ph{
  border:3px solid var(--green); border-radius:8px; height:150px; display:flex;align-items:center;justify-content:center; font-weight:800; color:#000;
}
.priceBtn{
  position:absolute; right:16px; bottom:14px; background:var(--green); color:#fff; border:none; border-radius:8px; padding:6px 14px; font-weight:800;
}

/* Detail modal (dialog) */
dialog{border:none;border-radius:12px;padding:0;width:96%;max-width:720px}
#modalBox{border:3px solid var(--green); border-radius:12px; overflow:hidden; background:#fff}
.modHead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:3px solid var(--green)}
.modTitle{font-weight:800}
.modStats{display:flex;gap:10px}
.st{display:inline-flex;align-items:center;gap:6px;background:var(--green);color:#fff;font-weight:800;border-radius:8px;padding:4px 8px;font-size:13px}
.carousel{position:relative;border-bottom:3px solid var(--green);background:#fff}
.carousel img{width:100%;max-height:360px;object-fit:contain;background:#fff}
.navbtn{position:absolute;top:50%;transform:translateY(-50%);background:#fff;color:var(--green);border:3px solid var(--green);font-weight:900;border-radius:8px;width:38px;height:32px;display:flex;align-items:center;justify-content:center}
.navbtn.left{left:10px} .navbtn.right{right:10px}
.modPrice{display:flex;justify-content:flex-end;padding:12px 14px}
.modPrice .btn{border-radius:8px}
.modBody{padding:14px;border-top:3px solid var(--green)}
.blockTitle{background:var(--green);color:#fff;border-radius:10px;padding:16px;text-align:center;font-weight:800;margin-bottom:12px}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{background:var(--green);color:#fff;border-radius:10px;padding:8px 12px;font-weight:800}

/* Add-flow overlays */
#chooser,#addForm{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:40}
.chooseBox{width:90%;max-width:420px;background:#fff;border:3px solid var(--green);border-radius:12px;padding:24px;display:flex;flex-direction:column;gap:14px;align-items:center}
.chooseBtn{width:100%;padding:16px;border:none;font-weight:800;border-radius:10px;cursor:pointer}
.chooseBtn.green{background:var(--green);color:#fff}
.chooseBtn.red{background:linear-gradient(90deg,#ff4d4d,#ff2d6f);color:#fff}

/* Add form */
.formBox{width:92%;max-width:540px;background:#fff;border:3px solid var(--green);border-radius:12px;padding:16px;position:relative}
.formTop{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.badgeSmall{background:var(--green);color:#fff;border-radius:8px;padding:6px 10px;font-weight:800}
.imagePh{border:3px solid var(--green);border-radius:8px;height:180px;display:flex;align-items:center;justify-content:center;font-weight:800;margin:8px 0}
.inp{background:var(--green);color:#fff;border:none;border-radius:10px;padding:12px 14px;width:100%;font-weight:800;margin-top:10px}
.inprow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.formBox .btnPub{width:100%;margin-top:14px;border-radius:10px}

/* Splash 5s */
#splash{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:50}
.loader{position:relative;width:140px;height:140px;border-radius:50%;border:10px solid #dff5ec;border-top-color:var(--green);animation:spin 1s linear infinite}
.loader span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--green)}
@keyframes spin{to{transform:rotate(360deg)}}

/* More */
.moreWrap{display:flex;justify-content:center;margin:18px 0}
.more{border:3px solid var(--green);background:#fff;color:var(--green);border-radius:10px;padding:10px 16px;font-weight:800;cursor:pointer}

/* Footer */
footer{border-top:2px solid #10b9811a;padding:18px 0;margin-top:20px;color:#0b1720a0}

/* Responsive tighten */
@media(max-width:420px){
  .pill{padding:6px 10px}
  .btn.search{padding:8px 12px}
  .card .ph{height:130px}
}
</style>
</head>
<body>
<!-- Splash -->
<div id="splash"><div class="loader"><span>KOLO</span></div></div>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <!-- SVG logo -->
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="48" fill="#10b981"/>
          <circle cx="50" cy="50" r="40" fill="none" stroke="#fff" stroke-width="6"/>
          <text x="50" y="59" font-size="32" font-weight="800" text-anchor="middle" fill="#fff" font-family="Montserrat,Arial">KOLO</text>
        </svg>
      </div>
      <div><span id="visitors" class="pill">27369 –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤</span></div>
      <button class="btn plus" id="btnPlus">+</button>
      <button class="btn search" id="btnSearch">–ü–û–®–£–ö</button>
    </div>

    <div class="banner">
      <img id="bannerImg" src="https://picsum.photos/seed/kolo-banner/1200/120" alt="banner">
      <a href="#" id="bannerLink" class="adlink">–ó–∞–º–æ–≤–∏—Ç–∏ —Ä–µ–∫–ª–∞–º—É</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="hsec">–¢–û–ü –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π</div>
  <div id="hotGrid" class="grid"></div>

  <div class="hsec" style="background:#10b981;margin-top:22px">–ù–æ–≤—ñ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</div>
  <div id="listGrid" class="grid"></div>
  <div class="moreWrap"><button id="btnMore" class="more">–ü–æ–∫–∞–∑–∞—Ç–∏ —â–µ</button></div>
</main>

<footer><div class="wrap">¬© KOLO, 2025</div></footer>

<!-- DETAIL -->
<dialog id="dlgDetail">
  <div id="modalBox">
    <div class="modHead">
      <div class="modTitle" id="modTitle">–ó–ê–ì–û–õ–û–í–û–ö</div>
      <div class="modStats">
        <div class="st" id="modViews">üëÅÔ∏è 0</div>
        <div class="st" id="modLikes">‚ù§ 0</div>
      </div>
    </div>
    <div class="carousel">
      <button class="navbtn left" onclick="car(-1)"><</button>
      <div id="carImgs"></div>
      <button class="navbtn right" onclick="car(1)">></button>
    </div>
    <div class="modPrice"><button class="btn" id="btnCall">–¶—ñ–Ω–∞</button></div>
    <div class="modBody">
      <div class="blockTitle">–û–ü–ò–°–ê–ù–ù–Ø</div>
      <div id="modDesc" style="margin-bottom:12px;white-space:pre-wrap"></div>
      <div class="chips" id="chips"></div>
    </div>
  </div>
</dialog>

<!-- CHOOSER (–∑–≤–∏—á–∞–π–Ω–µ / HOT) -->
<div id="chooser">
  <div class="chooseBox">
    <button class="chooseBtn green" id="chooseNormal">–ó–≤–∏—á–∞–π–Ω–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
    <button class="chooseBtn red" id="chooseHot">HOT –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
  </div>
</div>

<!-- ADD FORM -->
<div id="addForm">
  <div class="formBox">
    <div class="formTop">
      <div class="badgeSmall">–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</div>
      <div id="hotBadge" class="badgeSmall" style="background:#e94251;display:none">HOT</div>
    </div>
    <div class="imagePh" id="imgPh">–ö–ê–†–¢–ò–ù–ö–ê –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</div>
    <input class="inp" id="f_title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
    <div class="inprow">
      <input class="inp" id="f_price" placeholder="–¶—ñ–Ω–∞, –≥—Ä–Ω">
      <input class="inp" id="f_city" placeholder="–ú—ñ—Å—Ç–æ">
    </div>
    <div class="inprow">
      <input class="inp" id="f_cat" placeholder="–ö–∞—Ç–µ–≥–æ—Ä—ñ—è">
      <input class="inp" id="f_phone" value="+380" placeholder="+380">
    </div>
    <textarea class="inp" id="f_desc" placeholder="–û–ø–∏—Å" rows="4" style="height:110px"></textarea>
    <input type="file" id="f_imgs" accept="image/*" multiple hidden>
    <button class="btn btnPub" id="btnPublish">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
<script>
// ===== CONFIG =====
const SERVER = localStorage.getItem('kolo_server_url') || 'https://alter-ordering-finish-dept.trycloudflare.com';

// ===== Splash 5s =====
setTimeout(()=>{ document.getElementById('splash').style.display='none' }, 5000);

// ===== STATE =====
const $ = s => document.querySelector(s);
const socket = io(SERVER, {transports:['websocket']});
const ME = localStorage.getItem('kolo_uid') || (localStorage.setItem('kolo_uid', 'u_'+Math.random().toString(36).slice(2)), localStorage.getItem('kolo_uid'));
let ALL = {hot:[], normal:[]}, page = 1;

// ===== SOCKET EVENTS =====
socket.on('connect', ()=> socket.emit('hello',{uid:ME}));
socket.on('visitors', n => $('#visitors').textContent = n+' –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤');
socket.on('banner', b => { if(b && b.enabled){ $('#bannerImg').src=b.image; $('#bannerLink').href=b.link||'#'; }});
socket.on('listings', data => { ALL=data; page=1; draw(); });
socket.on('payresult', m => { if(m.uid===ME){ alert('–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!'); hideAdd(); }});
socket.on('chat', _=>{}); // unused here

// ===== RENDER =====
function draw(){
  const h = ALL.hot.map(mkCard).join('');
  const nAll = ALL.normal;
  const nSlice = nAll.slice(0, page*6);
  $('#hotGrid').innerHTML = h;
  $('#listGrid').innerHTML = nSlice.map(mkCard).join('');
  $('#btnMore').style.display = nAll.length>nSlice.length ? 'inline-block':'none';
}
function mkCard(ad){
  return `<div class="card" onclick="openDetail('${ad.id}')">
    ${ad.type==='hot'?'<div class="badge-hot">HOT</div>':''}
    <div class="title">–ó–ê–ì–û–õ–û–í–û–ö</div>
    <div class="ph">–ö–ê–†–¢–ò–ù–ö–ê –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</div>
    <button class="priceBtn">–¶—ñ–Ω–∞</button>
  </div>`;
}

// ===== DETAIL =====
let CAR = [], idx = 0, CUR=null;
window.openDetail = (id)=>{
  CUR = [...ALL.hot,...ALL.normal].find(a=>a.id===id); if(!CUR) return;
  $('#modTitle').textContent = CUR.title.toUpperCase();
  $('#modViews').textContent = 'üëÅÔ∏è '+(CUR.views||0);
  $('#modLikes').textContent = '‚ù§ '+(CUR.likes||0);
  $('#modDesc').textContent = CUR.desc || '';
  const chips = [
    '–∫–∞—Ç–µ–≥–æ—Ä—ñ—è: '+(CUR.cat||'-'),
    '–°—Ç–∞–Ω: '+(CUR.state||'–≤–∂–∏–≤–∞–Ω–∏–π'),
    '–¥–∞—Ç–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó: '+(new Date().toLocaleDateString('uk-UA')),
    '–ù–æ–º–µ—Ä: '+(CUR.phone||'+380'),
    '–º—ñ—Å—Ç–æ: '+(CUR.city||'-'),
    '–æ–±–ª–∞—Å—Ç—å: '+(CUR.region||'-'),
  ].map(t=>`<div class="chip">${t}</div>`).join('');
  $('#chips').innerHTML = chips;
  $('#btnCall').onclick = ()=> window.location.href = 'tel:'+(CUR.phone||'');
  CAR = CUR.images && CUR.images.length ? CUR.images : ['https://picsum.photos/seed/1/1000/700'];
  idx = 0; renderCar();
  document.getElementById('dlgDetail').showModal();
  fetch(SERVER+`/api/view/${CUR.id}`,{method:'POST'});
};
function renderCar(){
  $('#carImgs').innerHTML = `<img src="${CAR[idx]}" alt="">`;
}
window.car = (d)=>{ idx=(idx+d+CAR.length)%CAR.length; renderCar(); };

// ===== ADD FLOW =====
let ADD_TYPE = 'normal';
function showChooser(){ $('#chooser').style.display='flex'; }
function hideChooser(){ $('#chooser').style.display='none'; }
function showAdd(){ $('#addForm').style.display='flex'; $('#hotBadge').style.display = ADD_TYPE==='hot' ? 'inline-block':'none'; }
function hideAdd(){ $('#addForm').style.display='none'; }

$('#btnPlus').onclick = showChooser;
$('#chooseNormal').onclick = ()=>{ ADD_TYPE='normal'; hideChooser(); showAdd(); };
$('#chooseHot').onclick = ()=>{ ADD_TYPE='hot'; hideChooser(); showAdd(); };

$('#imgPh').onclick = ()=> $('#f_imgs').click();
$('#f_imgs').onchange = ()=>{ const f=$('#f_imgs').files[0]; if(f){ $('#imgPh').textContent = f.name; } };

$('#btnPublish').onclick = async ()=>{
  const fd = new FormData();
  fd.append('type', ADD_TYPE);
  fd.append('title', ($('#f_title').value||'–û–≥–æ–ª–æ—à–µ–Ω–Ω—è'));
  fd.append('price', ($('#f_price').value||0));
  fd.append('cat', ($('#f_cat').value||''));
  fd.append('city', ($('#f_city').value||''));
  fd.append('desc', ($('#f_desc').value||''));
  fd.append('phone', ($('#f_phone').value||'+380'));
  const files = $('#f_imgs').files; for(const f of files) fd.append('images', f);
  const r = await fetch(SERVER+'/pay/start',{method:'POST',body:fd,headers:{'X-KOLO-UID':ME}});
  const j = await r.json();
  if(j.status==='ok'){ /* —Å–µ—Ä–≤–µ—Ä —Å–∞–º —Ä–æ–∑—ñ—à–ª–µ payresult */ }
};

// ===== MORE =====
$('#btnMore').onclick = ()=>{ page++; draw(); };

// ===== INIT =====
fetch(SERVER+'/api/list').then(r=>r.json()).then(j=>{ ALL=j.data; draw(); });
</script>
</body>
</html>
